# Longitudinal ESBL-E carriage in Malawian adults in health and disease

\chaptermark{ESBL-E carriage}

```{r ch4-setup, include = F}

library(plyr)
library(tidyverse)
library(knitr)
library(kableExtra)
library(grid)
library(ggpubr)
library(pheatmap)
library(RColorBrewer)
library(scales)
library(lubridate)
library(survival)
library(ggsci)
library(survminer)
library(glue)
library(broom)


wd <- "chapter_5/"
output = "latex"
T <- TRUE

specify_decimal <- function(x, k) trimws(format(round(x, k), nsmall=k))


# generate figures
#source("chapter_5/make_consort_diagram.R")
#source("final_cleaning_scripts/generate_visits_df.R")
source("final_cleaning_scripts/load_and_clean_followup_and_enroll_labelled.R")
source("other_scripts/summary_table_functions.R")
source("final_cleaning_scripts/make_composite_hivstatus_variable.R")
source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_bloods.R")
#source("final_cleaning_scripts/load_and_clean_aetiol.R")
#source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_upto72.R")
source("final_cleaning_scripts/load_and_clean_post72.R")
source("final_cleaning_scripts/load_and_clean_hosp_oc.R")
#source("final_cleaning_scripts/load_and_clean_time_to_ab.R")
#source("final_cleaning_scripts/load_and_clean_fluid_hr1_to_6.R")


# lims




#panel data helper functions
source("other_scripts/panel_data_helpers/expand_covariates.R")
source("other_scripts/panel_data_helpers/sort_out_tb_rx_on_discharge.R")
source("other_scripts/panel_data_helpers/shuffle_a_in_b2.R")
source("other_scripts/panel_data_helpers/strip_post_dropout_rows.R")
source("other_scripts/panel_data_helpers/extract_covariate_exposure.R")
source("other_scripts/panel_data_helpers/collapse_covariates.R")
source("other_scripts/panel_data_helpers/ditch_everything_after_first_1.R")
source("other_scripts/panel_data_helpers/mstate_helper_functions.R")

names(enroll)[names(enroll) == "data_date"] <- "enroll_date"
followup <- merge(followup, select(enroll, pid, arm, enroll_date), all.x = T)
followup$t <- followup$data_date - followup$enroll_date

# and load lims
source("final_cleaning_scripts/load_and_clean_lims.R")

```

## Chapter Overview

## Introduction and chapter aims

## Methods

## Results

### Study population

In total, 425 participants were recuited to the  study between 19th February 2017 and 2nd October 2018; 225 participants with sepsis (arm 1), 100 inpatients without antimicrobial exposure at baseline (arm 2) and 100 community members (arm 3). Flow of participants through the study is shown in Figure \@ref(fig:ESBL-consort-diag). It was often challenging to collect stool samples from participants but 87% (1416/1631) eligible patient-visits resulted in the collection of a stool sample. Drop out from the study and failure to collect stool samples were similar in arm 1 and 2 and with no apparent systematic bias, but both drop out and missing samples were less frequent in arm 3 (Figure \@ref(fig:ESBL-prop-samples)A). There was siginifcant variation in the timing of stool sample collecion, with a distribution around the ostensible collation day (Figure \@ref(fig:ESBL-prop-samples)B).

The baseline characetristics of the enrolled participants are shown in Table \@ref(tab:dassim-2-demog). There were some important differences between the arms of the study: despite matching on age and sex, antimicrobial-unexposed participants were older. They were also less likely to be HIV-infected than participants with sepsis (13% [12/89] of those with known HIV status were HIV-infected versus 67% [143/213] with sepsis), and less likely to have been treated for TB. Sepsis participants were more likely to have recieved antimicroials or been hospitalised in the previous 4 weeks. In the community arm of the study, there were a high proportion of participants (60% [60/100]) with an unknown HIV status, and there were some differences in toilet facilities, water sources, cooking fuel and presence of animals at home across the three groups. 

```{r ESBL-prop-samples, echo = F, warning = F, message = F,fig.scap="Missing samples and variation in sample collection time", out.extra='', fig.cap = "A: Missing stool samples stratified by arm and visit. Bar height at a given visit represents the number of eligible participants, coloured by successful sample collection (blue) or failure to collect a sample (red). B: Distribution of actual day of sample collection for ostensible day 7, 28, 90 and 180 samples showing considerable variation.",  fig.height = 4, fig.width=8, fig.align = 'center'}

sampls <- read.csv("chapter_5/ESBL_carriage_recruitment.csv", stringsAsFactors = F)

sampls$a_missed <- sampls$eligible - sampls$collected

sampls %>% select(-eligible) %>% pivot_longer(-c(arm, visit)) %>% ggplot(aes(as.factor(visit), value, fill = name)) + geom_col() + facet_wrap(~arm, scales = 'free') + xlab("Visit day") + ylab("n") + theme_bw() + theme(legend.title = element_blank(), legend.position = "top") + scale_fill_manual(labels = c("No sample", "Sample collected"), values = hue_pal()(2)) -> p1


visit_names <- c(
  `1` = "Day 7",
  `2` = "Day 28",
  `3` = "Day 90",
  `4` = "Day 180"
)

followup %>% filter(arm != 4, foutcome == 1) %>% ggplot(aes(as.numeric(t), group = as.factor(d2visit))) + geom_histogram(bins = 60) + facet_wrap(~ d2visit, scale = 'free_y', ncol = 1, strip.position = "right", labeller = as_labeller(visit_names)) + xlim(c(0,300)) + theme_bw() + xlab("Time post enrollment (days)") + ylab("n") -> p2

ggarrange(ggarrange(NULL,p1,NULL, ncol = 1, nrow = 3, heights = c(0.15,1,0.15), labels = c(NA,"A",NA)),p2, ncol = 2, nrow = 1, labels = c(NA,"B"))

```


```{r ESBL-consort-diag, echo = F, fig.scap="ESBL carriage study recruitment and follow up.", out.extra='', fig.cap = "Study recruitment and follow up. At each time point \\textit{eligible participants} refers to participants who are known to be alive and have not withdrawn from the study by that time point, and \\textit{samples collected} refers to patients from whom a stool sample was sucessfully collected for that visit.",  out.height = '100%', fig.align = 'center'}

knitr::include_graphics(paste0(wd, "/figures/ESBLstudy_flow_diagram.odf"))

```


\renewcommand{\arraystretch}{0.8}

```{r dassim-2-demog, echo = F, warning=F, message = F}

enroll <- filter(enroll, arm != 4)
enroll$art.time <- as.numeric((enroll$enroll_date - enroll$hivartstart) /(365.25/12))
enroll$hivart[enroll$hivart != "5A" & !is.na(enroll$hivart)] <- "ART regimen: other"
enroll$animalskept[enroll$animalskept == "Other"] <- "Elsewhere"
enroll$keep.other[enroll$keep.cattle == "Yes" | enroll$keep.sheep == "Yes" | enroll$keep.mules == "Yes"] <- "Yes"
enroll.sum <- dplyr::select(enroll, arm,calc_age, ptsex, hivstatus,recieved_prehosp_ab,pmhxrechospital,tbstatus, tbongoing, hivonart, hivart, art.time, hivcpt, 
                  tobaccoyn, alcoholyn,  highestedu,
                 job, housholdadultsno, householdchildno, toilet , watersource, watertreated,
                 electricityyn, fuel, 
                 keepanim, keep.poultry,  keep.goats,
                 keep.dogs, keep.cattle,  keep.other)

enroll.sum$arm <- as.character(enroll.sum$arm)

enroll.sum %>% select_if(is.character) %>% 
  pivot_longer(-arm) %>% 
  group_by(name, arm, value) %>% 
  tally() %>% 
  pivot_wider(names_from = arm, values_from = n, , values_fill = list(n = 0) ) %>% filter(!is.na(value)) %>% group_by(name) %>% 
  mutate(sum1 = sum(`1`), 
         sum2 = sum(`2`), 
         sum3 = sum(`3`),
         str1 = glue('{`1`}/{sum1} ({specify_decimal(`1`*100/sum1, 0)}%)'),
         str2 = glue('{`2`}/{sum2} ({specify_decimal(`2`*100/sum2, 0)}%)'),
         str3 = glue('{`3`}/{sum3} ({specify_decimal(`3`*100/sum3, 0)}%)')
  ) -> t1

apply(t1[3:8], 1, function(x) fisher.test(matrix(x, ncol = 2))$p.value) -> t1$p
t1$tot <- t1$`1` + t1$`2` + t1$`3`
t1$n <- t1$sum1 + t1$sum2 + t1$sum3
t1$Total <- t1 %>% glue_data('{tot}/{n} ({specify_decimal(tot*100/n, 0)}%)')
t1$totalprop <- t1$tot /t1$n
t1 <- filter(t1, value != "No")

enroll.sum$arm <- as.numeric(enroll.sum$arm)

enroll.sum %>% select_if(is.numeric) %>% 
  pivot_longer(-arm) %>% 
  group_by(name) %>% mutate(p = kruskal.test(value ~ arm)$p.value,
                            median.t = median(value, na.rm = T),
                                    lqr.t = quantile(value, 0.25, na.rm = T),
                                    uqr.t = quantile(value, 0.75, na.rm = T),
                                    Total = glue('{specify_decimal(median.t,1)} ({specify_decimal(lqr.t,1)}-{specify_decimal(uqr.t,1)})')) %>%
  group_by(name, arm) %>% summarise(median = median(value, na.rm = T),
                                    lqr = quantile(value, 0.25, na.rm = T),
                                    uqr = quantile(value, 0.75, na.rm = T),
                                    strz = glue('{specify_decimal(median,1)} ({specify_decimal(lqr,1)}-{specify_decimal(uqr,1)})'),
                                    p = unique(p),
                                    Total = unique(Total)) %>% select(name, arm, strz, p, Total) -> t1.1 

dcast(t1.1, name+ p + Total ~ arm, value.var = "strz") -> t1.1
names(t1.1)[4:6] <- c("str1", "str2", "str3")
  bind_rows(dplyr::select(t1, name, value,str1, str2, str3, p, Total, totalprop), t1.1) -> t1
    rm(t1.1)  
    
    t1$value[grepl("keep.", t1$name) & t1$name != "keepanim"] <- t1$name[grepl("keep.", t1$name)& t1$name != "keepanim"]
     t1$name[grepl("keep.", t1$name)& t1$name != "keepanim"] <- "which.anim"
    ord <- c("calc_age", "ptsex", 
             "hivstatus", "tbstatus", "tbongoing",
             "hivonart", "art.time", "hivart", "hivcpt",
             "recieved_prehosp_ab", "pmhxrechospital",
             "tobaccoyn","alcoholyn", 
             "highestedu", "job", 
             "toilet",
             "watersource",
             "watertreated",
             "householdchildno",
             "housholdadultsno",
             "electricityyn",
             "fuel",
             "keepanim",
             "which.anim"
             )
        
       t1$name <- factor(t1$name, levels = ord)  
       t1[order(t1$name, -t1$totalprop),] -> t1
       
# tweaky tweaky
       
       
    t1$name <- as.character(t1$name)


t1$value[t1$name == "householdchildno"] <- "Children"
t1$value[t1$name == "housholdadultsno"] <- "Adults"
t1$name[t1$name == "householdchildno"] <- "No. household members"
t1$name[t1$name == "housholdadultsno"] <- "No. household members"
t1$value[t1$name == "calc_age"] <- "Age (yr)"
t1$value[t1$name == "art.time"] <- "Months on ART"

t1 <- subset(t1, value != "Female")
t1$value[t1$name == "ptsex"] <- "Male sex"
t1$name[t1$name %in% c("calc_age", "ptsex")] <- "Demographics"

# art variables
t1$value[t1$value %in% c("Reactive", "Non reactive", "Unknown")] <- 
  paste0("HIV ", str_to_title(t1$value[t1$value %in% c("Reactive", "Non reactive", "Unknown")]))

t1$value[t1$name == "hivonart"] <- "Current ART*"

t1$value[t1$name == "hivcpt"] <- "Current CPT\\textsuperscript{\\dag}"
t1$value[t1$value == "5A"] <- "ART regimen: EFV/3TC/TDF"
t1 <- subset(t1, value != "ART regimen: other")

#t1$levels[t1$variable == "art.time"] <- "Months on ART"
t1$name[t1$name == "hivstatus"] <- "HIV/TB status"
t1$name[grepl("art", t1$name)] <- "ART status*"

t1$name[grepl("cpt", t1$name)] <- "ART status"
# tb variables
t1$value[t1$name == "tbstatus"] <- "Ever treated for TB"
t1$value[t1$name == "tbongoing"] <- "Of those, current TB treatment"
t1$name[grepl("tb", t1$name)] <- "HIV/TB status"

t1$value[t1$name == "recieved_prehosp_ab"] <- "Antibiotics"
t1$value[t1$name == "pmhxrechospital"] <- "Hospitalised"

t1$name[t1$name == "recieved_prehosp_ab"] <- "Healthcare exposure last 4wk"
t1$name[t1$name == "pmhxrechospital"] <- "Healthcare exposure last 4wk"




# tobacco use
t1$value[grepl("tobacco", t1$name)] <- paste0(t1$value[grepl("tobacco", t1$name)], " tobacco" )
t1$name[grepl("tobacco", t1$name)] <- "Tobacco/alcohol use"

# alcohol use
t1$value[t1$name == "alcoholyn"] <- "Current alcohol"
t1$name[grepl("alcohol", t1$name)] <- "Tobacco/alcohol use"

# education
t1$name[grepl("highestedu", t1$name)] <- "Education"

# employment 
t1$name[grepl("job", t1$name)] <- "Employment"

# toilet

t1$name[grepl("toilet", t1$name)] <- "Toilet facilities"

# toilet
t1$value[t1$name == "watertreated"] <- "Treat water with chlorine"

t1$name[grepl("water", t1$name)] <- "Main water source"

# electricity
t1$value[t1$name == "electricityyn"] <- "Electricity available in house"
t1$name[grepl("electric", t1$name)] <- "Electricty"

t1$name[grepl("fuel", t1$name)] <- "Main cooking fuel"

# animals

#t1$levels[grepl("keep", t1$variable)] <- t1$variable[grepl("keep", t1$variable)]

sub("keep.", "",t1$value) -> t1$value
t1$name[t1$name == "keepanim" | t1$name == "which.anim"] <- "Animals at home?"
t1$value[t1$name == "Animals at home?"] <- str_to_title(t1$value[t1$name == "Animals at home?"])
t1$value[t1$name == "Animals at home?" & t1$value == "Yes"] <- "Any animal"

str_to_title(t1$levels[grepl("keep", t1$variable)] ) -> t1$levels[grepl("keep", t1$variable)]
#t1$levels[t1$levels == "Nim"] <- "Any animal"
names(t1)[1] <- "variable"
kstring <- make_kable_rowgroup_string(t1)


sub("%", "\\\\%", t1$str1) -> t1$str1
sub("%", "\\\\%", t1$str2) -> t1$str2
sub("%", "\\\\%", t1$str3) -> t1$str3
sub("%", "\\\\%", t1$Total) -> t1$Total
boldrows <- t1$p < 0.05

t1$p <- specify_decimal(t1$p, 3)
t1$p[t1$p == "0.000"] <- "<0.001"

t1 <- ungroup(t1)
boldrows <- which(boldrows %in% TRUE)

kable(select(t1,value, str1, str2, str3, p,Total), "latex", booktabs =T, 
      row.names = F, longtable = T, escape = F, col.names = c("Variable","Sepsis", "Inpatient", "Community", "p", "Total"), 
      caption = "Participant Characteristics" ) %>%  kable_styling(font_size = 9, full_width = F,latex_options = c("scale_down")) %>%
  pack_rows(index = kstring) %>%
  row_spec(boldrows, bold = T) %>%
  footnote(general = "ART = Antiretroviral therapy, CPT = Co-trimoxazole preventative therapy, EFV: Efavirenz, 3TC: Lamivudine, TDF: Tenofovir. Numeric values are median (IQR)) unless otherwise stated. P-values are to assess for differened across the three groups: Fisher's exact test across the groups for categorical variable, and Kruskal-Wallace test for continuous variables.", symbol = c("ART status includes HIV reactive only as denominator", "Missing CPT data for two participants. ") ,threeparttable = T, fixed_small_size = T) %>% landscape()




                                               
```

### Exposures druring the study period

Exposures to antimicrobials and hospitalisation of the cohort are shown in Figure \@ref(fig:ESBL-study-exp) and Table \@ref(tab:exposure-tab). Antimicrobial-unexposed inpatients (Arm 2 participants) had a shorter length of hospital stay than participants with sepsis (Arm 1 participants): median (IQR) 2 (2-7) versus 5 (2-10) days, p = 0.002 by Kruskal-Wallace test. Five of the 100 Arm 2 participants were taking co-trimoxazole preventative therapy (CPT) at baseline, 18 received further courses of antimicrobials during the study period, and two were started on TB therapy. Some participants received combinations of these therapies, so in total 23% (23/100) Arm 2 participants received an antibacterial during the study period, mostly within 30 days following enrollment (Figure \@ref(fig:ESBL-study-exp))), and most commonly ceftriaxone (Table \@ref(tab:exposure-tab)).

Both antimicrobial exposure and hospitalisation were unusal in the community cohort; 7% (7/100) community (Arm 3) participants were taking CPT and one received a 5-day course of amoxicillin meaning that 8% (8/100) Arm 3 participants received an antibacterial during the study period. In addition one Arm 3 participant was hospitalised for 1 day in the study period. No Arm 3 participant received any TB therapy, and no Arm 2 or 3 participants received any antimalarial or antifungal therapy during the study period.

The most commonly receievd antibacterial by Arm 1 participants - those with sepsis - (apart from co-trimoxazole and TB therapy) was ceftrixaxone by some distance with 998 participant-days of expsoure in 189 participants during the study period, and a median 5 (IQR 3-7) day course. Ciprofloxacin and amoxicillin were also commonly received, with 61 participants receiving 398 participant-days of exposure to ciprofloxacin with a median 7 (IQR 5-7) day course, and 39 participants receiving 235 participant-days of exposure to amoxicillin with a median 5 (IQR 5-7) day course.  Because of the chronic nature of the therapy, the greatest exposure (in terms of participant-days) were to co-trimoxazole and TB therapy, by an order of magnitude (Table \@ref(tab:exposure-tab)).

```{r ESBL-study-exp, echo = F, warning = F, message = F,fig.scap="Hospital and antibacterial exposure of participants", out.extra='', fig.cap = "Hospital and antibacterial exposure of participants expressed as (A) proportion of Arm 1 and Arm 2 participant who are hospitalised and/or exposed to the most commonly received antibacterials on any given day and (B) cumulative proportion of participants who have been exposed to any antibacterial over the study period.",  fig.height = 6, fig.width=8, fig.align = 'center'}

read.csv("data/longit_covariate_data.csv") -> df.covs

df.covs <- merge(df.covs, select(enroll, pid, arm))


df.covs %>% group_by(pid) %>% do(uncompress_covariates(.)) -> outlong
df.covs.cpt <- merge(df.covs, select(enroll, pid, hivcpt), all.x = T)

df.covs.cpt$hivcpt <- as.numeric(df.covs.cpt$hivcpt == "Yes")
df.covs.cpt$cotri[df.covs.cpt$hivcpt == 1] <- 1
df.covs.cpt <- select(df.covs.cpt, -hivcpt)

df.covs.cpt %>% group_by(pid) %>% do(uncompress_covariates(.)) -> outlong.cpt

abs.lookup <- c(
  "Amoxicillin",
  "Gentamicin",
  "Azithromycin",
  "TB therapy",
  "Penicillin",
  "Fluconazole",
  "Ceftriaxone",
  "Amphotericin",
  "Quinine",
  "Chloramphenicol",
  "LA",
  "Ciprofloxacin",
  "Co-amoxiclav",
  "Artesunate",
  "Cotrimoxazole",
  "Clindamycin",
  "Doxycycline",
  "Erythromycin",
  "Aciclovir",
  "Flucloxacillin",
  "Metronidazole",
  "Streptomycin"
)

names(abs.lookup) <- outlong %>% ungroup() %>% select(-c(pid, assess_type, died, hosp, arm)) %>% names 

abs.lookup <- c(abs.lookup, "Hospitalised", "Other AB")
names(abs.lookup) <- c(names(abs.lookup)[1:(length(abs.lookup) - 2)], "hosp", "other")

#other.antibac <- c("genta", "azithro","benzy", "coamo","clinda", "doxy","erythro", "fluclox", "metro", "strepto")

#apply(outlong.cpt[other.antibac],1,sum) -> outlong.cpt$other


arm_names <- c(
  `1` = "Arm 1: Sepsis",
  `2` = "Arm 2: Inpatient",
  `3` = "Arm 3: Community"
)


outlong.cpt %>%
  ungroup() %>% 
  select(-c(pid, died)) %>% filter(arm != 3) %>%
  pivot_longer(-c(assess_type, arm)) %>%
  group_by(arm, assess_type, name)%>%
  summarise(n = n(), x = sum(value == 1), prop = x/n)  %>% 
  filter(name %in% c("cefo","amoxy","hosp", "cipro", "cotri", "tb")) %>%
  mutate(name = recode(name, !!!abs.lookup)) %>%
  ggplot(aes(assess_type,prop, group = name, color = name, linetype = name)) +
  geom_line(alpha = 0.8, size = 0.75) + 
  facet_wrap(~ arm, ncol = 1, , labeller = as_labeller(arm_names)) + 
  theme_bw() + 
  scale_x_continuous(breaks = c(0,5,10,15,20,25,30), limits = c(0,30)) +
  scale_linetype_manual(values = c("Amoxicillin" =  "solid",
                                   "Ceftriaxone" = "solid",
                                   "Ciprofloxacin" = "solid",
                                   "Cotrimoxazole" = "solid",
                                   "Hospitalised" = "dashed",
                                   "TB therapy" = "dotted"),
                        breaks = c("Hospitalised",
                                   "TB therapy" ,
                                   "Ceftriaxone",
                                   "Cotrimoxazole", 
                                   "Ciprofloxacin", 
                                   "Amoxicillin")) + 
  scale_colour_manual(values = c("Amoxicillin" =  pal_lancet()(4)[1],
                                 "Ceftriaxone" = pal_lancet()(4)[2],
                                 "Ciprofloxacin" = pal_lancet()(4)[3],
                                 "Cotrimoxazole" = pal_lancet()(4)[4],
                                 "Hospitalised" = "black",
                                 "TB therapy" = "grey20"),
                      breaks = c("Hospitalised",
                                 "TB therapy" ,
                                 "Ceftriaxone",
                                 "Cotrimoxazole", 
                                 "Ciprofloxacin", 
                                 "Amoxicillin")) +
  theme(legend.title = element_blank()) + 
  xlab("Day post enrollment") + 
  ylab("Proportion") -> p1

outlong %>% ungroup() %>% select(-c(pid, assess_type, died, hosp,tb, cotri)) %>% 
  group_by(arm) %>% 
  summarise_all(sum) %>%
  pivot_longer(-arm) %>% group_by(name) %>% mutate(tots = sum(value)) %>% ungroup() %>%
  mutate(name = recode(name, !!!abs.lookup)) %>%
  ggplot(aes((fct_reorder(name, tots)), value)) + 
  geom_col() + 
  facet_wrap(~arm, scales = "free_x", labeller = as_labeller(arm_names)) +
  coord_flip() +
  theme_bw()  + 
  theme(panel.spacing = unit(1,"lines")) +
  ylab("Participant-days of exposure") +
  xlab(element_blank()) -> p2 

# cumulative fraction with no ab and no hosp
# start with hosp

abs.lookup[!names(abs.lookup) %in% c("tb","fluco", "ampho", "quin", "coart", "arte", "acicl", "flu", "hosp", "other")] -> anti_bacterials


apply(df.covs.cpt[c(names(anti_bacterials), "tb")], 1, sum) -> df.covs.cpt$any_antibacterial

df.covs.cpt$any_antibacterial[df.covs.cpt$any_antibacterial > 1] <- 1

time.to.ab.cot <- df.covs.cpt %>% group_by(pid) %>% do(ditch_everything_after_first_1(.,28))

time.to.ab.cot$assess_type[time.to.ab.cot$any_antibacterial == 0] <- 1000
time.to.ab.cot$any_antibacterial[time.to.ab.cot$any_antibacterial == 0] <- 1
#time.to.ab.cot <- filter(time.to.ab.cot, any_antibacterial > 0, arm == 3)

time.to.ab.cot %>%
  filter(any_antibacterial == 1) %>% group_by(arm) %>% mutate(n.arm = n()) %>%
  group_by(arm, assess_type) %>%
  summarise(n.tot = unique(n.arm),
            n = length(assess_type)) %>% 
  group_by(arm) %>%
  mutate(cumsm = cumsum(n),
         cumsm.prop = cumsm/n.tot) %>% 
  ungroup() %>%
  mutate(arm = recode(arm, `1` = "Arm 1", `2` = "Arm 2", `3`= "Arm 3")) %>%
  ggplot(aes(assess_type, cumsm.prop, group = arm, color = arm)) +
  geom_step(size = 0.75)  +  theme_bw() +
  ylab("Proportion") +
  xlab("Days post enrollment") +
  theme(legend.title = element_blank()) + coord_cartesian( ylim = c(0,1),xlim  =c(0,180)) +
  scale_x_continuous(limits = NA, breaks = c(0,30,60,90,120, 150,180)) +
  scale_color_manual(values = pal_lancet()(3)[c(2,1,3)]) +
  scale_linetype_manual(values = c(1,2,3))-> p3

time.to.ab.cot <- df.covs.cpt %>% group_by(pid) %>% do(ditch_everything_after_first_1(.,28))


ggarrange(p1,
ggarrange(p3,NULL, widths = c(1,0.06)),
ncol = 1, nrow = 2, labels = c("A", "B"), heights  = c(2,1))


```

```{r exposure-tab, echo = F, warning = F, message = F}
outlong.cpt %>% ungroup() %>% 
  select(-c(assess_type, died)) %>% 
  pivot_longer(-c(pid, arm)) %>% 
  filter(value > 0) %>%
  group_by(pid, name,arm) %>% 
  summarise(pid.exp = sum(value)) %>% group_by(arm, name) %>%
  summarise(n.p = length(unique(pid)),
            exposure = sum(pid.exp),
            median.exp.len = median(pid.exp),
            lq.exp.len = quantile(pid.exp, 0.25),
            uq.exp.len = quantile(pid.exp, 0.75)) -> exposures
  
outlong.cpt %>% group_by(arm) %>%
  summarise(n.tot = length(unique(pid)),
            tot.exp = length(pid)) -> tots.exposures

exposures <- merge(tots.exposures, exposures)


exposures$exp.perc <- specify_decimal(exposures$exposure*100/exposures$tot.exp,0)
exposures$exp.perc[exposures$exp.perc == "0"] <- "<1"

exposures$exp.str <- as.character(exposures %>% glue_data('{exposure}')) #({exp.perc}%)'))
exposures$tr.len.str <- as.character(exposures %>% glue_data('{specify_decimal(median.exp.len, 0)} ({specify_decimal(lq.exp.len,0)}-{specify_decimal(uq.exp.len,0)})'))

exposures %>% select(name, arm,n.p, exp.str, tr.len.str) %>%
  pivot_wider(names_from = arm, 
              values_from = c(n.p, exp.str, tr.len.str),
              values_fill= list(n.p = 0, exp.str = "0", tr.len.str = "-")) -> exp.tab

#subset(exposures, arm == 1 & name != "hosp")
exp.tab$name <- factor(exp.tab$name, levels = c("hosp",
                                                subset(exposures, arm == 1 & name != "hosp")$name[order(subset(exposures, arm == 1 & name != "hosp")$exposure, decreasing = T)]))

exp.tab %>% mutate(name = recode(name, !!!abs.lookup)) -> exp.tab

exp.tab[order(exp.tab$name),] -> exp.tab
tots.exposures %>% pivot_wider(names_from = arm, values_from = c(n.tot, tot.exp)) -> tots.exposures
tots.exposures$name <- "Total At Risk"
names(tots.exposures)[1:6] <- names(exp.tab)[2:7]
tots.exposures[4:6] <- sapply(tots.exposures[4:6], as.character)
tots.exposures <- select(tots.exposures, names(exp.tab)[1:7] )
bind_rows(tots.exposures, exp.tab) -> exp.tab
exp.tab[is.na(exp.tab)] <- "-"

#exp.tab <- select(exp.tab, 
#                  n.p_1, exp.str_1, tr.len.str_1,
#                  n.p_2, exp.str_2, tr.len.str_2,
 #                 n.p_3, exp.str_3, tr.len.str_3)


kable(exp.tab, "latex", booktabs = TRUE,
      row.names = FALSE, escape = TRUE, col.names = c("Exposure", "Arm 1", "Arm 2", "Arm 3", "Arm 1", "Arm 2", "Arm 3", "Arm 1", "Arm 2", "Arm 3"),
      caption = "Antimicrobial and hospital exposure stratified by arm") %>% kable_styling(full_width = FALSE, latex_options = "scale_down") %>%
#  pack_rows("Total", 1,1) %>%
#  pack_rows("Hospitalisation", 2,2) %>%
 pack_rows("Exposures", 2,23) %>%
  add_header_above(c(" " = 1, "Number exposed" = 3, "Exposure (person-days)" = 3,
                     "Median (IQR) exposure length (days)" = 3)) %>% 
  footnote(general = "TB = tuberculosis, LA =lumefantrine artemether. Median exposure length includes only those exposed. Total at risk shows the total number of participants and participant-days of follow up included in the study." ,threeparttable = T, fixed_small_size = T)# %>% landscape()

```

\clearpage

### ESBL-E colonisation

ESBL-E colonisation prevalence as a function of time across the three arms of the study is shown in Table \@ref(tab:ESBL-carriage-tab) and Figure \@ref(fig:ESBL-carriage-plots). Baseline colonisation prevalence was high in all groups, and higher in hospitalised participants than community members: 49% (95% CI 42-56%) in Arm 1 participants, 41% (95% CI 32-52%) in Arm 2 and 28% (95% 20-38%) in Arm 3. Both hospitalised groups showed a rise in colonisation prevalence following admission, though this is much more marked in Arm 1 participants: by the day 7 visit 78% (95% CI 71-84%) of Arm 1 participants were colonised compared to 51% (38-64%) of Arm 2 participants. By the end of the study period the prevalence had fallen back to baseline levels in both groups.

In total, 723/1417 (51%) of samples grew at least one ESBL-E; 1032 organisms were grown from the 723 samples, with a median 1 (IQR [1-2]) ESBL-E per sample. The most commonly isolaed organism as identified by the API system was _E. coli_ (n = 686) followed by _Klebsiella pneumoniae_ (n = 245, Figure \@ref(fig:ESBL-spec-sens)). Antimicrobial sensitivity testing was carried out on the first 694/1032 (67%) organisms; meropenam and amikacin sensitivity was near universal (680/694 [98%] and 679/694 [98%] of isolates respectively), but cotrimoxazole sensitivity very unusual (19/694 [3%] of isolates), with intermediate proportions of gentamicin (327/694 [47%]) and ciprofloxacin (237/694 [34%]) sensitivity. The antimicrobial to which the greatest proprtion of isolates were sensitive was chloramphenicol (462/694 [67%] of isolates).

```{r ESBL-carriage-tab, echo =F, message = F, warning = T}

merge(
lims %>% group_by(visit, arm) %>% 
  summarise(n = n(),
            e = sum(ESBL == "Positive"),
            prop = e/n,
            ESBLpropstr = as.character(glue('{e} ({specify_decimal(prop*100, 0)}%)')),
            nstr = as.character(n())) %>%
  select(visit, nstr, arm, ESBLpropstr) %>%
  pivot_wider(names_from = arm,values_from = c(ESBLpropstr,nstr), values_fill =list(ESBLpropstr = "-", nstr = "-")),

lims_orgs %>% group_by(visit, arm) %>% 
  mutate(n.smpl = length(unique(lab_id)),
         organism = recode(organism, `Escherichia coli` = "esco", `Klebsiella pneumoniae` = "klpn", .default = "other")) %>%
  filter(!is.na(organism)) %>% group_by(visit, arm, organism) %>% 
  summarise(n.sampl = unique(n.smpl),
            n = length(organism),
            prop = n/n.sampl,
            ORGpropstr = as.character(glue('{n} ({specify_decimal(prop*100, 0)}%)'))) %>%
  select(visit, arm, organism, ORGpropstr) %>%
  pivot_wider(names_from = c(arm,organism), values_from = ORGpropstr, values_fill = list( ORGpropstr = "-"))
) -> ESBLtab

ESBLtab <- select(ESBLtab, visit, 
                  nstr_1, ESBLpropstr_1,#`1_esco`,`1_klpn`, `1_other`,
                  nstr_2, ESBLpropstr_2,#`2_esco`,`2_klpn`, `2_other`,
                  nstr_3, ESBLpropstr_3)#`3_esco`,`3_klpn`, `3_other`)

ESBLtab$visit <- c("Day 0", "Day 7", "Day 28","Day 90", "Day 180")

kable(ESBLtab, "latex", booktabs = TRUE,
      row.names = FALSE, escape = TRUE, col.names = c("Visit",rep(c("n", "Any ESBL"),3)),
      caption = "ESBL carriage stratified by arm and visit") %>% kable_styling(full_width = FALSE) %>%
#  pack_rows("Total", 1,1) %>%
#  pack_rows("Hospitalisation", 2,2) %>%
# pack_rows("Exposures", 2,23) %>%
  add_header_above(c(" " = 1, "Arm 1 (Sepsis)" = 2, "Arm 2 (Inpatient)" = 2,
                     "Arm 3 (Community)" = 2))# %>% 
 # footnote(general = "TB = tuberculosis, LA =lumefantrine artemether. Median exposure length includes only those exposed. Total at risk shows the total number of participants and participant-days of follow up included in the study." ,threeparttable = T, fixed_small_size = T) %>% landscape()

```

```{r ESBL-carriage-plots, echo = F, warning = F, message = F,fig.scap="ESBL colonisation prevalence as a function of time", out.extra='', fig.cap = "ESBL carriage prevalence as a function of time visualised in a number of different ways. In each case participants from Arm 2 are censored on first antimicrobial exposure and Arm 3 are censored on first antimicrobial exposure or hospitalisation. Top (A) prevalence at each visit plotted at ostensible visit time; however, the visits are in fact distributed in time themselves so the middle plot (B) is an attempt to show this by fitting a nonparametric smoothed LOESS regression line with a local linear regression. However the confidence intervals in this method are too narrow because they assume independence of the measurements, which are in fact clustered within patients. The bottom panel (C) is an estimate of the proportion of ESBL-colonised participants from the Aalen-Johansen estimate, which is a generalisation of the Kaplan-Meier curve. This takes into account the nonindependence of the measurements, but does not take into account the interval-censored nature of the data, and transitions to and from the ESBL colonised state are hence assumed to happen halfway between measurements. The best estimate of state occupancy to account for all these difficulties requires the fitting of a Markov model: see chapter xx.",  fig.height = 8, fig.width=6, out.height = '70%', fig.align = 'center'}


p.lci <- function(x,n) {
  return(binom.test(x,n)$conf.int[[1]])
}

p.uci <- function(x,n) {
  return(binom.test(x,n)$conf.int[[2]])
}



#ggplot(lims_dates, aes(assess_type, as.numeric(ESBL == "Positive"), group = arm)) + geom_point() + geom_smoo#th() + xlim(c(0, 200))

# first - plot at visit date

censor_list <- subset(time.to.ab.cot, any_antibacterial == 1 & arm != 1)

lims_dates_censored <- lims_dates

for (i in 1:nrow(censor_list)) {
  lims_dates_censored <- subset(lims_dates_censored, !(pid == censor_list$pid[i] & assess_type > censor_list$assess_type[i]))
}

lims_dates_censored %>% 
  group_by(arm, visit) %>%
  summarise(e = sum(ESBL == "Positive"),
            n = length(ESBL),
            prop = e/n,
            lci = p.lci(e,n),
            uci = p.uci(e,n) 
            ) %>% ungroup() %>% mutate(arm = as.factor(arm)) %>% 
  mutate(visit = recode(visit, `0` = 0, `1` = 7, `2` = 28, `3` = 90, `4` = 180),
         arm = recode(arm, `1` = "Arm 1", `2` = "Arm 2", `3` = "Arm 3")) %>%
  ggplot(aes(visit, prop, ymin = lci, ymax = uci, group = arm, fill = arm, color = arm)) +
  geom_line() + geom_ribbon(color = NA, alpha = 0.3) + theme_bw() +
  scale_color_manual(values = pal_lancet()(3)[c(2,1,3)]) + 
  scale_fill_manual(values = pal_lancet()(3)[c(2,1,3)]) +
  xlab("Day post enrollment") +
  ylab("Proportion ESBL") + coord_cartesian(ylim = c(0.2,0.9)) +
  theme(legend.title = element_blank()) -> p1.c

lims_dates_censored %>%
  mutate(arm = recode(arm, `1` = "Arm 1", `2` = "Arm 2", `3` = "Arm 3")) %>%
ggplot(aes(assess_type, as.numeric(ESBL == "Positive"),
           group = arm, 
           fill = as.factor(arm), 
           color = as.factor(arm ))) + 
  geom_smooth(size = 0.5) +
  coord_cartesian(xlim = c(0,180), ylim = c(0.2,0.9)) +
  theme_bw() +
  scale_color_manual(values = pal_lancet()(3)[c(2,1,3)]) + 
  scale_fill_manual(values = pal_lancet()(3)[c(2,1,3)]) +
  xlab("Day post enrollment") +
  ylab("Proportion ESBL") +
  theme(legend.title = element_blank()) -> p2.c



# both underestimate errors because assume independence of measurements
# fit a multistate model



#lims_dates %>% group_by(pid, visit, .drop = FALSE) %>% tally() %>% filter(n == 0)

#lims_dates_censored %>% unique %>% group_by(pid, visit) %>% tally() %>% filter(n > 1)

lims_dates_censored %>% filter(!pid %in% c("DAS1441S", 
                                  "DAS1497X",
                                  "DAS1519G")) %>%
  group_by(pid) %>% do(pointESBLmeas_tostartstop(.)) -> l.c

fit1.c <- survfit(Surv(time = tstart, time2 = tstop, event = ESBL, type = "mstate") ~ arm, data = l.c, id = pid, istate = init.state)

pull_state_occ_from_surv_obj(fit1) -> pstate.c

ggplot(pstate.c, aes(x = t, y = `p(ESBL.pos)`, colour = arm)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = `ll.ESBL.pos`, ymax = `ul.ESBL.pos`, fill = arm), colour = NA, alpha = 0.3) + 
  theme_bw() + 
  coord_cartesian(ylim = c(0.2,0.9), xlim = c(0,180))+
  labs(x = "Days post recruitment", y = "Proportion ESBL") -> p3.c

l.trans.halfway.c <- l.c %>% group_by(pid) %>% do(change_transition_times(., 0.5))
fit2.c <- survfit(Surv(time = tstart, time2 = tstop, event = ESBL, type = "mstate") ~ arm, data = l.trans.halfway.c, id = pid, istate = init.state)
pull_state_occ_from_surv_obj(fit2.c) -> pstate2.c


pstate2.c %>%
  mutate(arm = recode(arm, `1` = "Arm 1", `2` = "Arm 2", `3` = "Arm 3")) %>%
ggplot(aes(x = t, y = `p(ESBL.pos)`, colour = arm)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = `ll.ESBL.pos`, ymax = `ul.ESBL.pos`, fill = arm), colour = NA, alpha = 0.3) + 
  theme_bw() + 
  coord_cartesian(ylim = c(0.2,0.9), xlim = c(0,180)) +
  scale_color_manual(values = pal_lancet()(3)[c(2,1,3)]) + 
  scale_fill_manual(values = pal_lancet()(3)[c(2,1,3)]) +
  labs(x = "Days post recruitment", y = "Proportion ESBL") -> p4.c

ggarrange(p1.c,p2.c,p4.c, ncol = 1, nrow = 3, common.legend = TRUE, labels = c("A", "B", "C"))       

```


```{r ESBL-spec-sens, echo = F, warning = F, message = F,fig.scap="Species and antimicrobial sensitivities of cultured ESBL-E", out.extra='', fig.cap = "Species (A) and antimicrobial sensitivities (B) of cultured ESBL-E",  fig.height = 3, fig.width=6, fig.align = 'center'}

labz <-  c(expression(italic("Escherichia coli")),
           expression(italic("Klebsiella pneumoniae")),
           expression(italic("Enterobacter cloacae")),
           expression(italic("Klebsiella oxytoca")),
           expression(italic("Raoultella ornithinolytica")),
           expression(italic("Acinetobacter baumanii")),
           "Other"
)
      
                      

lims_orgs %>% 
  filter(!is.na(organism)) %>%
  mutate(organism = recode_factor(organism,
                           `Escherichia coli` = "Escherichia coli",
                           `Klebsiella pneumoniae` = "Klebsiella pneumoniae",
                           `Enterobacter cloacae` = "Enterobacter cloacae",
                           `Klebsiella oxytoca` = "Klebsiella oxytoca",
                           `Raoultella ornithinolytica` = "Raoultella ornithinolytica",
                           `Acinetobacter baumanii` = "Acinetobacter baumanii",
                           .default = "Other", .ordered = TRUE)) %>% 
  ggplot(aes(fct_rev(organism))) + 
  geom_bar() + coord_flip() + 
  scale_x_discrete(labels = rev(labz)) +
  xlab(element_blank()) + ylab("n") + theme_bw() + theme(axis.text = element_text(size = 8))-> p.org

lims_sens[3:8][lims_sens[3:8] == "Sensitive"] <- 0
lims_sens[3:8][lims_sens[3:8] == "Resistant" | lims_sens[3:8] == "Intermediate"] <- 1
lims_sens[3:8] <- sapply(lims_sens[3:8], as.numeric)
lims_sens$n_not_na <- apply(lims_sens[3:8], 1, sum)
lims_sens <- filter(lims_sens, n_not_na > 0 & !is.na(n_not_na))

lims_sens %>% 
  select(-c(sample_number, n_not_na)) %>%
  pivot_longer(-organism) %>% 
  filter(organism %in% c("Escherichia coli","Klebsiella pneumoniae")) %>% 
  mutate(value = as.character(value),
    value = recode_factor(value, 
                          `0` = "Sensitive", 
                          `1` = "Resistant/Intermediate", 
                          .ordered = TRUE)) %>%
  ggplot(aes(name, fill= value)) +
  geom_bar(position = "fill") + 
  coord_flip() + 
  facet_wrap(~ organism, ncol = 1) + 
  scale_fill_manual(values = hue_pal()(8)[c(3,1)]) +
  theme_bw() + 
  theme(legend.title = element_blank(),legend.position = "bottom", axis.text = element_text(size = 8)) + 
  xlab(element_blank()) +
  ylab("Propotion") -> psens

ggarrange(ggarrange(NULL,p.org, NULL, ncol = 1, nrow = 3, heights = c(0.4,1,0.7), labels = c(NA,"A",NA)),
                    psens, ncol = 2, nrow = 1, labels = c(NA, "B"))
```

### Associations of ESBL colonisation

I then used logistic regression to explore associations of ESBL-E colonisation at baseline Of the 420 participants with an available enrollment stool culture result, 42% (178/420) cultured at least one ESBL-E. Univariable and multivariable associations of colonisation at enrollment are shown in \@ref(tab:esbl-baseline-model). In univarible analysis HIV infection, ART and CPT are associated with ESBL-E colonisation, but this seems to be largely mediated by CPT as the HIV and CPT associations largely dissapear on multivariable modelling but the effect of CPT is still apparent (aOR 2.3 [95% CI 1.0 - 5.5]). Hospitalistion within the 4 weeks prior to admission was strongly associated with ESBL-E colonisation on multivariable modelling, though with wide confidence intervals (aOR 5.9 [95% CI 1.8-27.0]), perhaps expected as it is a rare baseline exposure. Antimicrobial exposure was not, but with confidence intervals that contained a clinially relevant effect size (aOR 1.3 [95% 0.7 - 2.6]). ESBL-E colonisation was more likely with more adults in the household (aOR 1.2 [95% CI 1.0-1.4] per exta adult) , with use of an unprotected water source (aOR 3.0 [95% CI 1.1 - 8.8]) and in the rainy season (aOR 2.2 [95% CI 1.4-3.4]); a constellation of variables that are consistent with a significant role of community faecal-oral transmission in the spread of ESBL-E. 

To explore associations of acquisition of ESBL-E by the day 28 visit, I analysed only those participants who had no detectiable ESBL-E at basline, and an available follow up samples at 28 days +/- 14 days. These numbered 150 participants: 64 Arm 1, 37 Arm 2 and 49 Arm 3 participants, and 49% (73/77) of them had a detectable ESBL-E at day 28. Bivariable associations of ESBL-E aquistion with animicrobial and hospital exposures are shown in Figure \@ref(fig:esbl-aq-mod)A, stratified by the length of exposure; all antibacterials (including TB therapy) showed an association with ESBL-E acquisition, with a suggestion of a dose-response effect, but confidence intervals were large in many cases. Antimalarials did not show this effect though here undcertainty in the estimates precludes drawing any firm conclusions, as it does for antifungals. These relationships are very likely confounded, so shold be regarded with extreme caution; however, due to a small dataset size and collinearity, logistic regression modelling of ESBL-E acquisition (Figure \@ref(fig:esbl-aq-mod)B) produces such uncertain parameter estimates that no conclusions can be drawn. A better modelling strategy using continuous time Markov models was used to understand the drivers of ESBL-E carriage; this analysis is presented in Chapter xx.

```{r esbl-baseline-model, echo = FALSE, warning = FALSE, message = FALSE}

merge(enroll, subset(lims, visit == 0)) -> bl.esbl
#bl.esbl <- merge(bl.esbl, select(bloods, pid, CD4_Absolute), all.x = T )
bl.esbl %>% select(d2arm, calc_age, ptsex, hivstatus, hivonart, hivcpt, tbongoing,
                   recieved_prehosp_ab,pmhxrechospital,
                   watersource, watertreated, toilet,
                   housholdadultsno, householdchildno,
                   keepanim, 
                   ESBL, enroll_date, ) -> bl.esbl


bl.esbl$d2arm[is.na(bl.esbl$d2arm)] <- "Arm 3 (Community)"

bl.esbl$watersource <- recode(bl.esbl$watersource,
                              `Unprotected well/spring` = "unprotected",
                              `Surface water (including rainwater collection)` = "unprotected",
                              .default = "protected")

bl.esbl$toilet <- as.numeric(bl.esbl$toilet == "Flush Toliet (any type)")

bl.esbl$ESBL <- as.numeric(bl.esbl$ESBL == "Positive")  
  
bl.esbl$season <- "dry"
bl.esbl$season[month(bl.esbl$enroll_date) >= 11 | month(bl.esbl$enroll_date) <= 4] <- "rainy"
bl.esbl$hivcpt[is.na(bl.esbl$hivcpt)] <- 0
bl.esbl$hivonart[is.na(bl.esbl$hivonart)] <- 0
bl.esbl <- select(bl.esbl, -enroll_date)
bl.esbl[bl.esbl == "Yes"] <- 1

bl.esbl[bl.esbl == "No"] <- 0

bl.esbl$tbongoing[bl.esbl$d2arm == "Arm 3 (Community)"] <- 0
bl.esbl$tbongoing[is.na(bl.esbl$tbongoing)] <- 0
bl.esbl$recieved_prehosp_ab[bl.esbl$tbongoing == 1] <- 1
bl.esbl <- select(bl.esbl, -tbongoing)

univ_or <- function(df, oc_var) {
  out <- list()
  varz <- names(df)
  varz <- varz[!grepl(oc_var, varz)]
  for (i in 1:length(varz)) {
    form <- formula(paste0(oc_var, " ~ " ,varz[i]))
    modout <- glm(formula = form, data = df, family = "binomial")
    dfout <- bind_cols(tidy(modout), confint_tidy(modout))
    dfout[c(2:4,6,7)] <- sapply(dfout[c(2:4,6,7)], exp)
    dfout <- dplyr::select(dfout, term, estimate, conf.low, conf.high, p.value)
    dfout <- dplyr::filter(dfout, term != "(Intercept)")
    out[[i]] <- dfout
  }
  out <- do.call(rbind, out)
  return(out)
}

uv <- univ_or(bl.esbl, "ESBL")

glm(ESBL ~ ., data = bl.esbl, family = 'binomial') -> mv.mod
  dfout <- bind_cols(tidy(mv.mod), confint_tidy(mv.mod))
    dfout[c(2:4,6,7)] <- sapply(dfout[c(2:4,6,7)], exp)
    dfout <- dplyr::select(dfout, term, estimate, conf.low, conf.high, p.value)
    dfout <- dplyr::filter(dfout, term != "(Intercept)")

  uv$str <- uv %>% glue_data('{specify_decimal(estimate, 2)} ({specify_decimal(conf.low, 2)}-{specify_decimal(conf.high, 2)})')
  dfout$str <- dfout %>% glue_data('{specify_decimal(estimate, 2)} ({specify_decimal(conf.low, 2)}-{specify_decimal(conf.high, 2)})')
    names(uv)[2:6] <- paste0("uv_", names(uv)[2:6] )
    names(dfout)[2:6] <- paste0("mv_", names(dfout)[2:6] )
    bl.esbl.tab <- merge(uv, dfout) %>% select(term, uv_str, uv_p.value, mv_str, mv_p.value)
    bl.esbl.tab$boldrows.mv <- bl.esbl.tab$mv_p.value < 0.05
    bl.esbl.tab$boldrows.uv <- bl.esbl.tab$uv_p.value < 0.05
    bl.esbl.tab$uv_p.value <- specify_decimal(bl.esbl.tab$uv_p.value, 3)
     bl.esbl.tab$mv_p.value <- specify_decimal(bl.esbl.tab$mv_p.value, 3)
      bl.esbl.tab$uv_p.value[ bl.esbl.tab$uv_p.value  == "0.000"] <- "<0.001" 
      
      recode.str <- c(calc_age = "Age (per year)",
                      ptsexMale = "Male sex (vs female)",
                      `d2armArm 2 (Inpatient)` = "Arm 2 (vs 1)",
                      `d2armArm 3 (Community)` = "Arm 3 (vs 1)",
                      
                      hivstatusReactive = "HIV+ (vs HIV-)",
                      hivstatusUnknown = "HIV unknown (vs HIV-)",
                      hivcpt1 = "CPT (vs none)",
                      hivonart1 = "ART (vs none)",
                      tbongoing1 = "Current TB treatment",
              
                      pmhxrechospital1 = "Hospitalisation",
                      recieved_prehosp_ab1 = "Antibiotics*",
                      
                      householdchildno = "Children (per 1)",
                      housholdadultsno = "Adults (per 1)",
                      keepanim1 = "Keep animals (vs not)",
                      toilet = "Flushing toilet (vs not)",
                      watersourceunprotected = "Unprotected water source",
                      watertreated1 = "Treat water (vs not)",
                      
                      seasonrainy = "Rainy season (vs. dry)"
                      
                      )
  
      recode_factor(bl.esbl.tab$term , !!!recode.str, .ordered = TRUE)   -> bl.esbl.tab$term
      bl.esbl.tab[order(bl.esbl.tab$term),] -> bl.esbl.tab
      
      bl.esbl.tab[2:3]<- sapply(bl.esbl.tab[2:3], function(x) text_spec(x, "latex", bold = bl.esbl.tab$boldrows.uv))
           bl.esbl.tab[4:5]<- sapply(bl.esbl.tab[4:5], function(x) text_spec(x, "latex", bold = bl.esbl.tab$boldrows.mv))
      
      kable(select(bl.esbl.tab, -c(boldrows.mv, boldrows.uv)), "latex", booktabs = TRUE,
      row.names = FALSE, escape = FALSE, col.names = c("Variable","OR (95\\% CI)", "p-value", "aOR (95\\% CI)", "p-value"),
      caption = "Univariable and multivariable associations of ESBL colonisation at enrollment") %>% kable_styling(full_width = FALSE) %>%
       pack_rows("Demographics", 1,2, bold = FALSE) %>%
       pack_rows("Study Arm", 3,4, bold = FALSE) %>%
       pack_rows("HIV status", 5,8, bold = FALSE) %>%
       pack_rows("Exposures last month", 9,10, bold = FALSE) %>%
       pack_rows("Household size", 11,13, bold = FALSE) %>%
       pack_rows("WaSH behaviour", 14,16, bold = FALSE) %>%
       pack_rows("Season", 17,17, bold = FALSE) %>%
  add_header_above(c(" " = 1, "Univariable" = 2, "Multivariable" = 2)) %>% 
  footnote(general = "CPT = Cotrimoxazole preventative therapy, ART = antiretroviral therapy, WaSH = Water, sanitation and hygiene. Entries in bold are those for which 95\\% confidence intervals do not cross 1.", symbol = "Antibiotics includes TB therapy but excludes CPT.", threeparttable = T, fixed_small_size = T) 
      
```


```{r, esbl-aq-mod, echo = FALSE, message = FALSE, warning = FALSE, fig.scap="Associations of ESBL-E acquisition by 28 days", out.extra='', fig.cap = "Association of ESBL-E acquisition by 28 days. Bivariable (A) and multivariable (B) associations of antimicrobial and hospital exposure with acquisition of ESBL-E by 28 days. A: These plots show the proportion of participants who have no detectable ESBL-E baseline but who do at 28 days, as a function of various exposures. All antibacterials and hospitalisation show an association between exposure and ESBL-E acquisition, with a suggestion of a dose-response relationship, though confidence intervals are wide in many cases. Antimalarials show no apparent relationship though, as with fluconazole, the wide confidence intervals make it difficult to draw any conclusions. The results from logistic regression to predict ESBL-E acquisition are shown in (B); colinearity and small dataset size means that confidence intervals are so large as to make the model useless. A better approach to modelling ESBL-E acquisition, Markov modelling, is shown in Chapter xx.",  fig.height = 7, fig.width=7, fig.align = 'center'}

lims_dates$delta28 <- abs(28 - lims_dates$assess_type)

lims_dates %>% 
  filter(assess_type >= 14 & assess_type <= 42) %>%
  mutate(delta28 = abs(28-assess_type)) %>%
  group_by(pid) %>% slice(which.min(delta28)) -> d14.42


merge(d14.42, lims_dates %>% filter(visit == 0) %>% select(pid, ESBL), all.x = T , by = "pid") -> d14.42

names(d14.42)[names(d14.42) == "ESBL.x"] <- "ESBL.d28"
names(d14.42)[names(d14.42) == "ESBL.y"] <- "ESBL.d0"

exposures.42 <- df.covs.cpt %>% group_by(pid) %>% do(extract_covariate_exposure(dfin = ., 4, 26, 0, 42))

d14.42 <- merge(d14.42, exposures.42, by = "pid", all.x = T)

d14.42[c(12:34)] <- apply(d14.42[c(12:34)], 2, function(x) ifelse(x > d14.42$assess_type, d14.42$assess_type, x))

#d14.42 <- select(d.14.42pid, assess_type, ESBL.d0, ESBL.d28, names(exposures.42))

select(d14.42, pid, assess_type, ESBL.d0, ESBL.d28, names(exposures.42)) -> d

d <- filter(d,ESBL.d0 == "Negative")
d$ESBL.d28 <- as.numeric(d$ESBL.d28 == "Positive")

cutz <- c(-1,0,5, 42)

cutnames <- levels(cut(d$assess_type, c(-1,0,5, 42)))

out <- list()
for (i in 1:(length(cutz)-1)) {
  out[[i]] <- paste0(cutz[i], "-",cutz[i+1])
}

unlist(out) -> cutnewnames

cutnewnames[2] <- "1-5"

paste0(cutnewnames, " days") -> cutnewnames
cutnewnames[1] <- "0 Days"
names(cutnewnames) <- cutnames

d %>% select(ESBL.d28,  amoxy, cotri, cefo, cipro, hosp, tb, coart, arte, fluco) %>%
    pivot_longer(-ESBL.d28) %>%
    mutate(value.cut = cut(value, c(-1,0,5, 42))) %>% 
    group_by(name, value.cut) %>% 
    summarise(n = n(), e = sum(ESBL.d28 == 1), prop = e/n, lci = binom.test(e,n)$conf.int[[1]], uci = binom.test(e,n)$conf.int[[2]]) %>% ungroup() %>%
    mutate(name = recode_factor(name, !!!abs.lookup[c("amoxy", "cipro", "cotri", "cefo", "arte", "coart", "tb", "fluco","hosp")], .ordered = TRUE),
           value.cut = recode_factor(value.cut, !!!cutnewnames, .ordered = TRUE )) %>%
    ggplot(aes(value.cut, prop, ymin = lci, ymax = uci, group = name)) + geom_point() + geom_line() + theme_bw() + facet_wrap(~ name, ncol = 4) + 
  geom_errorbar(width = 0) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + xlab(element_blank()) +
  ylab("Proportion aquire ESBL-E at 28 days") -> pa

glm(ESBL.d28 ~ (cefo > 0) + (amoxy > 0) +  (cotri > 0)+ (hosp > 0) + (tb > 0) + (cipro > 0), data = d, family = 'binomial') -> m                           
bind_cols(tidy(m),confint_tidy(m)) -> mod

mod$term <- map_chr(mod$term, ~  strsplit(., ">")[[1]][[1]]) %>% str_trim

mod %>% filter(term != "(Intercept)") %>% 
  mutate(term = recode_factor(term, !!!abs.lookup[c("amoxy", "cipro", "cotri", "cefo", "tb","hosp")], .ordered = TRUE)) %>%
           ggplot(aes(fct_rev(term), exp(estimate), ymin = exp(conf.low), ymax = exp(conf.high))) + 
           geom_point() +
           geom_errorbar(width = 0) +
           coord_flip() +
           theme_bw() +
           geom_hline(yintercept = 1, linetype = "dashed") +
  xlab(element_blank()) +
  ylab("aOR of ESBL acquisition by 28 days") -> pb

ggarrange(pa, 
          ggarrange(NULL,pb, NULL, ncol = 3, nrow = 1, widths = c(0.4,1.5,0.6)),
          ncol =1 , nrow =2, heights = c(3,1.5), labels = c("A", "B")
)

```

## Discussion

In this chapter, I have presented the data which begins to address the second aim of this thesis: to describe, and identify determinents of, ESBL-E acquisition and carriage in Malawian adults as they pass through the hospital. It is possible to draw several conclusions from these data. First, community ESBL-E carriage is common, and the prevalence is high compared to high income settings, comparable to many community studies from elsewhere in sSA and other high-prevalence settings such as India. The baseline community carriage prevalence of 28% is considerably higher than the 4-7% seen in Europe[@McNulty2018;@Wielders2017;Ny2017;Valverde2004] and comparable to the sSA pooled community prevalence estimate presented in Chapter 1 of 18% (95% CI [11-27%]). 

Secondly, the associations of baseline ESBL-E carriage give insight into the drivers of ESBL-E transmission in the Malawian setting. Household crowding, and use of unprotected water sources and are associated with ESBL-E colonisation, suggesting that both household transmission and environmental reservoirs play a role in the spread of ESBL-E in Blantyre. The number of adults in the household, rather than the number of children, was associated with ESBL-E carriage in the adults in this study, suggesting that within the household adult to adult transmission is a more important route than child to adult transmission. This could be for a number of reasons - if the ESBL-E prevalence were low in children, for example. Though children were not sampled in this study and so the data here can not address that hypothesis, data from other studies suggest this is unlikely: community prevalence in children ranged from 10-59% in four studies in the Central African Republic[@Farra2016], Senegal[@Ruppe2009] and Tanzania[@Tellevik2016;Moremi2017], and is hence comparable to the adult community prevalence seen in this study. Behavioural factors, or a lower bacilliary burden in children could also account for the associations seen here.I also demonstrate a seasonality to ESBL-E colonisation. This is again consistent with environmental spread of ESBL-E - faecal oral transmission of bacteria could be more likely in the rainy season - but changes in behaviours during the rains could also contribute.

### Limitations

## Conclusions and further work

