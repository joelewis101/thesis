# Modelling to identify determinants of sepsis mortality
\chaptermark{Sepsis outcome models}

```{r ch4b-setup, include = F}

library(plyr)
library(reshape2)
library(tidyverse)
library(knitr)
library(kableExtra)
library(grid)
library(ggpubr)
library(pheatmap)
library(UpSetR)
library(eulerr)
library(RColorBrewer)
library(scales)
library(lubridate)
library(survival)
library(eq5d)
library(ggsci)
library(survminer)
library(brms)
library(FactoMineR)
library(factoextra)
library(epitools)
library(glue)
library(MatchIt)

wd <- "chapter_4/"
output = "latex"
T <- TRUE

specify_decimal <- function(x, k) trimws(format(round(x, k), nsmall=k))


# generate figures
#source("chapter_4/generate_consort_diagram.R")
source("final_cleaning_scripts/generate_visits_df.R")
source("final_cleaning_scripts/load_and_clean_followup_and_enroll_labelled.R")
source("other_scripts/summary_table_functions.R")
source("final_cleaning_scripts/make_composite_hivstatus_variable.R")
#source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_bloods.R")
source("final_cleaning_scripts/load_and_clean_aetiol.R")
source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_upto72.R")
source("final_cleaning_scripts/load_and_clean_post72.R")
source("final_cleaning_scripts/load_and_clean_hosp_oc.R")
source("final_cleaning_scripts/load_and_clean_time_to_ab.R")
source("final_cleaning_scripts/load_and_clean_fluid_hr1_to_6.R")



h1.ustand <- read.csv("/Users/joelewis/Documents/PhD/Data/Current/portal_downloads/other_datasets/h1_ustand.csv")


  
# calc time to recruitment

hourly %>% group_by(pid) %>% summarise(first_ax = min(date_time, na.rm= T)) -> fa

merge(select(df.abs, pid, earliest_arr_time), fa, all.x = T) -> fa
difftime(fa$first_ax, fa$earliest_arr_time, units = "hours") -> fa$dt
fa$dt2 <- fa$dt
fa$dt2[fa$dt2 > 1] <- fa$dt2[fa$dt2 > 1] -1

time_to_rec_str <- median_iqr_str(as.numeric(fa$dt2),1)

df <- subset(enroll, arm == 1)
df$gcs <- df$t0gcse + df$t0gcsv + df$t0gcsm
df <- merge(df, bloods, all.x = T)

aetiol.m <- dcast(aetiol, pid + hivstatus ~ type, value.var = "pathogen")
aetiol.m$tb <- aetiol.m$`mtb bsi`== 1 | aetiol.m$uLAM == 1 | aetiol.m$Xpert == 1

df <- merge(df, select(aetiol.m, - hivstatus), all.x = T)

df <- merge(df, select(df.abs, pid, first_ab, time_to_abx))

df <- merge(df, select(df.tb, pid, any_tb_rx, time_to_tb_rx))

df <- merge(df, select(fluid, pid, `6`))
names(df)[names(df) == "6"] <- "fluid_6hr"

df.mal.b <-select(df.mal, pid, first_ab, time_to_mal_rx)
names(df.mal.b)[2:3] <- c("first_mal_rx", "time_to_mal_rx")

df <- merge(df, df.mal.b)
rm(df.mal.b)

df.fung.b <-select(df.fung, pid, first_ab, time_to_fung_rx)
names(df.fung.b)[2:3] <- c("first_fung_rx", "time_to_fung_rx")

df <- merge(df, df.fung.b)
rm(df.fung.b)

df[df == 999] <- NA

#aetiol.m -> a
#a[is.na(a)] <- 0
#a$no_diagnosis <- as.numeric(apply(a[3:8], 1,sum) == 0)



v1 <- visits %>% filter(arm == 1) 

v1$t <- apply(v1[7:10], 1,max, na.rm= T )

v1$t[!is.na(v1$died_date)] <- v1$died_date[!is.na(v1$died_date)]

#v1$t <- v1$t * 7
v1$died <- v1$status
v1$died[v1$died == 2] <- 0

v1 <- select(v1, pid, enrolled, arm, t, died)

#v1$d28_death

v1$d28_death <- NA

v1$d28_death[(v1$t <= 28) & (v1$died == 1)] <- 1
v1$d28_death[(v1$t >= 28)] <- 0

v1$d90_death[(v1$t <= 90) & (v1$died == 1)] <- 1
v1$d90_death[(v1$t >= 90)] <- 0

v1$d180_death[(v1$t <= 180) & (v1$died == 1)] <- 1
v1$d180_death[(v1$t >= 180)] <- 0

df <- merge(df, v1, all.x = T)

df <- merge(df, h1.ustand, all.x= T)

df$sbp.dic <- (df$t0sbp <= 90)
df$t.dic <- NA
df$t.dic[df$screentemp < 36] <- "<36"
df$t.dic[df$screentemp >= 36 & df$screentemp < 38] <- "36-38"
df$t.dic[df$screentemp >= 38] <- ">38"

df$hr.dic <-  (df$t0hr > 100)
df$rr.dic <-  (df$t0rr > 30)
df$cd4.dic <- (df$CD4_Absolute <= 200)
df$spo2.dic <- (df$t0spo2 < 90)
df$gcs.dic <- (df$gcs < 15)
df$lact.dic <- (df$lactate_value > 3)
as.numeric(df$WCC) > 11 -> df$WCC.dict
df$CO2.dic <- as.numeric(df$CO2 < 23)

# assess bivariate distributions
df$t0map <- (df$t0sbp + (df$t0dbp * 2))/3 

df$tb[df$tb] <- 1
df$tb[df$tb == FALSE | is.na(df$tb) ] <- 0

df$malaria[is.na(df$malaria)] <- 0
df$bc[is.na(df$bc)] <- 0
df$csf[is.na(df$csf)] <- 0


e1 <- subset(enroll, arm == 1)


df.temp <- dplyr::select(df,pid, d28_death, hivstatus,hivonart, calc_age,ptsex,screentemp, t0sbp, t0dbp, t0map, t0hr, t0rr, t0spo2, gcs, ustand, lactate_value,
                         WCC, CD4_Absolute, Haemoglobin, Platelets, NA.,Potassium, Urea, Creatinine, CO2, Chloride, fluid_6hr, any_tb_rx, time_to_tb_rx, first_mal_rx, time_to_mal_rx, first_fung_rx, time_to_fung_rx, first_ab, time_to_abx, fluid_6hr,
                         bc, tb, csf, malaria
) 

df.temp$fluid_6hr <- df.temp$fluid_6hr/1000

apply(df.temp[c("tb", "malaria", "bc", "csf")], 1, sum) -> df.temp$n_diagnoses


#df.temp2 <- subset(df.temp2, n_diagnoses < 2 & csf == 0)

df.temp$no_diagnosis <- as.numeric(df.temp$n_diagnoses == 0)


df.temp$time_to_abx <- as.numeric(df.temp$time_to_abx)
df.temp$time_to_tb_rx <- as.numeric(df.temp$time_to_tb_rx)
df.temp$time_to_mal_rx <- as.numeric(df.temp$time_to_mal_rx)
df.temp$time_to_fung_rx <- as.numeric(df.temp$time_to_fung_rx)

df.temp$any_ab <- as.numeric(df.temp$first_ab != "none")
df.temp$any_mal_rx <- as.numeric(!is.na(df.temp$first_mal_rx))
df.temp$any_fung_rx <- as.numeric(!is.na(df.temp$first_fung_rx))

df.temp$any_tb_rx[df.temp$any_tb_rx == "on admission"] <- "none"
df.temp$any_tb_rx[df.temp$any_tb_rx == "none"] <- 0
df.temp$any_tb_rx[df.temp$any_tb_rx == "yes"] <- 1
df.temp$any_tb_rx <- as.numeric(df.temp$any_tb_rx)

df.temp <- dplyr::select(df.temp, -c(first_mal_rx, first_fung_rx, first_ab, n_diagnoses))

df.temp[df.temp == 999] <- NA

df.temp$CD4_Absolute[df.temp$hivstatus != "Reactive"] <- NA
df.temp$hivstatus[df.temp$hivstatus == "Reactive"] <- 1
df.temp$hivstatus[df.temp$hivstatus == "Non reactive"] <- 0
df.temp$hivstatus[df.temp$hivstatus == "Unknown"] <- NA
df.temp$hivstatus <- as.numeric(df.temp$hivstatus)


df.temp$ptsex[df.temp$ptsex == "Male"] <- 1
df.temp$ptsex[df.temp$ptsex == "Female"] <- 0
df.temp$ptsex <- as.numeric(df.temp$ptsex)

df.temp$hivonart[df.temp$hivonart == "Yes"] <- 1
df.temp$hivonart[df.temp$hivonart == "No"] <- 0
df.temp$hivonart <- as.numeric(df.temp$hivonart)
#df.temp$ustand <- as.character(df.temp$ustand)
df.mod <- dplyr::select(df.temp, screentemp, d28_death, hivstatus, 
                        calc_age, ptsex, screentemp, t0map, t0hr, t0rr, t0spo2,
                        gcs,ustand, lactate_value, WCC, Haemoglobin, Platelets,
                        CO2, Urea, Creatinine, fluid_6hr, any_tb_rx, any_ab, any_mal_rx, any_fung_rx,
                        bc, tb, csf, malaria)

df.mod[c("d28_death", "hivstatus","ptsex","ustand","any_tb_rx", "any_ab", "any_mal_rx", "any_fung_rx", "bc", "tb", "csf", "malaria")] <-
  sapply(df.mod[c("d28_death", "hivstatus","ptsex","ustand","any_tb_rx", "any_ab", "any_mal_rx", "any_fung_rx", "bc", "tb", "csf", "malaria")], as.character)
```

## Chapter overview

In this chapter I develop the mortality models from Chapter 3 to address difficulties arising from the problems of separation, overparametrisation, collinearity and missing data. I use Bayesian logistic regression following multiple imputation of missing data and dimensionality reduction using factor analysis of mixed data (FAMD), to show that, broadly, inferences from the original models are sound. The association of receipt of TB therapy with survival persisted across all models. There was no clear association between more rapid administration of antibacterials or volume of intravenous fluid administered and survival, though in both cases the 95% credible intervals of effect size incorporated a clinically significant effect. A subgroup analysis using a propensity-score approach suggested that the association of TB therapy with survival was strongest in immunosuppressed and/or anaemia participants, though numbers were small and confidence intervals wide. The role of early administration of TB therapy in septic adults in Malawi is unknown, though the analyses here suggest a potentially significant impact, and, I suggest, contribute to the equipoise necessary for clinical trials.

## Introduction and chapter aims

In Chapter 3, I used classical epidemiological approaches to identify associations with mortality in sepsis in Malawi, however there were some problems with the approaches used, both technical and conceptual. The technical issues are: that the model may include too many parameters and be overfit; that a complete-case analysis was undertaken which can introduce bias; that included variables may be collinear which can contribute to increased variance in parameter estimates; and, perhaps most importantly, some parameters perfectly predicted outcome and so were excluded from the model. Conceptually, I argue that it is difficult to interpret parameters without first making explicit the causal model for data generation. I will cover each of these points below, before describing the techniques I used to address them.
 
First, the model may be overfit. Adding covariates to a model may reduce bias in parameter estimates but will increase variance (the so called bias-variance trade off[@Hastie2009]) which may make interpretation difficult. More parameters in a model results in a better fit to the data, but an overfit model may end up fitting to noise, rather than identifying the true data-generating process, and so would have biased inferences and poor out of sample prediction.  Rules of thumb based on ~ 10 outcomes per included predictor have been suggested[@Harrell2001], but the process of selecting variables to include is difficult with no consensus as to how it should be achieved. Common approaches include stepwise inclusion strategies, where variables are sequentially added or removed based on some criteria of model fit or statistical significance, but these can introduce significant bias. This is because the statistics used to test the parameters (and generate confidence intervals around effect sizes etc.) are based on an assumption that a single hypothesis is being tested, an assumption which is violated by the stepwise model building process. It can be shown that standard errors are too small, that p-values are biased towards zero and parameter estimates biased away from zero [@Harrell2001].

How, then, to select variables to include in the models presented here? _A priori_ selection of variables for theoretical reasons is likely ideal, but this becomes difficult when there are a large number of potentially important predictors.  Dimensionality reduction techniques (such as principal components analysis) or shrinkage methods (lasso or ridge regression) have been suggested as alternative predictor variable selection techniques[@Tibshirani1996; @Harrell2001; @Hastie2009]. I use a dimensionality reduction technique called factor analysis of mixed data[@Le2008] (FAMD) and compare out-of sample prediction (using cross validation) of models built using this technique to the original model - see method below.

A further problem in modelling mortality in studies of sick inpatients is collinearity, where some predictor variables can be predicted with high accuracy by other predictor variables. For example, shocked patients are likely to have elevated lactate, low blood pressure, low bicarbonate, and high heart rate and so parameter estimates become very large (or unidentifiable) when these are all entered a regression model together[@Gelman2007]. An advantage of principal-components type dimensionality reduction (including FAMD) is that they can solve this problem by generation new coordinate systems that are constrained to be orthogonal. Missing data bias too can be significant; I address this by using multiple imputation by chained equations where new values for each missing data point are generated by models based on all other data[@Rubin1987].

The finally technical modelling challenge to overcome is the phenomenon of separation, where some covariates perfectly predict outcome[@Gelman2007]. In the maximum likelihood framework (usually used to fit logistic regression models) the parameter estimates for such covariates are non identifiable (essentially infinite), and hence the covariates are often excluded from the model, even though they are often very strong predictors of outcome. I use Bayesian logistic regression with weakly informative priors to overcome this problem. In the Bayesian modelling framework, probabilities encodes our belief about parameter values. Probability distribution of parameters are generated from a combination of the data  and a _prior_, quantifying our belief about the parameter values prior to seeing the data. To overcome the problem of separation, Gelman et al [@Gelman] suggest using our belief that very large or very small parameter estimates (e.g. an odds ratio of 100) are unusual, which is encoded as a student's t distribution with 3 degrees of freedom, centre zero and scale 2.5. In the broadest sense, a distribution not dissimilar to a normal distribution, but with longer tails: we think that the parameters will be close to 0, but allow a chance they may be larger. In effect, this pulls the infinite parameter estimates from the data closer to 0.

Even if the parameters of the regression can be correctly specified, however, correct interpretation of predictor effects is often difficult or impossible without a clear hypothesised causal structure. For example, consider a hypothesised causal structure of death in sepsis in Figure \@ref(fig:causal-structure), which I express as a directed acyclic graph (DAG); nodes represent collections of variables which theoretically specify host status (age, sex, immune status including HIV status and CD4 cell count), infection type (e.g. causative pathogen, site), disease severity (e.g physiological variables quantifying shock, hypoxia etc.), therapies administered, and outcome. Arrows (called edges in the DAG framework) show causality: host status influences infection (e.g. TB is more common in HIV) and severity (patients with advanced HIV may have more severe infection), for example, and therapies administered is likely to be influenced by disease severity (perhaps sicker patients receive antimicrobials more quickly), host status (clinicians are likely to administer different therapies to HIV-infected patients), and infection type. A standard analysis of sepsis would construct a predictive multivariable model for death by including factors which the analyst felt likely to be associated with mortality, which would usually include HIV status, CD4 cell count, physiologic variables (such as presence of shock) and infection variables (e.g. presence of bloodstream infection [BSI]). The effects of the predictor variables are often then interpreted as the independent effect of the included predictors, after controlling for all others; however, this may not be the case. 

For example, severity is at least in part a mediator of the effect of HIV on outcome, so the interpretation of the coefficient of HIV in such a model is the residual effect of HIV once disease severity is accounted for. It is likely that there are direct effects of host and infection factors on outcome (dotted edges in Figure \@ref(fig:causal-structure), not least because measured variables in a study are unlikely to wholly quantify disease severity, but if not then controlling for disease severity will completely remove the effect of HIV status on mortality, which may not be the analysts intention, or interpretation of parameters. This has been called the "Table 2 fallacy."[@Westreich2013] It is important therefore to clearly define the effect that is being sought from an analysis (e.g. the effect of HIV status on mortality) and to ascertain which factors need to be controlled for based on this. It may be that a number of different models are necessary to estimate parameters of interest, if more than one parameter is of interest. The causal inference framework provides tools to do this using DAGs[@Pearl2016], and the _dagitty_ package in R[@Textor2017] automates this framework so, when provided with a DAG, it can output the variables that must be conditioned upon to estimate the causal effect of an exposure on an outcome. In this chapter, therefore, I am clear that the aim of the analysis is to provide an estimate of the effect of treatments administered on mortality; the class of antimicrobial administered (antibacterial, antifungal, antimycobacterial or antimalarial) as well as the time-to-antimicrobial for different classes, and the volumes of intravenous fluid administered. This will inform the overarching aim of the thesis - to develop novel antimicrobial strategies for sepsis in sSA to improve outcomes.

```{r causal-structure, echo = F, fig.scap="Hypothesised causal structre of mortality in sepsis", out.extra='', fig.cap="Hypothesised causal structre of death in sepsis. Host factors (e.g. age, sex, immune status) influence the type of infection; disseminated TB is more common in HIV, for example. Severity  (variables quantifying e.g. shock or respiratory failure) is influenced by infection type and host factors. Therapy encodes which antimicrobials were administered and rapidity of administration of antimicrobials, and is influenced by disease severity (sicker patients may be given different therapies), host factors (HIV status may influence treatment) and the infection type (for example, malaria rapid diagnostic tests influenceing rapidity of malaria treatment). Dotted edges from host and infection to outcome are because it is not clear \\textit{a priori} whether the effect of infection and host factors are entirely mediated by disease severity: in fact, even if this were the case in a theoretical sense, the available severity variables are unlikley to completely account for the causative effect of infection type on mortality and so conditioning on all available severity variables is likely to leave some residual causative effect of infection type. See text for further discussion",  out.height = '50%', fig.align = 'center'}

knitr::include_graphics(paste0(wd, "figures/causal_dag_mortality.pdf"))

```

## Methods 

Assuming the causal model in Figure \@ref(fig:causal-structure), an estimation of the effect of administered treatment will require correcting for (or conditioning on) host, infection, and severity variables (assuming a direct effect of infection and host on outcome, as seems likely) i.e. all the variables that were included in the logistic regression model in Chapter 3. To solve the problem of nonidentifiability of the models including malaria and meningitis status, I refit the models in a Bayesian framework with weakly informative priors. A student's t distribution centred on 0 with three degrees of freedom and a scale of 2.5 was used as the prior for all parameters, following Gelman et al[@Gelman]. The model was fit using the  _brms_ package in R[@Burkner2017], which acts as a front end to the Stan probabilistic programming language[@Carpenter2017]. Four Markov-chain Monte-Carlo (MCMC) chains each with 1000 iterations and a burn-in of 500 iterations were used with default _brms_ settings. Convergence was assessed using traceplots and assessing for autocorrelation using the Gelman-Rubin diagnostic ($\hat{R}$) with a target of $\hat{R} < 1.1$). Parameter estimates were expressed as medians and 95% credible intervals.

To correct for missing-data bias, missing data were imputed using multiple imputation of chained equations using default settings in the _mice_ package in R[@Buuren2011], with each missing variable predicted by all other missing variables n the model, to produce 5 imputed datasets. Models were fit using _brms_ and then pooled parameter values calculated by taking medians and 95% confidence intervals of pooled posterior parameter estimates from all imputed datasets. The parameter estimates from complete-case analysis and multiple imputation are both presented.

One of the concerns of this model is that it is overfit - that is, there are so many parameters that it will fit to noise in the data rather than to the true data-generating process. To assess whether this was the case, I performed dimensionality reduction to collapse the predictor variables into a smaller number of variables, refit models using these variables, and then compared all models predictive ability using leave-one out cross validation. The dimensionality reduction technique that I used was factor analysis of mixed data (FAMD) from the _FactoMineR_ package in R[@Le2008]. This technique uses principal component analysis (PCA) for continuous variables and multiple correspondence analysis (MCA) to generate a new orthogonal coordinate system which maximises explained variance in each FAMD axis. FAMD axis one therefore explains the most variance in the dataset, followed by FAMD axes 2 and 3, and so on. As well as reducing the dimensionality of the dataset, this technique has the advantage of ensuring an orthogonal coordinate system to tackle the problem of collinearity. The raw covariate values were used to generate these new coordinate system.

Because the exposures of interest are the therapies administered to the participants in the study, treatment variables (receipt of antibacterials, antifungals, antimalarials, antimycobacterials, and IV fluid) were left untransformed. These variables and a number of transformed FAMD variables (ranging from 1 to 5) were used as predictors in new models to predict death by 28 days. The out of sample predictive ability of the models was assessed by performing leave-one-out cross validation using the _loo_ package in R[@Vehtari2017]. This estimates the out-of sample predictive ability of the model by estimating a quantity called the expected log pointwise predictive density ($ELPD$) essentially the logarithm of the likelihood for a new, unseen dataset conditional on the current data. This quantity is estimated using leave-one-out cross validation to produce and estimate of the $ELPD$, hereafter referred to as $ELPD_{loo}$. The standard error of $ELPD_{loo}$ for a model is also calculated and so two models can be compared by comparing the $ELPD_{loo}$ difference and standard error; if the difference is greater than twice the standard error (i.e. a 95% confidence interval, assuming normality) we can be confident that one model would be expected to have greater out-of-sample predictive ability than the other[@Vehtari2017].

The relationship between time-to-antimicrobials and mortality was assessed, initially in bivariate associations using nonparametric locally estimates scatterplot smoothing (LOESS) regression which performs a rolling linear regression[@Cleveland1988] and estimates the probability of death by 28 days as a function of the predictor variables. Only for antibacterials were there sufficient data to construct regression models which used time to antibacterial therapy as a predictor for death by 28 days, alongside the other treatment variables and the first three FAMD dimensions. In view of possible nonlinear relationship between time to therapy and death apparent in the bivariate plots both linear and second-order polynomial models were fit. Coefficient estimates are presented, but because interpretation of polynomial coefficients is challenging, predicted probability plots with 95% credible intervals with the levels of the other covariates set to their mean values were plotted, using all the posterior draws to generate the median prediction and 95% credible intervals.

Finally, to attempt to correct for confounding using a different method, a propensity-score matching approach was used to produce an unbiased estimate of the effect of receipt of TB therapy on 28-day mortality. Variables that had been identified as being associated with mortality from the models described above, along with variables that were associated with receipt of TB therapy apparent on bivariable analysis were included in a (maximum-likelihood fit) logistic regression model to generate a propensity score. Because HIV-uninfected participants did not have a CD4 count measured, a new dichotomous variable was used which was coded as 1 for HIV-infected participants with a CD4 count below 100 cells $\mu L^{-1}$ and 0 for everyone else. Participants were then matched 1:1 on this propensity score without calliper restriction using the _MatchIt_ package in R[@Ho2011] and the distribution of covariates in this new cohort examined using kernal density plots and histograms. Effect of TB therapy on mortality was then expressed as risk ratios, and subgroup analysis carried out to explore whether there was any effect modification of the apparent effect of TB therapy in advanced immunosuppression (defined as CD4 cell count below 100 $\mu L^{-1}$), or anaemia (defined as haemoglobin below 8g dL$^{-1}$) or confirmed TB.

## Results

Bayesian logistic regression with weakly informative priors succeeding in fitting the models from Chapter 3; the inferences - particularly concerning the apparent association between TB therapy and survival - were largely unchanged, including after multiple imputation of missing data (Table \@ref(tab:bayes-lr-imp-tab)). Because of concerns about overfitting, dimensionality reduction with FAMD was carried out; the first four FAMD dimensions explained 42% of the variance in the dataset, a not inconsiderable amount for 21 predictor variables. The composition of FAMD dimensions one, two, three and four are shown in Figure \@ref(fig:famd-mods-contrib). FAMD dimensions 1 (explaining 14% of the total variane of the dataset) was composed primarily of variables that were associated with shock (urea, lactate, low MAP and bicarbonate, and creatinine) and HIV-associated immunosupression (HIV status and haemoglobin); FAMD dimension 2 was similar but included organ dyfunction criteria that were orthogonal to FAMD 1: low oxygen saturation and platelet count, and male sex. FAMD 3 was composed of absence of malaria, low GCS, high white cell count and inability to stand; FAMD 4 with young age, fever, and tachycardia. 


\renewcommand{\arraystretch}{0.8}
```{r bayes-lr-imp-tab, echo =F, warning=F, message=F}

m.b.cc <- readRDS("chapter_4/brms_orig_data_cca.rda")
# complete ase brms model
as.data.frame(fixef(m.b.cc)) -> cc.parms

names(cc.parms) <- paste0(names(cc.parms), "_cc")
cc.parms$term <- rownames(cc.parms)

m.b.imp <- readRDS("chapter_4/brms_fit_imputed_datasets.rda")
as.data.frame(fixef(m.b.imp)) -> imp.parms

names(imp.parms) <- paste0(names(imp.parms), "_imp")
imp.parms$term <- rownames(imp.parms)

lr_mod <- merge(cc.parms ,imp.parms)
lr_mod <- lr_mod[-c(3,7)]

lr_mod[lr_mod$term == "calc_age",][c(2:7)] <- lr_mod[lr_mod$term == "calc_age",][c(2:7)] * 5
lr_mod[lr_mod$term == "t0map",][c(2:7)] <- lr_mod[lr_mod$term == "t0map",][c(2:7)] * 10
lr_mod[lr_mod$term == "t0hr",][c(2:7)] <- lr_mod[lr_mod$term == "t0hr",][c(2:7)] * 10
lr_mod[lr_mod$term == "t0rr",][c(2:7)] <- lr_mod[lr_mod$term == "t0rr",][c(2:7)] * 10
lr_mod[lr_mod$term == "t0spo2",][c(2:7)] <- lr_mod[lr_mod$term == "t0spo2",][c(2:7)] * 5
lr_mod[lr_mod$term == "Platelets",][c(2:7)] <- lr_mod[lr_mod$term == "Platelets",][c(2:7)] * 100
lr_mod[lr_mod$term == "Creatinine",][c(2:7)] <- lr_mod[lr_mod$term == "Creatinine",][c(2:7)] * 10

lr_mod[2:7] <- exp(lr_mod[2:7])
lr_mod <- filter(lr_mod, term != "Intercept")
lr_mod$str_cc <- glue('{specify_decimal(lr_mod$Estimate_cc,2)} ({specify_decimal(lr_mod$Q2.5_cc,2)}-{specify_decimal(lr_mod$Q97.5_cc,2)})')

lr_mod$str_imp <- glue('{specify_decimal(lr_mod$Estimate_imp,2)} ({specify_decimal(lr_mod$Q2.5_imp,2)}-{specify_decimal(lr_mod$Q97.5_imp,2)})')

lr_mod[match(c("calc_age", "ptsex1", "hivstatus1", "Haemoglobin","screentemp", "t0hr", "t0map",
        "t0rr", "t0spo2","gcs", "ustand1", "lactate_value" , "WCC", "Platelets", "CO2", "Urea", "Creatinine", "bc1", "tb1", "malaria1", "csf1", 
        "any_ab1", "any_fung_rx1","any_mal_rx1",  "any_tb_rx1", "fluid_6hr"), lr_mod$term),] -> lr_mod



lr_mod$term[lr_mod$term == "calc_age"] <- "Age (per 5 years increase)"
lr_mod$term[lr_mod$term == "ptsex1"] <- "Male sex (vs female)"
lr_mod$term[lr_mod$term == "hivstatus1"] <- "HIV Infected (vs uninfected)"
lr_mod$term[lr_mod$term == "hivstatusuk"] <- "HIV Unknown (vs uninfected)"
lr_mod$term[lr_mod$term == "Haemoglobin"] <- "Haemoglobin (per g dL\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "screentemp"] <- "Temperature ( per \\textdegree C)"
lr_mod$term[lr_mod$term == "t0hr"] <- "Heart rate (per 10 min\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "t0map"] <- "Mean arterial BP (per 10 mmHg)"
lr_mod$term[lr_mod$term == "t0rr"] <- "Respiratory rate (per 10 min\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "t0spo2"] <- "Oxygen saturation (per 5\\%)"
lr_mod$term[lr_mod$term == "gcs"] <- "GCS (per 1 unit)"
lr_mod$term[lr_mod$term == "ustand1"] <- "Unable to stand"
lr_mod$term[lr_mod$term == "lactate_value"] <- "Lactate (per 1 mmol L\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "WCC"] <- "White cell count (per 1x10\\textsuperscript{9} L\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "Platelets"] <- "Platelet count (per 100x10\\textsuperscript{9} L\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "CO2"] <- "Bicarbonate (per 1 mmol L\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "Urea"] <- "Urea (per 1 mmol L\\textsuperscript{-1})"
lr_mod$term[lr_mod$term == "Creatinine"] <- "Creatinine (per 10 mmol L\\textsuperscript{-1})"

lr_mod$term[lr_mod$term == "bc1"] <- "BSI (vs no BSI)"
lr_mod$term[lr_mod$term == "tb1"] <- "TB (vs no TB)"
lr_mod$term[lr_mod$term == "malaria1"] <- "Malaria (vs no malaria)"
lr_mod$term[lr_mod$term == "csf1"] <- "Meningitis (vs no meningitis)"

lr_mod$term[lr_mod$term == "any_ab1"] <- "Received antibacterial (vs none)"

lr_mod$term[lr_mod$term == "any_fung_rx1"] <- "Received antifungal (vs none)"
lr_mod$term[lr_mod$term == "any_mal_rx1"] <- "Received antimalarial (vs none)"
lr_mod$term[lr_mod$term == "any_tb_rx1"] <- "Received antimycobacterial (vs none)"

lr_mod$term[lr_mod$term == "fluid_6hr"] <- "IV fluid (per L)"

lr_mod$cc_bold <- lr_mod$Q2.5_cc > 1 | lr_mod$Q97.5_cc < 1 

lr_mod$imp_bold <- lr_mod$Q2.5_imp > 1 | lr_mod$Q97.5_imp < 1 

lr_mod$str_cc <- text_spec(lr_mod$str_cc,"latex", bold = lr_mod$cc_bold)
lr_mod$str_imp <- text_spec(lr_mod$str_imp, "latex", bold = lr_mod$imp_bold)

kable(select(lr_mod,term,str_cc, str_imp), "latex", booktabs =T, 
      row.names = F, longtable = F, escape = F,caption = "Unadjusted and adjusted odds ratios of death by 28 days in sepsis from Bayesian logistic regression, for complete case analysis (CCA) and following multiple imputation of missing data." ,
        col.names = c("Variable", "CCA", "Imputed")) %>%
  add_header_above(c(" " = 1, "aOR (95% CrI)" = 2)) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header", "hold_position", "scale_down")) %>%
  pack_rows("Host Variables", 1,4, bold = F) %>% 
   pack_rows("Severity Variables", 5, 17, bold = F)  %>%
    pack_rows("Diagnosis", 18,21, bold = F) %>% 
   pack_rows("Treatment Received", 22, 26, bold = F)  %>%
  footnote(general = "CCA = Complete case analysis, BP = Blood pressure, GCS = Glasgow coma scale, BSI = Bloodstream infection, TB = tuberculosis.  All odds ratios are for as increase in the variables shown." , threeparttable = T, fixed_small_size = T) 

```



```{r pca-1, echo =F, warning=F, message=F, include = F, fig.scap="Dimensionalty reduction of variables in sepsis models using FAMD", out.extra='', fig.cap="Dimensionality reduction of dataset using factor analysis of mixed data (FAMD); this is a combination of principal components analysis (PCA) for continuous variables and multiple correspondence analysis (MCA) for categorical variables, resulting in a new orthogonal coordinate system which maximises explained variance in each FAMD axis. A and B show the squared correlation ratio (for categoriacal variables) and the squared correlation coefficient (for continuous variables) with dimensions 1 and 2 (A) or 1 and 3 (B), along wih the proportion of variance explained by each axis. C shows the location of all individuals in the FAMD space, with patients who died by 28 days coloured red to show that Dim.1 seems to be associated with mortality.", fig.width= 8, fig.height =8, out.height = '80%' , fig.align= 'center'}

df.mod.cc <- df.mod[complete.cases(df.mod),]

#FAMD(df.mod.cc, ncp =17,sup.var = c(2,19:27)) -> f

df.mod.cc$bc <- recode(df.mod.cc$bc, '0' = "No BSI", '1' = "BSI" )
df.mod.cc$tb <- recode(df.mod.cc$tb, '0' = "No TB", '1' = "TB" )
df.mod.cc$malaria <- recode(df.mod.cc$malaria, '0' = "No Malaria", '1' = "Malaria" )
df.mod.cc$csf <- recode(df.mod.cc$csf, '0' = "No Meningitis", '1' = "Meningitis" )

df.mod.cc$hivstatus <- recode(df.mod.cc$hivstatus, '0' = "HIV-", '1' = "HIV+" )
df.mod.cc$ptsex <- recode(df.mod.cc$ptsex, '0' = "Female", '1' = "Male" )
df.mod.cc$ustand <- recode(df.mod.cc$ustand, '0' = "Can stand", '1' = "Can't stand" )

FAMD(df.mod.cc, ncp =17,sup.var = c(2,19:23), graph = FALSE) -> f2

cbind(df.mod.cc,f2$ind$coord) -> d.complete2

fviz_famd_var(f2, axes = c(1,2), repel = TRUE, col.var.sup = NA, shape.var = 19) + theme_bw() + theme(plot.title = element_blank()) + ylim(c(-0.05,0.4)) + xlim(-0.05, 0.4)  -> p.1

fviz_famd_var(f2, axes = c(1,3), repel = TRUE, col.var.sup = NA, shape.var = 19) + theme_bw() + theme(plot.title = element_blank()) + ylim(c(-0.05,0.4)) + xlim(-0.05, 0.4) -> p.2
#fviz_famd_var(f2, axes = c(1,3), choice = "quanti.var", repel = TRUE, alpha.var = 0.5) + theme_bw() + theme(plot.title = element_blank())-> p.3
#fviz_famd_var(f2, axes = c(1,3), choice = "quali.var", repel = TRUE, alpha.var = 0.5)+ theme_bw() + theme(plot.title = element_blank()) -> p.4

ggplot(d.complete2, aes(Dim.1, Dim.2, color = d28_death)) + geom_point(alpha = 0.7) + theme_bw() + geom_hline(yintercept =0,linetype = "dashed", alpha = 0.7) + geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7) + scale_color_manual(labels = c("Survived", "Died"), values = c("grey", "red")) + theme(legend.title = element_blank()) -> p.5

ggplot(d.complete2, aes(Dim.3, Dim.4, color = d28_death)) + geom_point(alpha = 0.7) + theme_bw() + geom_hline(yintercept =0,linetype = "dashed", alpha = 0.7) + geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.7) + scale_color_manual(labels = c("Survived", "Died"), values = c("grey", "red")) + theme(legend.title = element_blank()) -> p.6

ggarrange(ggarrange(p.1,p.2,ncol = 2, nrow = 1, labels = c("A", "B")), 
          ggarrange(p.5,p.6, ncol = 2, nrow = 1, labels = c("C","D"),common.legend = TRUE, legend = "bottom"), 
          ncol = 1, nrow =2)





```

```{r famd-mods-contrib, echo = F, message = F, warning = F, fig.scap="Composition of FAMD variables", out.extra='', fig.cap="Composition of FAMD variables 1-4. FAMD uses both principal coordinate analysis (PCA) and mulyiple correspondence analysis (MCA) to generate new orthognal coordinate  A and D show projections of the origibal variables into the new PCA space to show, for example, that a higher haemoglobin is associated with smaller (more negative) values of FAMD dimension 1. B and F show the positions of the categorical variable values in MCA coordinate space. C-D and G-H show the composition of the FAMD dimensions 1-4 in terms of the untransformed variables. CO2 = serum bicarbnate, tb = diagnosis of tb  ", fig.width= 10, fig.height =10 , fig.align= 'center'}


FAMD(df.mod.cc, ncp =17,sup.var = c(2,19:23), graph = FALSE) -> f2
d <- df.mod.cc

names(d)[names(d) == "screentemp"] <- "temp"
names(d)[names(d) == "calc_age"] <- "age"
names(d)[names(d) == "t0map"] <- "MAP"
names(d)[names(d) == "t0hr"] <- "HR"
names(d)[names(d) == "t0rr"] <- "RR"
names(d)[names(d) == "ustand"] <- "Can't stand"
names(d)[names(d) == "hivstatus"] <- "HIV status"
names(d)[names(d) == "t0spo2"] <- "Sp02"
names(d)[names(d) == "lactate_value"] <- "Lactate"
names(d)[names(d) == "Haemoglobin"] <- "Hb"
names(d)[names(d) == "Platelets"] <- "Plt"
names(d)[names(d) == "Creatinine"] <- "Cr"
names(d)[names(d) == "tb"] <- "TB"
names(d)[names(d) == "csf"] <- "Meningitis"
names(d)[names(d) == "bsi"] <- "BSI"

FAMD(d, ncp =17,sup.var = c(2,19:23), graph = FALSE) -> f2.c


 fviz_contrib(f2.c, "var", axes  = 1, ggtheme = theme_bw(), top = 10) + ggtitle("Dim1") -> p.contib.1
fviz_famd_var(f2.c, "quanti.var", repel = TRUE, axes = c(1,2), alpha.var = 0.6) + ggtitle("") -> p.contib.quanti.1.2

fviz_famd_var(f2.c, "quali.var", repel = TRUE, axes = c(1,2), alpha.var = 0.6) + ggtitle("") -> p.contib.quali.1.2

fviz_famd_var(f2.c, "quanti.var", repel = TRUE, axes = c(3,4), alpha.var = 0.6) + ggtitle("") -> p.contib.quanti.3.4
fviz_famd_var(f2.c, "quali.var", repel = TRUE, axes = c(3,4), alpha.var = 0.6) + ggtitle("") + ylim(c(-0.5,0.5)) -> p.contib.quali.3.4

 fviz_contrib(f2.c, "var", axes  = 2, ggtheme = theme_bw(), top = 10) + ggtitle("Dim2")  -> p.contib.2
  fviz_contrib(f2.c, "var", axes  = 3, ggtheme = theme_bw(), top = 10)+ ggtitle("Dim3")  -> p.contib.3
   fviz_contrib(f2.c, "var", axes  = 4, ggtheme = theme_bw(), top = 10) + ggtitle("Dim4") -> p.contib.4
    fviz_contrib(f2.c, "var", axes  = 5, ggtheme = theme_bw(), top = 10) + ggtitle("Dim5") -> p.contib.5

    # this noeeds sorting out please
    
#    ggarrange(
#    ggarrange(ggarrange(p.contib.quali.1.2, p.contib.quanti.1.2, ncol = 2, nrow = 1), 
#              ggarrange(NULL, p.contib.1, p.contib.2, NULL, ncol = 4, nrow = 1, widths = c(0.3,1,1,0.3)),
#                        ncol = 1, nrow = 2, heights = c(1,0.6)),
#     ggarrange(ggarrange(p.contib.quali.3.4, p.contib.quanti.3.4, ncol = 2, nrow = 1), 
#              ggarrange(NULL, p.contib.3, p.contib.4, NULL, ncol = 4, nrow = 1, widths = c(0.3,1,1,0.3)),
#                        ncol = 1, nrow = 2, heights = c(1,0.6)),
#    ncol = 1, nrow = 2)
    
    
    ggarrange(
    ggarrange(p.contib.quanti.1.2, p.contib.quali.1.2, p.contib.quanti.3.4, p.contib.quali.3.4, ncol = 2, nrow = 2, labels = c("A","B","E", "F")),
    ggarrange(p.contib.1, p.contib.2, p.contib.3, p.contib.4, ncol = 1, nrow = 4, labels  = c("C", "D", "G", "H")), ncol =2, nrow = 1, widths = c(1,0.4))
    
#ggarrange(ggarrange( p.contib.quanti.1.2,
##                    ggarrange(p.contib.1, p.contib.2,ncol = 1, nrow = 2, labels = c("B","C")), ncol = 2, nrow = 1,
#                    widths = c(1.5,1), labels = c("A", NA)), 
#          ggarrange(p.contib.quanti.3.4,
#                    ggarrange(p.contib.3, p.contib.4,ncol = 1, nrow = 2, labels = c("E","F")), ncol = 2, nrow = 1, widths = c(1.5,1), labels = c("D", NA)),
   #       ncol = 1, nrow = 2)

    
    
```

```{r mort-assoc-famd, echo = F, warning = F, message = F, fig.scap="Association of FAMD dimensions with mortality", out.extra='', fig.cap="Individuals plotted in FAMD space projected onto FAMD dimensions 1 and 2 (A) or 3 and 4 (B) with patients who died by 28 days coloured red. There is an apparent correlation between higher values of FAMD dimensions 1 and perhaps 2 with death (more red points in the upper right quadrant)", fig.width= 8, fig.height =3,  , fig.align= 'center'}

          ggarrange(p.5,p.6, ncol = 2, nrow = 1, labels = c("A","B"))

```



```{r famd-mods-res, echo =F, warning=F, message=F, fig.scap="Modelling effects of treatments on death in sepsis following dimensionality reduction.", out.extra='', fig.cap="Modelling the effect of reciept of different treatments following dimensionality reduction with factor analysis of mixed data (FAMD). A (Top) shows parameter estimates for treatment variables only from the original imputed model using all raw covariate values. Models 1-5 use the first 1,2,3,4 or 5 transformed dimensions from FAMD. Parameter estimates and inferences are essentially unchanged, though there is less uncertainty generally in the estimates from the FAMD models. This would be expected as fewer parameters with less collinearity, are used. B (bottom) shows the estimated ELPD (expected log predictive denisty) from leave-one out cross validation from all the models, along with the standard error of the estimate. This is a measure of out of sample predictive accuracy: bigger (less negative) is better. One of the concerns of the original model is that it is overfit and so would have poor ELPD. In absolute terms this is true but the magnitude of the difference is much less than the standard error, meaning that out of sample prediction for all the models is broadly similar, giving confidence in the original model inferences.", fig.width= 5, fig.height =6, out.width = '70%' , fig.align= 'center'}

readRDS("chapter_4/brms_fit_famd1.rda") -> m.famd1
readRDS("chapter_4/brms_fit_famd2.rda") -> m.famd2
readRDS("chapter_4/brms_fit_famd3.rda") -> m.famd3
readRDS("chapter_4/brms_fit_famd4.rda") -> m.famd4
readRDS("chapter_4/brms_fit_famd5.rda") -> m.famd5

as.data.frame(exp(fixef(m.famd5))) -> m5
m5$str_m5 <- glue('{specify_decimal(m5$Estimate,2)} ({specify_decimal(m5$Q2.5,2)}-{specify_decimal(m5$Q97.5,2)})')

m5$term <- rownames(m5)
m5$model <- "5"

as.data.frame(exp(fixef(m.famd4))) -> m4
m4$str_m4 <- glue('{specify_decimal(m4$Estimate,2)} ({specify_decimal(m4$Q2.5,2)}-{specify_decimal(m4$Q97.5,2)})')
m4$term <- rownames(m4)
m4$model <- "4"

as.data.frame(exp(fixef(m.famd3))) -> m3
m3$str_m3 <- glue('{specify_decimal(m3$Estimate,2)} ({specify_decimal(m3$Q2.5,2)}-{specify_decimal(m3$Q97.5,2)})')
m3$term <- rownames(m3)
m3$model <- "3"


as.data.frame(exp(fixef(m.famd2))) -> m2
m2$str_m2 <- glue('{specify_decimal(m2$Estimate,2)} ({specify_decimal(m2$Q2.5,2)}-{specify_decimal(m2$Q97.5,2)})')
m2$term <- rownames(m2)

m2$model <- "2"

as.data.frame(exp(fixef(m.famd1))) -> m1
m1$str_m1 <- glue('{specify_decimal(m1$Estimate,2)} ({specify_decimal(m1$Q2.5,2)}-{specify_decimal(m1$Q97.5,2)})')
m1$term <- rownames(m1)
m1$model <- "1"

imp.parms <- filter(imp.parms, term != "Intercept")
imp.parms$str_imp <- glue('{specify_decimal(exp(imp.parms$Estimate_imp),2)} ({specify_decimal(exp(imp.parms$Q2.5_imp),2)}-{specify_decimal(exp(imp.parms$Q97.5_imp),2)})')


imp.parms <- filter(imp.parms, term %in% c("any_fung_rx1",
                                           "any_mal_rx1",
                                           "any_ab1",
                                           "any_tb_rx1",
                                           "fluid_6hr") )

imp.parms$model <- "Original"
sub("_imp", "", names(imp.parms)) -> names(imp.parms)
imp.parms[1:4] <- exp(imp.parms[1:4] )

mod_parms <- bind_rows(
  m5,m4,m3,m2,m1,imp.parms
)

recode_factor(mod_parms$term, any_tb_rx1 = "TB treatment",
              any_mal_rx1 = "Malaria treatment",
              any_fung_rx1 = "Antifungal treatment",
              any_ab1 = "Antibacterial treatment",
              fluid_6hr = "IV fluid (per L)",
              Dim.1 = "famd.1",
              Dim.2 = "famd.2",
              Dim.3 = "famd.3",
              Dim.4 = "famd.4",
              Dim.5 = "famd.5") -> mod_parms$term

ggplot(filter(mod_parms,term != "Intercept"), aes(fct_rev(term), Estimate,
color = model,
ymin = `Q2.5`,
ymax = `Q97.5`))+
geom_hline(yintercept = 1, linetype = "dashed")  +
geom_point(position = position_dodge(width = 0.9)) +
geom_errorbar(width = 0, position  = position_dodge(width = 0.9)) +
coord_flip(ylim = c(0,5)) +
theme_bw()+ scale_color_manual(values = c(brewer.pal(n=6, "Blues")[2:6], brewer.pal(n=3, "Set1")[1]), breaks = c("Original","5","4", "3", "2", "1"), name = "Model") + ylab("aOR (95% CrI)") + xlab("Parameter") -> p1

# get standard error estimates

readRDS("chapter_4/brms_fit_famd1_loo.rda") -> m.famd1.loo
readRDS("chapter_4/brms_fit_famd2_loo.rda") -> m.famd2.loo
readRDS("chapter_4/brms_fit_famd3_loo.rda") -> m.famd3.loo
readRDS("chapter_4/brms_fit_famd4_loo.rda") -> m.famd4.loo
readRDS("chapter_4/brms_fit_famd5_loo.rda") -> m.famd5.loo
readRDS("chapter_4/brms_orig_data_cca_loo.rda") -> loo.m.b.cc


as.data.frame(m.famd1.loo$estimates) -> famd1.est
famd1.est$model <- "1"
famd1.est$var <- rownames(famd1.est)

as.data.frame(m.famd2.loo$estimates) -> famd2.est
famd2.est$model <- "2"
famd2.est$var <- rownames(famd2.est)

as.data.frame(m.famd3.loo$estimates) -> famd3.est
famd3.est$model <- "3"
famd3.est$var <- rownames(famd3.est)

as.data.frame(m.famd4.loo$estimates) -> famd4.est
famd4.est$model <- "4"
famd4.est$var <- rownames(famd4.est)

as.data.frame(m.famd5.loo$estimates) -> famd5.est
famd5.est$model <- "5"
famd5.est$var <- rownames(famd5.est)

as.data.frame(loo.m.b.cc$estimates) -> orig.est
orig.est$model <- "Original"
orig.est$var <- rownames(orig.est)

elpd.loo <- bind_rows(famd1.est, famd2.est, famd3.est, famd4.est, famd5.est, orig.est)
elpd.loo <- subset(elpd.loo, var == "elpd_loo" )

elpd.loo$model <- factor(elpd.loo$model, levels = c("Original", 1:5))

ggplot(elpd.loo, aes(model, Estimate, ymin = Estimate - (SE), ymax = Estimate + (SE))) + geom_point() + geom_errorbar(width = 0) + theme_bw() + xlab("Number of FAMD dimensions in model") +ylab("ELPD_loo") -> p2

ggarrange(p1,p2, ncol= 1, nrow = 2, heights = c(2,1), labels = c("A", "B"))


```

Graphically, FAMD dimensions one (and perhaps two) appeared to show an association with mortality (Figure \@ref(fig:mort-assoc-famd)), which was confirmed on logistic regression modelling. The first 5 FAMD dimensions were used to fit models predictive of death by 28 days, along with untransformed treatment variables; the primary interest here was to see if the apparent effect of treatment administered would change under these models. Five models were fit using one, two, three, four or five FAMD dimensions; parameter estimates from these models are shown in Figure \@ref(fig:famd-mods-res)A, along with the parameter estimates form the original model using all, untransformed, parameters. Parameter estimates from treatment variables were largely unchanged across, though uncertainty was markedly increased in the original models. Nevertheless, inferences were largely unchanged: we can be confident only that the odds ratio of the effect of TB treatment is different to zero. FAMD dimensions one was strongly associated with mortality; FAMD dimensions two and three less so. FAMD dimensions 4 and 5 showed no convincing assocition; in fact, FAMD dimension 4 seemed, if anything, protective, though 95% credible intervals of odds ratios crossed 1.

The out-of-sample predictive ability of the models was assessed using the expected log predictive density (ELPD) estimate form leave one out cross validation. In absolute terms, all FAMD models greater ELPD than the original model but any differences were small compared to the standard error of the ELPD estimate. We can not be confident that any model has different out of sample predictive accuracy and therefore can be as confident in the parameter estimates form the original (untransformed) model as any other.

### Exploring time-to antibacterials and IV fluid as determinants of mortality

Exploration of bivariate associations of mortality with time to antimicrobials and volume of intravenous fluid received are shown in Figure \@ref(fig:univ-mort-assc-plots), where LOESS moving linear regression provides a nonparametric estimate of probability of death by 28 days as a function of treatment variables. Time to antimalarial therapy is not shown in this plot as no patient who received antimalarial therapy died. Volume of intravenous fluid administered has no apparent effect on 28 day mortality (Figure \@ref(fig:univ-mort-assc-plots)A). It might be expected that any effect would be most apparent in participants with shock: stratifying the analysis by shock (defined as mean arterial blood pressure below 75mmHg, Figure \@ref(fig:univ-mort-assc-plots)B) once again showed no apparent relationship.  Neither time to antimycobacterial or antifungal therapy showed any apparent association though confidence intervals are wide (Figures \@ref(fig:univ-mort-assc-plots)C and D).

There was no apparent relationship between time to antibacterials and 28 day mortality up to around 40 hours, when there was a suggestion of an increased probability of death (Figure \@ref(fig:univ-mort-assc-plots)E). To explore this further, I used a logistic regression analysis, including only patients who received antibacterials (n = 207) using both linear models, fitted in a Bayesian framework as before (and following imputation of missing data), and, in view of a possible nonlinear effect, second order polynomial models. Model three from the analysis above was used (incorporating the first three FAMD dimensions), as the best fitting model. The estimates of the coefficients of the linear model is shown in Table \@ref(tab:tta-tabs) and the predicted probability of death by 28 days shown in Figure \@ref(fig:univ-mort-assc-plots). In both cases it is not possible to fully rule in or out an effect of antibacterial delay. The 95% credible interval of the adjusted odds ratio for death per hour of antibacterial delay from the linear model crossed one (aOR 1.01 95% [CrI 0.98-1.04]) though incorporated a clinically relevant effect size, and the uncertainty in predictions from the polynomial of a late nonlinear effect of antibacterial delay are so wide that it is not possible to draw any conclusions.

```{r univ-mort-assc-plots, echo =F, warning=F, message=F,fig.scap="Modelling associations of time to antimicrobials and death by 28 days in sepsis", out.extra='', fig.cap="Associations of IV fliud volume and time-to-antimicrobials with death by 28 days.  A-E show nonparametric regression (LOESS) of outcome (with death coded as 1 for died and 0 for survived) against various covariates; the regression line can be interpreted as the probability of death by 28 days and can be used to assess for a bivariate relationship and also the nature of any relationship (i.e. linear versus nonlinear). A: IV fluid (L), B: IV fluid stratified by presence or absence of shock (defined as MAP < 75mmHg), C: Time to antimycobacterials, D: Time to antifungals E: Time to antibacterials, with a possible late, nonlinear relationship. F: Models of time-to-antimicrobials as a predictor of mortality considering time-to-antibacterials to have a linear or second order polynomial effect. In both cases the uncertainty in the effect is such that there is no convincing relationship. Overall, there is no convincing relationship between any of these variables and death by 28 days.", fig.width= 7, fig.height =7 , out.height='60%', fig.align = 'center'}


 ggplot(df.temp, aes(fluid_6hr, as.numeric(d28_death))) + geom_point() + geom_smooth(color = "black", size = 0.5) + theme_bw() + xlab("IV fluid (L)") + ylab("Pr(death by 28 days)") + coord_cartesian(ylim = c(0,1)) -> fluid1 

 ggplot(subset(df.temp, !is.na(t0map)), aes(fluid_6hr, as.numeric(d28_death), color = t0map < 75, group = t0map < 75)) + geom_point() + geom_smooth(size = 0.5) + theme_bw() + xlab("IV fluid (L)") + ylab("Pr(death by 28 days)") + scale_color_discrete(labels = c("MAP > 75mmHg", "MAP < 75mmHg")) + theme(legend.title = element_blank(), legend.position = "right") + coord_cartesian(ylim = c(0,1)) -> fluid2 

 ggplot(subset(df.temp, !is.na(t0map)), aes(time_to_abx, as.numeric(d28_death))) + geom_point() + geom_smooth(color = "black", size = 0.5) + theme_bw() + coord_cartesian(ylim = c(-0,1)) + xlab("Time to antibacterial (hr)") + ylab("Pr(death by 28 days)")-> t_to_ab

 ggplot(subset(df.temp, !is.na(t0map)), aes(time_to_abx, as.numeric(d28_death))) + geom_point() + geom_smooth(color = "black", size = 0.5) + theme_bw() + coord_cartesian(ylim = c(-0,1), xlim = c(0,24)) + xlab("Time to antibacterial (hr)") + ylab("Pr(death by 28 days)")-> t_to_ab2



 #ggplot(df.temp, aes(time_to_abx, as.numeric(d28_death), color = t0map < 75, group = t0map < 75)) + geom_point() + geom_smooth() + theme_bw()-> t_to_ab2

 ggplot(df.temp, aes(time_to_tb_rx, as.numeric(d28_death))) + geom_point() + geom_smooth(color = "black", size = 0.5) + theme_bw() + xlab("Time to antimycobacterial (hr)") + ylab("Pr(death by 28 days)") + coord_cartesian(ylim = c(-0,1))-> t_to_tb

 ggplot(df.temp, aes(time_to_mal_rx, as.numeric(d28_death))) + geom_point() + geom_smooth(color = "black", size = 0.5) + theme_bw() + xlab("Time to antimalarial (hr)") + ylab("Pr(death by 28 days)") + coord_cartesian(ylim = c(-0,1))-> t_to_mal

 ggplot(df.temp, aes(time_to_fung_rx, as.numeric(d28_death))) + geom_point() + geom_smooth(color = "black", size = 0.5) + theme_bw() + xlab("Time to antifungal (hr)") + ylab("Pr(death by 28 days)") + coord_cartesian(xlim = c(0,120), ylim = c(-0,1))-> t_to_fung

 
 ## get mods
 
 readRDS("chapter_4/tta.imp.mod.rda") -> m.tta.imp
 readRDS("chapter_4/tta.imp.mod.poly.rda") -> m.poly
 
 
marginal_effects(m.tta.imp, effects = "time_to_abx")$time_to_abx ->  me.lin
marginal_effects(m.poly, effects = "time_to_abx")$time_to_abx ->  me.poly


me.lin$regression <- "Linear"
me.poly$regression <- "Polynomial"

me.all <- bind_rows(
  me.lin,
  me.poly,
)

ggplot(me.all, aes(time_to_abx, estimate__, ymin = lower__, ymax = upper__, color = regression, fill = regression )) +
  geom_line() + 
  geom_ribbon(alpha = 0.3, color = NA) +
  theme_bw() + 
  xlab("Time to antibacterials (hrs)") + 
  ylab("Pr(Death by 28 days)") +
  theme(legend.title = element_blank()) -> tta.mods
 
 ggarrange(
   ggarrange(fluid1, fluid2, widths = c(1, 1.3), ncol = 2, labels = c("A", "B")), 
   ggarrange(t_to_tb, t_to_fung, NULL, labels = c("C", "D"), ncol = 3,widths= c(1,1,0.4)),
   ggarrange(t_to_ab, tta.mods, NULL, ncol = 3, labels = c("E", "F"), widths = c(1,1.3, 0.08)), 
   ncol = 1, nrow = 3)
 
```

```{r tta-tabs, echo =F, warning=F, message=F,}


as.data.frame(exp(fixef(m.tta.imp))) -> tta.tab
tta.tab$str <-  glue('{specify_decimal(tta.tab$Estimate,2)} ({specify_decimal(tta.tab$Q2.5,2)}-{specify_decimal(tta.tab$Q97.5,2)})')
tta.tab$term <- rownames(tta.tab)

tta.tab$term[tta.tab$term == "any_fung_rx1"] <- "Received antifungal (vs none)"
tta.tab$term[tta.tab$term == "any_mal_rx1"] <- "Received antimalarial (vs none)"
tta.tab$term[tta.tab$term == "any_tb_rx1"] <- "Received antimycobacterial (vs none)"

tta.tab$term[tta.tab$term == "fluid_6hr"] <- "IV fluid (per L)"

tta.tab$term[tta.tab$term == "Dim.1"] <- "famd.1"
tta.tab$term[tta.tab$term == "Dim.2"] <- "famd.2"
tta.tab$term[tta.tab$term == "Dim.3"] <- "famd.3"

tta.tab$term[tta.tab$term == "time_to_abx"] <- "Time to antibacterials (per hour)"

tta.tab[c(9:5,2:4),] -> tta.tab

kable(select(tta.tab, term, str), "latex", booktabs =T, 
      row.names = F, longtable = FALSE, ,escape = F,caption = "Adjusted odds ratio of death by 28 days per hour delay in antibacterials" ,
        col.names = c("Variable", "aOR (95\\% CrI)")) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  footnote(general = "The variables famd1,2 and 3 are the three transformed dimensions following dimensionality reduction using factor analysis of mixed data that account for the most variability in the dataset." , threeparttable = T, fixed_small_size = T) 

```

### Propensity score matching and subgroup analysis

Finally, I used propensity score matching, a different method to attempt to generate unbiased estimates of the effect of receipt of TB therapy on mortality. First I examined bivariate associations of receipt of TB therapy (Table \@ref(tab:bivariate-sev-tb-rx) in the chapter appendix). Patients who received TB therapy were almost all HIV-infected (88% [46/52] vs 60% [95/161] in the no-TB therapy group, p < 0.001) with lower CD4 count (median 60 vs 123 cells $\mu$L\textsuperscript{-1}, p = 0.006) and Haemoglobin (median 9.7 vs 11.1 g dL\textsuperscript{-1}), and received more antimalarials (11% [6/53] vs 3% [6/172], p = 0.037) and IV fluids (median 1.5L vs 1.2L, p= 0.02), though most of these associations would be expected to pull an estimate of the mortality effect of TB therapy towards the null, rather than inflate an effect size. More patients with a positive diagnostic test for TB received TB therapy, as might be expected (53% [28/53] of those receiving TB therapy had a positive diagnostic test for TB, versus 28% [48/172] not receiving therapy, p = 0.001), though almost all the TB treatment was empiric, as the treating clinicians did not have access to urinary LAM results (which were batch processed on frozen urines) or mycobacterial blood culture results (which take up to 6 weeks to become positive). 

Factors associated with receipt of TB therapy (HIV status, CD4 count, diagnosis of TB, receipt of antimalarial therapy and volume of IV fluid received) and factors associated with mortality from the models presented above (haemoglobin, respiratory rate, oxygen saturation,  inability to stand, bloodstream infection and diagnosis of malaria) were used as predictors in a logistic regression to predict receipt of TB therapy. Predictions from this model were used to generate a propensity score for each participant, and then each participant who received TB therapy was matched with one participant who did not to generate a new cohort, with better matching of covariates (Figure \@ref(fig:var-match-plots)). The propensity-score adjusted risk ratio of survival to 28 days in this cohort upon receipt of TB therapy was 1.25 (95% CI 1.04-1.51), similar to the unadjusted estimate (Figure \@ref(fig:mort-strat-tb-and-tb-rx)). Mortality benefit seemed higher in the immunosuppressed and anaemic in absolute terms, though with significant uncertainty in the estimates (\@ref(fig:mort-strat-tb-and-tb-rx)): RR 1.56 (95% CI 1.04-2.24) in those with haemoglobin below 8g dL$^{-1}$ compared to 1.11 (95% CI 0.92-1.34) above 8g dL$^{-1}$.

```{r mort-strat-tb-and-tb-rx, echo =F, warning=F, message=F,fig.scap="Propenisty-score matched and subgroup analysis of effect of TB therapy on mortality.", out.extra='', fig.cap="Subgroup analysis of effect of TB therapy on mortality. A (Top) shows crude (unadjusted) risk ratio for survival to 28 days; RR > 1 favours TB therapy, RR < 1 favours no TB therapy. A significant effect is seen in the immunosupressed, anaemic, and to a lesser extent, those with a confirmed diagnosis of TB. B (Bottom) shows the same analysis for the propensity-score matched cohort, showing that the overall and subgroup effects are essentially unchanged.", fig.width=4 , fig.height =4  , fig.align = 'center'}

df.for <- df.temp

df.for$CD.50 <- df.for$CD4_Absolute < 50
df.for$CD.100 <- df.for$CD4_Absolute < 100
df.for$CD.150 <- df.for$CD4_Absolute < 200

df.for$Hb.7 <- df.for$Haemoglobin < 8
df.for$Hb.9 <- df.for$Haemoglobin < 9

df.for %>% dplyr::select(d28_death, any_tb_rx, CD.100, Hb.7, tb) %>%
  pivot_longer(-c(d28_death, any_tb_rx)) %>% group_by(name,value, any_tb_rx) %>%
  summarise(died = sum(d28_death == 1, na.rm = T), survived = sum(d28_death == 0, na.rm = T)) %>%
  filter(!is.na(value )) %>% ungroup() %>%
  mutate(str = paste0(name,value)) %>% group_by(str) %>%
  mutate(pval = fisher.test(matrix(c(died, survived), ncol =2))$p.value,
         or = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,1],
         lci = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,2],
         uci = riskratio.small(matrix(c(died, survived), ncol =2))$measure[2,3]) -> t2

t2 %>% ungroup() %>% dplyr::select(name, value, or,lci, uci) %>% unique -> t2

df.for %>% dplyr::select(d28_death, any_tb_rx) %>% group_by(any_tb_rx) %>% 
  summarise(died = sum(d28_death == 1, na.rm = T), survived = sum(d28_death == 0, na.rm = T)) %>%
   ungroup() %>%
  mutate(str = "all", name = "all", value = 1) %>%
  mutate(pval = fisher.test(matrix(c(died, survived), ncol =2))$p.value,
         or = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,1],
         lci = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,2],
         uci = riskratio.small(matrix(c(died, survived), ncol =2))$measure[2,3]) -> t3

t3 %>% ungroup() %>% select(name, value, or,lci, uci) %>% unique -> t3

t2 <- bind_rows(t2,t3)

t2 <- t2[c(6,5,4,3,2,1,7),]
t2$str <- rev(c(1,3,4,6,7,9,10 ))
labelz <- c("All", "CD4 > 100" ,"CD4 < 100",
            "Hb >8", "Hb < 8","No TB diagnosis", "TB diagnosis")

ggplot(t2, aes(str, or, ymin = lci, ymax = uci)) + geom_point() + 
  geom_errorbar(width = 0) + coord_flip(ylim = c(0.8,2.5)) + theme_bw() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  scale_x_continuous(breaks = c(1,3,4,6,7,9,10),  labels = labelz) +
  theme(panel.grid.major.y = element_blank()) + ylab("Risk ratio of survival: TB treatment") + xlab("") -> unadj


## 

df.temp$CD4.dic <- as.numeric(df.temp$CD4_Absolute < 100)
df.temp$CD4.dic[is.na(df.temp$CD4.dic)] <- 0

prs.df <- select(df.temp, d28_death, any_tb_rx,Haemoglobin, hivstatus, t0rr,t0spo2,ustand, Urea,bc ,tb ,csf ,malaria, CD4.dic, any_mal_rx, fluid_6hr, CD4_Absolute)

c.caserows <- complete.cases(prs.df[-16])

prs.df.cc <- prs.df[complete.cases(prs.df[-16]),]

prs.df.cc[-16] -> prs.df.cc



mod_match <- matchit(any_tb_rx ~ Haemoglobin + hivstatus + CD4.dic + t0rr + t0spo2 + ustand + bc + tb + csf + malaria + Urea + any_mal_rx + fluid_6hr,
                     method = "nearest", data = prs.df.cc, ratio = 1)

match.data(mod_match) -> match.data

match.data$Hb.dic <- as.numeric(match.data$Haemoglobin < 8)

match.data %>% dplyr::select(d28_death, CD4.dic, Hb.dic, tb, any_tb_rx) %>%
    pivot_longer(-c(d28_death, any_tb_rx)) %>% group_by(name,value, any_tb_rx) %>%
    summarise(died = sum(d28_death == 1, na.rm = T), survived = sum(d28_death == 0, na.rm = T)) %>%
    filter(!is.na(value )) %>% ungroup() %>%
    mutate(str = paste0(name,value)) %>% group_by(str) %>%
    mutate(pval = fisher.test(matrix(c(died, survived), ncol =2))$p.value,
           or = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,1],
           lci = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,2],
           uci = riskratio.small(matrix(c(died, survived), ncol =2))$measure[2,3]) ->  t4

t4 %>% ungroup() %>% dplyr::select(name, value, or,lci, uci) %>% unique -> t4

match.data %>% dplyr::select(d28_death, any_tb_rx) %>% group_by(any_tb_rx) %>% 
  summarise(died = sum(d28_death == 1, na.rm = T), survived = sum(d28_death == 0, na.rm = T)) %>%
   ungroup() %>%
  mutate(str = "all", name = "all", value = 1) %>%
  mutate(pval = fisher.test(matrix(c(died, survived), ncol =2))$p.value,
         or = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,1],
         lci = riskratio.small(matrix(c(died, survived), ncol = 2))$measure[2,2],
         uci = riskratio.small(matrix(c(died, survived), ncol =2))$measure[2,3]) -> t5

t5 %>% ungroup() %>% select(name, value, or,lci, uci) %>% unique -> t5
t4 <- bind_rows(t4,t5)


t4 <- t4[c(6,5,4,3,2,1,7),]
t4$str <- rev(c(1,3,4,6,7,9,10 ))
labelz <- c("All", "CD4 > 100" ,"CD4 < 100",
            "Hb >8", "Hb < 8","No TB diagnosis", "TB diagnosis")

ggplot(t4, aes(str, or, ymin = lci, ymax = uci)) + geom_point() + 
  geom_errorbar(width = 0) + coord_flip(ylim = c(0.8,2.5)) + theme_bw() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  scale_x_continuous(breaks = c(1,3,4,6,7,9,10),  labels = labelz) +
  theme(panel.grid.major.y = element_blank()) + ylab("Risk ratio of survival: TB treatment") + xlab("") -> prop.sc

ggarrange(unadj, prop.sc, ncol = 1, nrow = 2, labels = c("A", "B"))

```

## Discussion

I have presented, in this chapter, an analysis using a number of statistical techniques to further explore the associations of mortality in this cohort, and to address the difficulties encountered with the modelling strategies presented in Chapter 3. In addition I have presented an explicit hypothesised causal structure of death to facilitate a causal interpretation of the model parameters. In Chapter 3, maximum likelihood fitting of logistic regression models was likely biased because some predictors were perfectly associated with outcome, and were excluded - the phenomenon of separation. This was overcome using Bayesian logistic regression with weakly informative priors. As expected, malaria and meningitis were strongly associated with survival and death, respectively, but more importantly inferences from the model were largely unchanged once these strong predictors were included in the model. The strongly protective effect of TB therapy persisted. Unexpectedly, bloodstream infection showed a protective effect; given _S._ Typhi was the commonest bloodstream infection isolate, which is associated with a low mortality in the Blantyre context (2.5% since 2011[@Feasey2015a]), this is certainly plausible.

To address the concern that a model with so many parameters might be overfit, I performed dimensionality reduction with FAMD and refit the models using transformed predictor variables. As might be expected in absolute terms the out of sample predictive accuracy (as measured by ELPD) improved, but by an amount much less than the error in the estimation of ELPD. This supports the inferences from the original model. In addition, the composition of the transformed FAMD variables provides some insight into the presentation of sepsis in Blantyre. Though the situation is clearly complex, the composition of the FAMD variables seems to suggest a number of different organ dysfunction syndromes: shock with HIV immunosupression (FAMD axis one); renal failure with low oxygen saturations (FAMD axis two); low GCS with high white cell count (FAMD axid three); and tachycaria and fever with young age (FAMD axis four). FAMD axes one is strongly associated with death, and FAMD axes two and three more weakly associated. *** collinearity of variables justifies this approach and confirms what we know about sepsis - organ dysfunction = bad, but seems to be more in the HIV infected - true effect of HIV would not necessarily correct for severity as these are mediator variable ?? ***

As described in Chapter 3, time-to-antibacterials is thought to be one of the major modifiable determinants of death in sepsis in high-income settings, but in a crude (unadjusted) analysis there was no signal that this was the case in this cohort. I have expanded that analysis here, and adjusted for putative confounders, but the findings are unchanged. Fitting a logistic regression model and modelling time-to-antibacterials with a linear effect (and adjusting for confounders) found an adjusted odds ratio of 1.01 for death per hour delay with a 95% credible interval (95% CrI 0.98 - 1.04) that includes a clinically relevant effect size (i.e. the aOR of 1.04 [1.02-1.05] from the large observational study of sepsis care in New York[@Seymour2017]). There was a some suggestion from the raw data that a lengthy delay in antibacterials could be associated with an increase in mortality, perhaps with a late nonlinear effect; however the estimates from a nonlinear (second order polynomial) model had such high uncertainty that it is not possible to draw any firm conclusions. The analysis I present here, therefore, is consistent both with time-to-antibacterials having a similar effect on outcome as in high-income settings, and with no effect. Larger studies would be needed to distinguish these two scenarios. Similarly, uncertainties in estimates of effect of IV fluid administration are such that the estimates could contain a clinically relevant effect, and the analysis presented here does not advance the conclusions drawn in Chapter 3.

The protective effect of TB therapy remains significant and robust to correction for the putative confounders included in the analyses presented here. Using two techniques - logistic regression and propensity score matching - results in the same conclusions: that receipt of TB therapy was associated with survival in this cohort. The effect size of receipt of TB therapy (aOR 0.17 (0.03-0.74) is greater than the effect of antibacterial delay, even in high income settings, highlighting the fact that determinants of mortality in sepsis are likely to be different in sSA. Subgroup analysis found that the effect is perhaps driven by a mortality benefit in the immunosuppressed and/or anaemic, and the effect size in these subgroups was greater than in those with a diagnosis of TB, albeit with wide confidence intervals. If true, this would suggest that there is a benefit to empiric TB therapy outside those in whom a diagnosis of TB has been made in this study, and could contribute to the equipoise needed to consider clinical trials of empiric TB therapy in sepsis in sSA. This tentative suggestion (numbers are small and confidence intervals wide) is dependent on the diagnostic accuracy of any tests used; the recently developed fujiLAM urinary LAM test shows significantly higher sensitivity than the Alere LAM test used here, which could negate the benefit of empiric TB therapy, but would in turn present a powerful point of care triage tool that would permit targeted treatment of disseminated tuberculosis at presentation.

### Limitations

I have used a number of techniques to account for confounding, but this will only address the included variables; it is very likely that there are unmeasured confounders, and these could seriously bias the conclusions drawn. This is certainly possible, but any confounder that acted to produce a spurious association between TB therapy and survival would have to be associated with both TB therapy and survival. It seems likely that the clinicians looking after the participants in this study would be more likely to treat sicker patients with TB therapy, and produce bias in the opposite direction. Nevertheless, unmeasured confounders are just that - unmeasured - and it is not possible to address this question with the data here, though this is of course true of any similar study. Given that almost all the participants who received TB therapy were HIV-infected, all conclusions regarding this should be largely be applied to people living with HIV; it is not clear (and perhaps unlikely) that the associations described here would also be present in the HIV-uninfected.

I have made an attempt to put the modelling here in the framework of causal inference. If the hypothesised causal framework presented above was right and I had truly adjusted for all confounders, then the estimates of effect I present would be true causal effects. In fact this is unlikely: both because of unmeasured confounders, and that the causal pathways I have hypothesised are almost certainly a vast oversimplification. I have made choices about inclusion of variables both in the logistic regression and propensity score analysis which could also introduce bias.

## Conclusions and further work

In conclusion, the findings from the modelling work in Chapter 3 are largely unchanged when the models are expanded to address possible bias from excluding parameters due to separation, missing data bias, and overfitting. Malaria and meningitis are strongly associated with survival to and death by 28 days respectively; BSI seems to be associated with survival to 28 days. The association of receipt of TB therapy with survival persists, and is greater in those who are anaemic and immunosuppressed. This is a finding that deserves further exploration; the place of early TB therapy in the treatment of HIV-infected participants with sepsis is unknown, but the data presented here may contribute to the equipoise needed for clinical trials. 

## Appendix

Below I show bivariable associations of receipt of TB therapy and variable distributions of the propensity-score matched cohort. 

```{r bivariate-sev-tb-rx, echo =F, warning=F, message=F}

#df.temp$fluid_6hr <- df.temp$fluid_6hr / 1000

df.temp %>% select(-c(hivstatus, ptsex, ustand, hivonart, any_ab, any_fung_rx, any_mal_rx, malaria,  no_diagnosis, csf, bc, tb, pid, d28_death, time_to_tb_rx)) %>% pivot_longer(-any_tb_rx) %>% #filter(!is.na(d28_death)) %>%
  dplyr::group_by(name) %>% dplyr::summarise(pval = kruskal.test(value ~ any_tb_rx)$p.value) -> pvals.tb

df.temp %>% select(-c(hivstatus, ptsex, ustand, hivonart, any_ab, any_fung_rx, any_mal_rx,tb, no_diagnosis, csf, bc, malaria, pid,tb, d28_death, time_to_tb_rx)) %>% pivot_longer(-any_tb_rx) %>% # filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, any_tb_rx) %>% dplyr::summarise( median = median(value, na.rm = T),
                                                             LQ = quantile(value, 0.25, na.rm = T),
                                                              UQ = quantile(value, 0.75, na.rm = T)) -> p.tb



paste0(
  specify_decimal(p.tb$median, 1), " (",
  specify_decimal(p.tb$LQ, 1), "-",
  specify_decimal(p.tb$UQ, 1) ,")"
) -> p.tb$med_str

p.tb %>% select(name, any_tb_rx, med_str) %>% pivot_wider(names_from = any_tb_rx, values_from = med_str) -> p.tb

p.tb <- merge(p.tb, pvals.tb, all.x = T)


df.temp %>% dplyr::select( hivstatus, hivonart, ptsex, ustand, any_ab, any_fung_rx, any_mal_rx, any_tb_rx, bc, tb, malaria, csf, no_diagnosis) %>% pivot_longer(-any_tb_rx) %>% #filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, value) %>%
  dplyr::summarise(tb_rx = sum(any_tb_rx == 1, na.rm = T), no_tb_rx = sum(any_tb_rx == 0, na.rm = T)) %>% filter(!is.na(value)) %>% group_by(name) %>%
   group_by(name) %>% dplyr::summarise(pval = fisher.test(matrix(c(tb_rx, no_tb_rx), ncol =2))$p.value) -> p.catpvals.tb

df.temp %>% dplyr::select(hivstatus, hivonart, ptsex, ustand, any_ab, any_fung_rx, any_mal_rx, any_tb_rx, bc, tb, malaria, csf, no_diagnosis) %>% pivot_longer(-any_tb_rx) %>% # %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, any_tb_rx) %>% dplyr::summarise(`1` = sum(value == 1, na.rm = T), 
                                                        total = sum(!is.na(value)),
                                                        prop = `1`/total) -> p.cat.tb

p.cat.tb$str <- paste0(
  p.cat.tb$`1`, "/", p.cat.tb$total,
  " (", specify_decimal(p.cat.tb$prop *100,0), "%)"
)


p.cat.tb %>% select(name, any_tb_rx, str) %>% pivot_wider(names_from = any_tb_rx, values_from = str) -> p.cat.tb
p.cat.tb <- merge(p.cat.tb, p.catpvals.tb)



p.tb <- bind_rows(p.tb,p.cat.tb)

p.tb$boldcol <- FALSE 
p.tb$boldcol[p.tb$pval <= 0.05] <- TRUE

p.tb$pval <- specify_decimal(p.tb$pval, 3)
p.tb$pval[p.tb$pval == "0.000"] <- "<0.001"


#p[match(c("calc_age", "ptsex", "hivstatus", "hivonart","CD4_Absolute", "Haemoglobin","screentemp", "t0hr", "t0sbp", "t0dbp", "t0map",
#        "t0rr", "t0spo2","gcs", "ustand", "lactate_value" , "WCC", "Platelets", "NA.", "Potassium",
#        "Chloride", "CO2", "Urea", "Creatinine", "bc", "tb", "malaria", "csf", "no_diagnosis",
#        "any_ab", "time_to_abx", "any_fung_rx","time_to_fung_rx", "any_mal_rx", "time_to_mal_rx", "any_tb_rx","time_to_tb_rx", "fluid_6hr"), p$name),] -> p

p.tb[match(c("calc_age", "ptsex", "hivstatus", "hivonart","CD4_Absolute", "Haemoglobin","screentemp", "t0hr", "t0sbp", "t0dbp", "t0map",
        "t0rr", "t0spo2","gcs", "ustand", "lactate_value" , "WCC", "Platelets", "CO2", "Urea", "Creatinine", "bc", "tb", "malaria", "csf", "no_diagnosis",
        "any_ab", "time_to_abx", "any_fung_rx","time_to_fung_rx", "any_mal_rx", "time_to_mal_rx", "fluid_6hr"), p.tb$name),] -> p.tb


p.tb <- p.tb[c("name", "1", "0", "pval", "boldcol")]
names(p.tb) <- c("Variable", "TB treatment", "No TB treatment", "p", "boldcol")

boldrows <- which(p.tb$boldcol %in% TRUE)

p.tb$Variable[p.tb$Variable == "calc_age"] <- "Age (years)"
p.tb$Variable[p.tb$Variable == "ptsex"] <- "Male sex"
p.tb$Variable[p.tb$Variable == "hivstatus"] <- "HIV Infected\\textsuperscript{*}"
p.tb$Variable[p.tb$Variable == "hivonart"] <- "Taking ART\\textsuperscript{\\dag}"
p.tb$Variable[p.tb$Variable == "Haemoglobin"] <- "Haemoglobin (x10\\textsuperscript{9} g dL\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "CD4_Absolute"] <- "CD4 count\\textsuperscript{\\dag} ($\\mu$L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "screentemp"] <- "Temperature (\\textdegree C)"
p.tb$Variable[p.tb$Variable == "t0hr"] <- "Heart rate (min\\textsuperscript{-1}))"
p.tb$Variable[p.tb$Variable == "t0sbp"] <- "Systolic BP (mmHg)"
p.tb$Variable[p.tb$Variable == "t0dbp"] <- "Diastolic BP (mmHg)"
p.tb$Variable[p.tb$Variable == "t0map"] <- "Mean arterial BP (mmHg)"
p.tb$Variable[p.tb$Variable == "t0rr"] <- "Respiratory rate (min\\textsuperscript{-1}))"
p.tb$Variable[p.tb$Variable == "t0spo2"] <- "Oxygen saturation (%)"
p.tb$Variable[p.tb$Variable == "gcs"] <- "GCS"
p.tb$Variable[p.tb$Variable == "ustand"] <- "Unable to stand"
p.tb$Variable[p.tb$Variable == "lactate_value"] <- "Lactate (mmol L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "WCC"] <- "White cell count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "Platelets"] <- "Platelet count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "NA."] <- "Sodium (mmol L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "Potassium"] <- "Potassium (mmol L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "CO2"] <- "Bicarbonate (mmol L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "Urea"] <- "Urea (mmol L\\textsuperscript{-1})"
p.tb$Variable[p.tb$Variable == "Creatinine"] <- "Creatinine (mmol L\\textsuperscript{-1})"

p.tb$Variable[p.tb$Variable == "bc"] <- "BSI"
p.tb$Variable[p.tb$Variable == "tb"] <- "TB"
p.tb$Variable[p.tb$Variable == "malaria"] <- "Malaria"
p.tb$Variable[p.tb$Variable == "csf"] <- "Meningitis"
p.tb$Variable[p.tb$Variable == "no_diagnosis"] <- "No diagnosis"

p.tb$Variable[p.tb$Variable == "any_ab"] <- "Antibacterials"
p.tb$Variable[p.tb$Variable == "time_to_abx"] <- "Time to Antibacterials (hr)"
p.tb$Variable[p.tb$Variable == "any_fung_rx"] <- "Antifungals"
p.tb$Variable[p.tb$Variable == "time_to_fung_rx"] <- "Time to Antifungals (hr)"
p.tb$Variable[p.tb$Variable == "any_mal_rx"] <- "Antimalarials"
p.tb$Variable[p.tb$Variable == "time_to_mal_rx"] <- "Time to Antimalarials (hr)"
p.tb$Variable[p.tb$Variable == "any_tb_rx"] <- "Antimycobacterials"
p.tb$Variable[p.tb$Variable == "time_to_tb_rx"] <- "Time to Antimycobacterials (hr)"

p.tb$Variable[p.tb$Variable == "fluid_6hr"] <- "IV fluid (ml)"

sub("%", "\\\\%", p.tb$`TB treatment`) -> p.tb$`TB treatment`
sub("%", "\\\\%", p.tb$`No TB treatment`) -> p.tb$`No TB treatment`

sub("%", "\\\\%", p.tb$Variable) -> p.tb$Variable



kable(select(p.tb,-boldcol), "latex", booktabs =T, 
      row.names = F, longtable = F, ,escape = F,caption = "Bivariable associations of receipt of TB treatment in sepsis" ) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header", "HOLD_position")) %>%
  row_spec(boldrows, bold = T) %>%
  pack_rows("Host Variables", 1,6, bold = F) %>% 
   pack_rows("Severity Variables", 7, 21, bold = F)  %>%
    pack_rows("Diagnosis", 22,26, bold = F) %>% 
   pack_rows("Treatment Received", 27, 33, bold = F)  %>%
  footnote(general = "BP = Blood pressure, GCS = Glasgow coma scale. Numeric variables are presented as median (IQR) and categorical variables as proportions. P-values are from Kruskal-Wallace test for continuous variables and Fisher's exact test for categorical variables." , symbol = c("Participants with HIV status unknown not included in this row","Includes only HIV-infected participants"), threeparttable = T, fixed_small_size = T)

```

```{r var-match-plots, echo = F, warning=F, message=F,fig.scap= "Variable distributions in sepsis cohort following propensity score matching. ", out.extra='', fig.cap="Variable distributions following propensity score matching. A: original cohort. B: Propesnity score matched cohort. BSI = bloodstream infection, RR = respiratory rate, Sp02 = Capilliary oxygen saturation, TB = tuberculosis. Categrorical variables (Malaria rx, BSI, CD4 < 100, Meningitis, HIV, Malaria, TB, Can't stand) are coded as 1 for present and 0 for absent. ", fig.width=8 , fig.height =10  , fig.align = 'center' }

recode(prs.df$any_tb_rx, `0` = "No TB treatment", `1` = "TB treatment") -> prs.df$any_tb_rx
recode(match.data$any_tb_rx, `0` = "No TB treatment", `1` = "TB treatment") -> match.data$any_tb_rx

prs.df[-16] %>% select(-d28_death,) %>% pivot_longer(-any_tb_rx) %>%
  mutate(name = recode_factor(name, any_mal_rx = "Malaria rx",
                              bc = "BSI",
                              CD4.dic = "CD4 < 100",
                              csf = "Meningitis",
                              fluid_6hr = "Fluid (L)",
                              Haemoglobin = "Haemoglobin",
                              hivstatus = "HIV",
                              malaria = "Malaria",
                              t0rr = "RR",
                              t0spo2 = "SpO2",
                              tb = "TB",
                              Urea = "Urea",
                              ustand = "Can't stand")) %>%
  ggplot(aes(value, group = as.factor(any_tb_rx), fill = as.factor(any_tb_rx))) +geom_density(alpha = 0.7) + facet_wrap(~ name, scales = "free") + theme_bw() + theme(legend.title = element_blank(), legend.position = "bottom") + xlab(element_blank()) + ylab(element_blank()) -> pa

match.data %>% select(-d28_death, - distance, -weights, -Hb.dic) %>% pivot_longer(-any_tb_rx) %>%
    mutate(name = recode_factor(name, any_mal_rx = "Malaria rx",
                              bc = "BSI",
                              CD4.dic = "CD4 < 100",
                              csf = "Meningitis",
                              fluid_6hr = "Fluid (L)",
                              Haemoglobin = "Haemoglobin",
                              hivstatus = "HIV",
                              malaria = "Malaria",
                              t0rr = "RR",
                              t0spo2 = "SpO2",
                              tb = "TB",
                              Urea = "Urea",
                              ustand = "Can't stand")) %>%
  ggplot(aes(value, group = as.factor(any_tb_rx), fill = as.factor(any_tb_rx))) +  geom_density(alpha = 0.7)  + facet_wrap(~ name, scales = "free") + theme_bw() + theme(legend.title = element_blank(), legend.position = "bottom") + xlab(element_blank()) + ylab(element_blank()) -> pb

ggarrange(pa,pb, ncol = 1, nrow = 2, labels = c("A", "B"), common.legend = TRUE, legend = "top")

```

