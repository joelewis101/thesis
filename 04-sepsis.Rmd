# A clinical and microbiological description of sepsis in Blantyre, Malawi
\chaptermark{Sepsis in Blantyre, Malawi}

```{r ch4-setup, include = F}

library(plyr)
library(reshape2)
library(tidyverse)
library(knitr)
library(kableExtra)
library(grid)
library(ggpubr)
library(pheatmap)
library(UpSetR)
library(eulerr)
library(RColorBrewer)
library(scales)
library(lubridate)
library(survival)
library(eq5d)
library(ggsci)
library(survminer)
library(brms)
library(FactoMineR)
library(factoextra)
library(epitools)
library(broom)
library(glue)

wd <- "chapter_4/"
output = "latex"
T <- TRUE

specify_decimal <- function(x, k) trimws(format(round(x, k), nsmall=k))


# generate figures
#source("chapter_4/generate_consort_diagram.R")
source("final_cleaning_scripts/generate_visits_df.R")
source("final_cleaning_scripts/load_and_clean_followup_and_enroll_labelled.R")
source("other_scripts/summary_table_functions.R")
source("final_cleaning_scripts/make_composite_hivstatus_variable.R")
#source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_bloods.R")
source("final_cleaning_scripts/load_and_clean_aetiol.R")
source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_upto72.R")
source("final_cleaning_scripts/load_and_clean_post72.R")
source("final_cleaning_scripts/load_and_clean_hosp_oc.R")
source("final_cleaning_scripts/load_and_clean_time_to_ab.R")
source("final_cleaning_scripts/load_and_clean_fluid_hr1_to_6.R")



h1.ustand <- read.csv("/Users/joelewis/Documents/PhD/Data/Current/portal_downloads/other_datasets/h1_ustand.csv")


  
# calc time to recruitment

hourly %>% group_by(pid) %>% summarise(first_ax = min(date_time, na.rm= T)) -> fa

merge(select(df.abs, pid, earliest_arr_time), fa, all.x = T) -> fa
difftime(fa$first_ax, fa$earliest_arr_time, units = "hours") -> fa$dt
fa$dt2 <- fa$dt
fa$dt2[fa$dt2 > 1] <- fa$dt2[fa$dt2 > 1] -1

time_to_rec_str <- median_iqr_str(as.numeric(fa$dt2),1)

df <- subset(enroll, arm == 1)
df$gcs <- df$t0gcse + df$t0gcsv + df$t0gcsm
df <- merge(df, bloods, all.x = T)

aetiol.m <- dcast(aetiol, pid + hivstatus ~ type, value.var = "pathogen")
aetiol.m$tb <- aetiol.m$`mtb bsi`== 1 | aetiol.m$uLAM == 1 | aetiol.m$Xpert == 1

df <- merge(df, select(aetiol.m, - hivstatus), all.x = T)

df <- merge(df, select(df.abs, pid, first_ab, time_to_abx))

df <- merge(df, select(df.tb, pid, any_tb_rx, time_to_tb_rx))

df <- merge(df, select(fluid, pid, `6`))
names(df)[names(df) == "6"] <- "fluid_6hr"

df.mal.b <-select(df.mal, pid, first_ab, time_to_mal_rx)
names(df.mal.b)[2:3] <- c("first_mal_rx", "time_to_mal_rx")

df <- merge(df, df.mal.b)
rm(df.mal.b)

df.fung.b <-select(df.fung, pid, first_ab, time_to_fung_rx)
names(df.fung.b)[2:3] <- c("first_fung_rx", "time_to_fung_rx")

df <- merge(df, df.fung.b)
rm(df.fung.b)

df[df == 999] <- NA

#aetiol.m -> a
#a[is.na(a)] <- 0
#a$no_diagnosis <- as.numeric(apply(a[3:8], 1,sum) == 0)



v1 <- visits %>% filter(arm == 1) 

v1$t <- apply(v1[7:10], 1,max, na.rm= T )

v1$t[!is.na(v1$died_date)] <- v1$died_date[!is.na(v1$died_date)]

#v1$t <- v1$t * 7
v1$died <- v1$status
v1$died[v1$died == 2] <- 0

v1 <- select(v1, pid, enrolled, arm, t, died)

#v1$d28_death

v1$d28_death <- NA

v1$d28_death[(v1$t <= 28) & (v1$died == 1)] <- 1
v1$d28_death[(v1$t >= 28)] <- 0

v1$d90_death[(v1$t <= 90) & (v1$died == 1)] <- 1
v1$d90_death[(v1$t >= 90)] <- 0

v1$d180_death[(v1$t <= 180) & (v1$died == 1)] <- 1
v1$d180_death[(v1$t >= 180)] <- 0

df <- merge(df, v1, all.x = T)

df <- merge(df, h1.ustand, all.x= T)

df$sbp.dic <- (df$t0sbp <= 90)
df$t.dic <- NA
df$t.dic[df$screentemp < 36] <- "<36"
df$t.dic[df$screentemp >= 36 & df$screentemp < 38] <- "36-38"
df$t.dic[df$screentemp >= 38] <- ">38"

df$hr.dic <-  (df$t0hr > 100)
df$rr.dic <-  (df$t0rr > 30)
df$cd4.dic <- (df$CD4_Absolute <= 200)
df$spo2.dic <- (df$t0spo2 < 90)
df$gcs.dic <- (df$gcs < 15)
df$lact.dic <- (df$lactate_value > 3)
as.numeric(df$WCC) > 11 -> df$WCC.dict
df$CO2.dic <- as.numeric(df$CO2 < 23)

# assess bivariate distributions
df$t0map <- (df$t0sbp + (df$t0dbp * 2))/3 

df$tb[df$tb] <- 1
df$tb[df$tb == FALSE | is.na(df$tb) ] <- 0

df$malaria[is.na(df$malaria)] <- 0
df$bc[is.na(df$bc)] <- 0
df$csf[is.na(df$csf)] <- 0

e1 <- subset(enroll, arm == 1)

```

## Chapter overview

In this chapter, I present a clinical and microbiological description of sepsis in Blantyre, Malawi. As expected, participants are young relative to high income settings and there is a high prevalence of HIV-infection. 28-day case-fatality is 18% (95% CI 13-26%) but continues to rise throughout the study period to 31% (95% CI 25-38%) by 180 days and is higher in the HIV-infected in a time-to event analysis, seemingly driven by late (> 2 week) deaths. Participants had been unwell for some time (median 7 days) prior to presentation. Microbiological testing identified an aetiological agent for 51% of the cohort: _Mycobacterium tuberculosis_ is the commonest cause identified, in 34% of all participants, usually manifesting as disseminated mycobacterial disease diagnosed by urinary lipoarabinomannan testing. Bloodstream infection was next most prevalent (11%), followed by malaria caused by _Plasmodium falciparum_ (9%). I use logistic regression to identify determinants of 28-day mortality.  Time to antibacterial therapy and volume of intravenous fluid administered show no significant association with mortality; however, receipt of antituberculous showed an independent association with survival to 28 days (aOR 0.17 for death [95% CI 0.03-0.74]). The logistic regression models used to provide these estimates of effect size had some problems, which could result in biased estimates: some predictors perfectly predicted outcome and so were excldued from the model (called seperation); and the number of predictors included meant that the model is likely overparameterised.

## Introduction and chapter aims

The aetiology of sepsis of sepsis in sSA is poorly described (reviewed in Chapter 1), and the appropriateness of the blind introduction of sepsis treatment principles and protocols from high-income settings to sSA is coming under increasing scrutiny. A focus on reducing door-to-antimicrobial time and rapid administration of intravenous fluid is likely effective at reducing sepsis mortality in high-income settings[@Kahn2019;@Seymour2017], but data on the utility of this strategy in sSA are limited, and it is possible that other patient or treatment factors may be stronger determinents of outcome in sSA. The aims of this chapter are twofold:

1. To describe the demographics, mode of presentation, aetiology, management, and outcomes of sepsis in Blantyre with outcomes to 180 days in terms of mortality and morbidity as health related quality of life. 

2. To identify independent associations of mortality - particularly modifiable treatment-related factors -  with a view to informing sepsis treatment protocols for sSA.

## Methods

The clinical and laboratory methods of the clinical study are described in Chapter 2, Methods; a further overview of chapter aims and description of the statistical analysis used is given here. 

For the first aim - description of sepsis in Blantyre - patient demographics, health seeking behaviour, symptoms and admission physiology are described as medians and interquartile ranges for continuous variables or proportions for categorical variables, and Kruskal-Wallace or Fisher's exact tests used to compare between groups. Aetiology is presented as simple proportions, stratified by HIV status and co-infections visualised a Venn diagrams and UpSet plots using _eulerr_[@Larsson2019] and _UpSetR_[@Conway2017] packages, respectively, in R. Mortality is presented as simple proportions at 28, 90 and 180 days with exact binomial confidence intervals, and Kaplan-Meier estimates of the survival function generated using the _survival_ package in R[@Therneau2015]. Both of these estimates are presented aggregated and stratified by HIV status, with log-rank test used to test the hypothesis that HIV-infected and uninfected survival functions differ, and Fisher's exact test to compare mortality in HIV-infected versus uninfected participants at each time point. 

Morbidity was assessed as health related quality of life (HRQoL) using the EQ-5D-3L questionnaire, which assesses HRQoL across five domains (anxiety, pain, self care, usual activities, walking) with participants describing their problems across the domains on a 3 point ordinal scale: no problems, moderate or extreme. So-called tariff sets are used to convert these scores to an overall utility score, which compares the health state compared to perfect heath: a utility score of one represents perfect health and zero represents death, but scores of below zero (states worse than death) are possible. Tariff sets are country specific, and no Malawian tariff sets are available, so a Zimbabwean tariff set was used[@Jelsma2003]. The _eq5d_ package in R was used to convert health states into utility scores. HRQoL was measured at baseline, and the 1,4,12 and 24 week visits, and is presented as proportion of participants reporting at least moderate impairment in each domain (with exact binomial confidence intervals) at each time point, as well as boxplots of utility score. Utility scores of participants with sepsis were compared to community controls using t-tests.

Bivariable associations of mortality were assessed with Kruskall-Wallace tests (for continuous variables) or Fisher's exact test (for categorical variables) to compare variable distributions for participants who died to those who survived. Variables were selected for these comparisons that _a priori_ may be expected to be associated with mortality: host variable (age, sex, HIV status, CD4 cell count, ART status, haemoglobin), severity variables (admission vital signs, inability to stand on admission, white cell count (WCC), platelet count, serum creatinine, urea, and bicarbonate, capillary lactate), diagnosis, or treatment variables (receipt of any antibacterial, any antifungal, any antituberculous drug or any antimalarial all as binary variables, time to receipt of each as a continuous variable, and volume on intravenous fluid received in the first 6 hours of admission as a continuous variable). To address confounding, logistic regression models were constructed, using all these variables except CD4 cell count, ART status and time-to-antibacterials (as these variables were not available for all participants). Otherwise the full set of _a priori_ variables were used as predictors and 28-day mortality as the outcome, and fitted using the _glm_ command in R v3.6.0. All statistical analysis were carried out in R v3.6.0. 

\clearpage

## Results

### Study population

225 participants were recruited in 20 months between 19th February 2017 and 2nd October 2018 (Figure \@ref(fig:consort-diag)). Participants were recruited soon after arrival in hospital (median 1.5 hours [IQR 0.8-2.6] after first attendance). In total, 4 participants (2%) were lost to follow up over the 180-day study period; 5 participants (2%) withdrew; and 7 participants (3%) transferred out of the study area before 180 days. Four of the five participants who withdrew gave a reason for their wish to withdraw, all that they no longer wished the inconvenience of being involved in the study. 15/225 (7%) participants had their final study visit before 180 days, and so were not included in the 180-day outcome analysis.

### Baseline characteristics

Table \@ref(tab:sep-t1-demog-dassim) shows the baseline characteristics of the recruited participants. Subjects tended to be young (median [IQR] age 36 [28-44]). The majority were HIV-infected (67% [143/213 of those with known HIV status]), of whom 117 (82%) were on ART, almost exclusively the Malawian first-line regimen of efavirenz, lamivudine and tenofovir. The majority ( 88/117 [75%]) had been taking ART for more than three months; the distribution of reported time on ART is shown in Figure \@ref(fig:time-on-art).

Almost all (221/225 [98%] of participants) experienced subjective fever (Figure \@ref(fig:sep-present)). Participants had been unwell for some time, a median (IQR) of 7 (3-14) days; 32/225 (14%) of participants had been unwell for more than 4 weeks. 18/225 (8%) of participants had been admitted to hospital within the last 4 weeks. Over half (123/225 [55%]) of participants had sought care for their current illness (Table \@ref(tab:sep-healthseek)), most commonly at a government health centre (101/123 [82%]), a median (IQR) of 2 (1-6) days previously.

Prehospital antimicrobial use was common: 60/225 (27%) of all participants had received an antimicrobial for their current illness: 7/60 (12%) of all prehospital antimicrobials were antimalarials, the remainder antibacterial, most commonly co-trimoxazole or ciprofloxacin. Prehospital intravenous or intramuscular antimicrobials were administered in 16/60 (27%) participants receiving antimicrobials: ceftriaxone (n=6), benzylpenicillin (n=4), gentamicin (n=3) and artesunate (n=3).


```{r consort-diag, echo = F, fig.cap = "Study recruitment and follow up.",  out.height = '80%', fig.align = 'center'}

knitr::include_graphics(paste0(wd, "/figures/consort_diagram.pdf"))

```

\clearpage

```{r sep-present-setup, include = F}


sympt <- e1[names(e1) %in% names(enroll.names)[grepl("symp",enroll.names)]]

sympt[sympt == "No"] <- 0
sympt[sympt == "Yes"] <- 1
(sapply(sympt, as.numeric)) -> sympt

sympt.melt <- melt(sympt) %>% filter(value > 0)
gsub("\\.", " ", sympt.melt$Var2) -> sympt.melt$Var2
str_to_title(sympt.melt$Var2) -> sympt.melt$Var2
ggplot(sympt.melt, aes(fct_rev(fct_infreq(Var2)))) +
  geom_bar() + coord_flip() + theme_bw() +
  labs(x= "", y = "Count") -> p1

gsub("\\.", " ", dimnames(sympt)[[2]]) -> dimnames(sympt)[[2]]
str_to_title(dimnames(sympt)[[2]]) -> dimnames(sympt)[[2]]
grid.grabExpr(pheatmap(sympt[1:225,1:25], legend = F, fontsize = 7)) -> p2
as_ggplot(p2) ->p2

```

\renewcommand{\arraystretch}{0.8}

```{r sep-t1-demog-dassim, echo = F, warning = F, message = F}


e1$datefirstunwell[e1$unwelfreq == "Weeks"] <- e1$datefirstunwell[e1$unwelfreq == "Weeks"] * 7
e1$datefirstunwell[e1$unwelfreq == "Months"] <- e1$datefirstunwell[e1$unwelfreq == "Months"] * 30


e1$t0map <- (e1$t0sbp + (e1$t0dbp * 2))/3 
e1$art.time <- as.numeric((e1$data_date - e1$hivartstart) /(365.25/12))

e1$hivart[e1$hivart != "5A" & !is.na(e1$hivart)] <- "ART regimen: other"
e1$animalskept[e1$animalskept == "Other"] <- "Elsewhere"
e1$keep.other[e1$keep.cattle == "Yes" | e1$keep.sheep == "Yes" | e1$keep.mules == "Yes"] <- "Yes"
e1.sum <- select(e1, calc_age, ptsex, hivstatus,tbstatus, tbongoing, hivonart, hivart, art.time, hivcpt, 
                  tobaccoyn, alcoholyn,  highestedu,
                 job,  toilet , watersource,
                 electricityyn, fuel, 
                 keepanim, keep.poultry,  keep.goats,
                 keep.dogs, keep.other)

pretty_tbl_df(e1.sum) -> e1.sum
## tweeaky tweaky
e1.sum <- subset(e1.sum, `levels` != "No")
e1.sum <- subset(e1.sum, `levels` != "Female")

e1.sum$levels[e1.sum$variable == "calc_age"] <- "Age (years)"
e1.sum$levels[e1.sum$variable == "ptsex"] <- "Male sex"
e1.sum$variable[e1.sum$variable %in% c("calc_age", "ptsex")] <- "Demographics"

# art variables
e1.sum$levels[e1.sum$levels %in% c("Reactive", "Non reactive", "Unknown")] <- 
  paste0("HIV ", str_to_title(e1.sum$levels[e1.sum$levels %in% c("Reactive", "Non reactive", "Unknown")]))
e1.sum$levels[e1.sum$variable == "hivonart"] <- "Current ART"
e1.sum$levels[e1.sum$variable == "hivcpt"] <- "Current CPT\\textsuperscript{\\dag}"
e1.sum$levels[e1.sum$levels == "5A"] <- "ART regimen: EFV/3TC/TDF"
e1.sum$levels[e1.sum$variable == "art.time"] <- "Months on ART"
e1.sum$variable[e1.sum$variable == "hivstatus"] <- "HIV/TB status"
e1.sum$variable[grepl("art", e1.sum$variable)] <- "ART status*"
e1.sum$variable[grepl("cpt", e1.sum$variable)] <- "ART status*"
# tb variables
e1.sum$levels[e1.sum$variable == "tbstatus"] <- "Ever treated for TB"
e1.sum$levels[e1.sum$variable == "tbongoing"] <- "Of those, current TB treatment"
e1.sum$variable[grepl("tb", e1.sum$variable)] <- "HIV/TB status"


e1.sum <- e1.sum[c(1:8,11,9,10,12:nrow(e1.sum)),]



# tobacco use
e1.sum$levels[grepl("tobacco", e1.sum$variable)] <- paste0(e1.sum$levels[grepl("tobacco", e1.sum$variable)], " tobacco" )
e1.sum$variable[grepl("tobacco", e1.sum$variable)] <- "Tobacco/alcohol use"

# alcohol use
e1.sum$levels[e1.sum$variable == "alcoholyn"] <- "Current alcohol"
e1.sum$variable[grepl("alcohol", e1.sum$variable)] <- "Tobacco/alcohol use"

# education
e1.sum$variable[grepl("highestedu", e1.sum$variable)] <- "Education"

# employment 
e1.sum$variable[grepl("job", e1.sum$variable)] <- "Employment"

# toilet

e1.sum$variable[grepl("toilet", e1.sum$variable)] <- "Toilet facilities"

# toilet

e1.sum$variable[grepl("water", e1.sum$variable)] <- "Main water source"

# electricity
e1.sum$levels[e1.sum$variable == "electricityyn"] <- "Electricity available in house"
e1.sum$variable[grepl("electric", e1.sum$variable)] <- "Electricty"

e1.sum$variable[grepl("fuel", e1.sum$variable)] <- "Main cooking fuel"

# animals

e1.sum$levels[grepl("keep", e1.sum$variable)] <- e1.sum$variable[grepl("keep", e1.sum$variable)]

sub("keep.", "",e1.sum$levels) -> e1.sum$levels
str_to_title(e1.sum$levels[grepl("keep", e1.sum$variable)] ) -> e1.sum$levels[grepl("keep", e1.sum$variable)]
e1.sum$levels[e1.sum$levels == "Nim"] <- "Any animal"

e1.sum$variable[grepl("keep", e1.sum$variable)] <- "Animals at home?"

e1.sum <- e1.sum[c(1:45, 47,46,47:nrow(e1.sum)),]

kstring <- make_kable_rowgroup_string(e1.sum)
e1.sum$levels[e1.sum$levels== "Yes" | e1.sum$levels== "Median (IQR)" ] <- 
  e1.sum$variable[e1.sum$levels== "Yes" | e1.sum$levels== "Median (IQR)" ]
#rownames(e1.sum) <- e1.sum$`levels`
#rownames(e1.sum)[!(rownames(e1.sum) %in% kstring)]

sub("%", "\\\\%", e1.sum$value) -> e1.sum$value

e1.sum <- subset(e1.sum, variable != "Toilet facilities" & 
                   variable != "Main water source" &
                   variable != "Main cooking fuel" &
                   variable != "Electricty" &
                   variable != "Education" )

kstring[!names(kstring) %in% c( "Toilet facilities", 
                               "Main water source", 
                               "Main cooking fuel", 
                               "Electricty",
                               "Education")] -> kstring

kable(select(e1.sum,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = T, escape = F, col.names = c("Variable","Value"), caption = "Participant Characteristics" ) %>%
  kable_styling(full_width = F,latex_options = c("repeat_header")) %>%
  group_rows(index = kstring) %>%
  footnote(general = "ART = Antiretroviral therapy, CPT = Co-trimoxazole preventative therapy, EFV: Efavirenz, 3TC: Lamivudine, TDF: Tenofovir. Numeric values are median (IQR)) unless otherwise stated.", symbol = c("ART status includes HIV reactive only as denominator", "Missing CPT data for two participants. ") ,threeparttable = T, fixed_small_size = T)



```

```{r time-on-art, echo = F,  warning = F, message = F, fig.cap = "Distribution of reported time of ART (months). Histogram bins are 6 months", fig.width = 3, fig.height=3, fig.align = 'center'}

ggplot(e1, aes(art.time)) + 
  geom_histogram(binwidth = 6) + 
  xlim(c(-6,150)) + 
  theme_bw() +
  xlab("Time on ART (months)") + 
  ylab("n")

```



```{r sep-present, echo = F, warning = F, message = F, fig.scap="Symptoms of recruited participants", out.extra='', fig.cap="Symptoms of recruited participants. A: Row and column clustered heatmap of participant symptoms. Each row represents a patient. Red = presence, blue = absence. B: Frequency of occurence of symptoms", fig.width = 8, fig.height = 5, out.height= '40%'}

ggarrange(p2,p1, labels = c("A", "B"), widths = c(1, 1)) 
```


```{r sep-healthseek, echo = F, warning = F, message = F}

e1$phxstartdate_n[grepl("Weeks", e1$prehfreq)] <- e1$phxstartdate_n[grepl("Weeks", e1$prehfreq)] * 7
e1$phxstartdate_n[grepl("Months", e1$prehfreq)] <- e1$phxstartdate_n[grepl("Months", e1$prehfreq)] * 30


e1$prehospcaredur[grepl("Weeks", e1$prehospcarefr)] <- e1$prehospcaredur[grepl("Weeks", e1$prehospcarefr)] * 7
e1$prehospcaredur[grepl("Months", e1$prehospcarefr)] <- e1$prehospcaredur[grepl("Months", e1$prehospcarefr)] * 30


e1$ab_startdays[e1$recieved_prehosp_ab == "Yes"] <- e1$phxstartdate_n[e1$recieved_prehosp_ab == "Yes"]
e1$prehosp_ab[e1$recieved_prehosp_ab == "Yes"] <- e1$prehosrxname [e1$recieved_prehosp_ab == "Yes"]
e1$prehospcaretransp[grepl("Min", e1$prehospcaretranspother)] <- "Minibus"


e1.sum.2 <- select(e1, prehospcareyn,soughtcare.other.hospital,soughtcare.other.clinic,soughtcare.pharmacy,soughtcare.private.doctor, soughtcare.other.health.worker ,soughtcare.traditional.practicioner,soughtcare.friend.or.family,soughtcare.other,prehospcaredur, recieved_prehosp_ab,  prehosp_ab,ab_startdays, prehospcaretransp, prehospcaretranspcost)

pretty_tbl_df(e1.sum.2) -> e1.sum.2
subset(e1.sum.2, levels != "No") -> e1.sum.2

e1.sum.2$levels[e1.sum.2$variable == "prehospcareyn"] <- "Sought care prior to attendance at hospital"
e1.sum.2$levels[e1.sum.2$variable == "prehospcaredur"] <- "Days prior to today that participant sought care"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other.hospital"] <- "At hospital"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other.clinic"] <- "At health centre"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.private.doctor"] <- "At private doctor"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other"] <- "Somewhere else "

e1.sum.2$variable[e1.sum.2$variable == "prehospcareyn" |
                    e1.sum.2$variable == "prehospcaredur" |
                    grepl("soughtcare" ,e1.sum.2$variable) ] <-  "Pre-hospital healthcare seeking"
e1.sum.2$levels[e1.sum.2$variable == "recieved_prehosp_ab"] <- "Received any antimicrobial prior to attendance at hospital"
#e1.sum.2$levels[e1.sum.2$variable == "prehosp_ab"] <- paste0("Recieved ", e1.sum.2$levels[e1.sum.2$variable == "prehosp_ab"])


e1.sum.2$levels[e1.sum.2$variable == "ab_startdays"] <- "Days prior to today that antimicrobials started" 
e1.sum.2$variable[ grepl("prehosp_ab" ,e1.sum.2$variable) | grepl("ab_startdays" ,e1.sum.2$variable) ] <- "Prehospital antimicrobial exposure"

e1.sum.2$levels[e1.sum.2$variable == "prehospcaretranspcost"] <- "Cost (MWK) of transport to hospital"
e1.sum.2$variable[ grepl("prehospcaretransp" ,e1.sum.2$variable) ] <- "Method of transport to hospital"

e1.sum.2 <- e1.sum.2[c(1,3,2,4:nrow(e1.sum.2)),]

kstring2 <- make_kable_rowgroup_string(e1.sum.2)

e1.sum.2$value[c(2,3,4,5,6, 8:21)] <- paste0("\\hspace{1em}", e1.sum.2$value[c(2,3,4,5,6, 8:21)] )

sub("%", "\\\\%", e1.sum.2$value) -> e1.sum.2$value

kable(select(e1.sum.2,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = F, escape = F, col.names = c("Variable","Value"), caption = "Prehospital healthcare seeking and antimicrobial exposure" ) %>%
  kable_styling( full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring2) %>%
  add_indent(c(2,3,4,5,6, 8:21)) %>%
  footnote(general = "LA = Lumefantrine-artemether, SP = Sulfamethoxazole-pyrimethamine, MWK = Malawian Kwacha. Numeric values are median (IQR)) unless otherwise stated." ,threeparttable = T, fixed_small_size = T)

```

### Admission physiology and laboratory investigations

Admission vital signs and laboratory investigations are shown in Table \@ref(tab:sep-physiol). Shock, defined as systolic blood pressure below 90mmHg, was more common than hypoxia, defined as oxygen saturation below 90% (34% [80/225] vs 13% [28/224]). Reduced conscious level, defined as Glasgow coma scale (GCS) below 15 was rarer (9% [21/225]); 28% (63/225) of participants were unable to stand on admission.

Despite high ART coverage (117/143 [82%]) among HIV-infected participants for a median of 29 months, the median (IQR) CD4 count was low at 98 (31-236) cells $\mu$L\textsuperscript{-1}. 108/141 (70%) of participants had a CD4 count below 200 cells $\mu$L\textsuperscript{-1}. CD4 count was similar in participants who had started ART more than 6 months ago as compared to less than three months ago (median [IQR] 99 [27-260] vs 93 [39-137] cells $\mu$L\textsuperscript{-1} respectively). 42/83 (51%) of participants who had been taking ART for more than 6 months had a CD4 count of less than 100 cells $\mu$L\textsuperscript{-1}, which fulfils the WHO definition of immunological failure of HIV treatment.

```{r sep-physiol, echo = F, warning = F, message = F}

# merge in bloods
e1[e1 == 999] <- NA
e1 <- merge(e1,bloods, all.x = T)
e1 <- merge(e1, h1.ustand, all.x= T)
e1$gcs <- e1$t0gcse + e1$t0gcsv + e1$t0gcsm
e1$gcs.cat <- NA
e1$gcs.cat[e1$gcs == 15] <- "15"
e1$gcs.cat[e1$gcs > 10 & e1$gcs < 15] <- "11-14"
e1$gcs.cat[e1$gcs < 11] <- "10 or below"
e1$t0map <- (e1$t0sbp + (e1$t0dbp * 2))/3 


e1$CD4_hiv_pos <- NA
e1$CD4_hiv_pos[e1$hivstatus == "Reactive"] <- e1$CD4_Absolute[e1$hivstatus == "Reactive"] 
e1$Neutrophils_count <- as.numeric(e1$Neutrophils_count )

e1$ustand <- as.character(e1$ustand)

rbind(
  pretty_tbl_df(
    select(e1, t0hr, t0sbp, t0dbp,t0map, t0rr, t0spo2, gcs.cat, ustand, CD4_hiv_pos)
    ),
  
  pretty_tbl_df(
    select(e1, screentemp, Haemoglobin, WCC, Neutrophils_count,  Potassium, Urea, lactate_value)
    ,r = 1),
  pretty_tbl_df( 
    select(e1, Platelets, Chloride, CO2, Creatinine, NA. )
    )
  ) -> e1.sum.3

e1.sum.3$levels[e1.sum.3$variable == "screentemp"] <- "Temperature (\\textdegree C)"
e1.sum.3$levels[e1.sum.3$variable == "t0hr"] <- "Heart rate (min\\textsuperscript{-1}))"
e1.sum.3$levels[e1.sum.3$variable == "t0sbp"] <- "Systolic BP (mmHg)"
e1.sum.3$levels[e1.sum.3$variable == "t0dbp"] <- "Diastolic BP (mmHg)"
e1.sum.3$levels[e1.sum.3$variable == "t0map"] <- "MAP (mmHg)"
e1.sum.3$levels[e1.sum.3$variable == "t0rr"] <- "Respiratory rate (min\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "t0spo2"] <- "Oxygen saturation (%)"
e1.sum.3$levels[e1.sum.3$levels == "15"] <- "GCS 15"
e1.sum.3$levels[e1.sum.3$levels == "11-14"] <- "GCS 11-14"
e1.sum.3$levels[e1.sum.3$levels == "10 or below"] <- "GCS < 11"
e1.sum.3$levels[e1.sum.3$variable == "ustand"] <- "Unable to stand"
e1.sum.3$levels[e1.sum.3$variable == "CD4_hiv_pos"] <- "CD4 count* ($\\mu$L\\textsuperscript{-1})"

e1.sum.3$levels[e1.sum.3$variable == "Haemoglobin"] <- "Haemoglobin (x10\\textsuperscript{9} g dL\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "WCC"] <- "White cell count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Neutrophils_count"] <- "Neutrophil count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Platelets"] <- "Platelet count count (x10\\textsuperscript{9} L\\textsuperscript{-1})"

e1.sum.3$levels[e1.sum.3$variable == "NA."] <- "Sodium (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Potassium"] <- "Potassium (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Urea"] <- "Urea (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "CO2"] <- "Bicarbonate (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Creatinine"] <- "Creatinine (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "lactate_value"] <- "Lactate (mmol L\\textsuperscript{-1})"

sub("%", "\\\\%", e1.sum.3$value) -> e1.sum.3$value
sub("%", "\\\\%", e1.sum.3$levels) -> e1.sum.3$levels
rbind(e1.sum.3, data.frame(variable = "Admission physiology", `levels` = "GCS", value = " ")) -> e1.sum.3

e1.sum.3 <- e1.sum.3[c(13,1:5,6:8,9,11,12,14,15,16,20,24,17,22,21,18,23,19),]

#e1.sum.3 <- e1.sum.3[c(10,1:5,22,6:8, 9,11,12,13,17,21,14,19,18,15,20,16),]
e1.sum.3$variable[1:11] <- "Admission physiology"
e1.sum.3$variable[12] <- "Admission CD4 count"
e1.sum.3$variable[13:16] <- "Admission haematology"
e1.sum.3$variable[17:nrow(e1.sum.3)] <- "Admission biochemistry"
kstring3 <- make_kable_rowgroup_string(e1.sum.3)

kable(select(e1.sum.3,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = F, col.names = c("Variable","Value") ,escape = F,caption = "Admission physiology, haematology and biochemistry" ) %>%
  kable_styling("striped", full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring3) %>%
  add_indent(c(8:10)) %>%
  footnote(general = "GCS = Glasgow coma scale, BP = Blood pressure, MAP = Mean arterial blood pressure. Numeric values are median (IQR)) unless otherwise stated." , symbol = "CD4 count includes only HIV-infected participants; 2 values were missing.", threeparttable = T, fixed_small_size = T)

```

\clearpage

### Aetiology

In total, 51% (114/225) of the 225 participants had at least one infectious agent identified (Table \@ref(tab:sep-diag)), most commonly disseminated mycobacterial infection (76/225 [34%]) followed by culture confirmed bacterial or fungal bloodstream infection (24/225 [11%]) and _Plasmodium falciparum_ malaria (21/225 [9%]). Table \@ref(tab:sep-tests) shows the availability of test and proportion of positive tests across the cohort, stratified by HIV status. 2/225 patients (1%) had a missing aerobic blood culture; the remaining 223 patients had a total of 259 blood cultures performed. 15/259 (6%) blood cultures grew at least one contaminant, but 26 blood cultures from 24 patients were positive for a total of 28 pathogenic bacteria (Figure \@ref(fig:sep-bc-plot)): _Salmonella enterica_ Serovar Typhi was the most commonly isolated bacterial pathogen. Of note 8/9 participants from whom _S._ Typhi was isolated were HIV noninfected, with one untested. Of the 18 Gram-negative bacteria isolated, 3/18 (17%) were cefpodoxime resistant on AST via disc diffusion testing, and likely ESBL producers: one _K. pneumoniae_ and one _E. coli_ (both from the same blood culture and same patient) and one _Acinetobacter baumannii_. Both _Staphyloccus aureus_ isolates were oxacillin sensitive. The one _Streptococcus pneumoniae_ cultured was penicillin intermediate on AST. There was no significant difference in proportion with positive blood culture in those who self reported receipt of prehospital antibacterials versus those who did not (7/52 [13%] BSI in those reporting prehospital antibacterials vs 17/154 [11%] not, p = 0.14).

Lumbar puncture and CSF culture was carried out in 44 participants: 5/44 (11%) of samples grew a containment and no pathogenic bacteria were recovered from any sample. 4/44 (9%) had a detectable cryptococcal antigen (CRAG) in CSF. Malaria testing was missing for 6/225 (3%) of participants, but of the remainder, a positive malaria test was more likely in the HIV-uninfected (12/69 [17%] vs 6/138 [4%], p = 0.01 on pairwise Fisher's exact test). Positive aerobic blood culture showed no statistically significant association with HIV, nor did positive CSF testing, though in the latter case numbers were small and all positive tests (all positive CRAG) were in fact in the HIV-infected (Table \@ref(tab:sep-tests)).

Testing for TB, with the exception of sputum Xpert testing, was restricted to HIV-infected participants. Sputum Xpert was carried out in 44/225 (20%) of participants, and was more commonly carried out in the HIV-infected: 35/143 [24%] of HIV-infected participants had sputum testing performed vs 8/70 (11%) of HIV uninfected (p = 0.07 by Fisher's exact test). 53 sputum samples were sent in total from the 44 patients, and 8/44 (18%) diagnoses of TB made, all except one in HIV-infected participants. One sample identified a rifampicin resistance gene, but the participant died before the result was available and so was not started on MDR-TB treatment; the remainder of infections were rifampicin-sensitive. 

155 participants were eligible for urinary lipoarabinomannan (uLAM) and mycobacterial blood culture testing, being either HIV-infected (n=143) or of unknown HIV status (n=12). Urine was available for 145/155 (94%) of those eligible, and 74/145 (51%) of samples were positive for uLAM. 150/155 (97%) of eligible participants had blood samples collected and cultured for mycobacteria. 12/150 (8%) grew contaminants and are excluded from the denominators in Table \@ref(tab:sep-tests); of the remainder 8/138 (6%) grew mycobacteria, all _M. tuberculosis_.

Figures \@ref(fig:sep-euler-plot) and \@ref(fig:sep-upset-plot) show the overlap of positive tests form the different diagnostic modalities. Of the 114 patients with at least one positive diagnostic test, 90/114 (79%) had only one positive diagnostic test. The exceptions to this were mycobacterial blood culture and sputum Xpert: patients who had TB diagnosed by these tests tended to also have a positive uLAM. 2/4 (50%) of patients with positive CSF testing (all of whom had detectable CRAG) had also grew _Cryptococcus neoformans_ in aerobic blood culture. 111/225 (49%) of patients remained with no diagnosis.

```{r sep-diag, echo = F, warning = F, message = F}

aetiol.m <- dcast(aetiol, pid + hivstatus ~ type, value.var = "pathogen")
aetiol.m$tb <- aetiol.m$`mtb bsi`== 1 | aetiol.m$uLAM == 1 | aetiol.m$Xpert == 1
aetiol.m -> a
a[is.na(a)] <- 0
a$no_diagnosis <- as.numeric(apply(a[3:8], 1,sum) == 0)

melt(select(a, pid, hivstatus, tb, bc, malaria, csf, no_diagnosis), id.vars = c("pid", "hivstatus")) %>% dplyr::group_by(variable) %>% dplyr::summarise(n = dplyr::n(), positive = sum(value == 1)) -> t

t$prop <-  paste0(t$positive, "/",  t$n, " (",
                         format(round((t$positive*100/t$n), 0), nsmall = 0),
                         "%)"
)

t$variable <- c("Tuberculosis", "Bloodstream infection", "Malaria", "Meningitis", "No diagnosis")

kable(select(t, variable, prop), "latex", booktabs =T, 
      row.names = F, longtable = F, col.names = c("Diagnosis","Proportion of participants") ,escape = T,caption = "Number of diagnoses" ) %>%
  kable_styling( full_width = F)# %>%
#  footnote(general = "Tuberculsosis includes and positive tuberculosis diagnostic test; bloodstream infection includes any patient with at least one positive blood culture, excluding contaminants; meningitis includes any positive CSF culture, excluding contaminents, or positive cryptococcal antigen test in CSF ", threeparttable = T)



```

```{r sep-tests, echo = F, warning = F, message = F}


aetiol$type <- as.factor(aetiol$type)

aetiol %>% dplyr::group_by(hivstatus, type, .drop = FALSE) %>% dplyr::summarise(positive = sum(pathogen == 1), n = dplyr::n()) -> t2

aetiol %>% dplyr::group_by(type, .drop = FALSE) %>% dplyr::summarise(positive = sum(pathogen == 1), n = dplyr::n()) -> t2.tot

t2$prop <-  paste0(t2$positive, "/",  t2$n, " (",
                         round((t2$positive*100/t2$n), 0),
                         "%)"
)

t2.tot$prop <-  paste0(t2.tot$positive, "/",  t2.tot$n, " (",
                         round((t2.tot$positive*100/t2.tot$n), 0),
                         "%)"
)

t2.tot$hivstatus <- "Total"
bind_cols(subset(t2, hivstatus == "Reactive"), 
          subset(t2, hivstatus == "Non reactive"),
          subset(t2, hivstatus == "Unknown"),
          t2.tot) -> t2


t2.grand.tots <- a %>% 
  group_by(hivstatus) %>% 
  summarise(positive = sum(no_diagnosis ==0),
            n = length(no_diagnosis))

rbind(
  t2.grand.tots,
  data.frame(hivstatus = "Total",
             positive = sum(t2.grand.tots$positive),
             n = sum(t2.grand.tots$n))
) ->t2.grand.tots

t2.grand.tots$str <- paste0(t2.grand.tots$positive, "/", t2.grand.tots$n, " (",specify_decimal(t2.grand.tots$positive *100/t2.grand.tots$n, 0), "%)")

t2.grand.tots.pval <- fisher.test(matrix(c(t2.grand.tots$positive[1:3], (t2.grand.tots$n[1:3] - t2.grand.tots$positive[1:3])), ncol = 2))$p.value

t2.grand.tots.pval <- specify_decimal(
t2.grand.tots.pval,3)

t2.grand.tots.pval[t2.grand.tots.pval == "0.000"] <- "<0.001"

round(apply(t2[c(3,8,13,4,9,14)], 1, function(x) fisher.test( matrix(x, ncol = 2))$p.value),3) -> t2$p

t2$prop1[grepl("NaN", t2$prop1)] <- "-"
t2$p[grepl("NaN", t2$p)] <- "-"

t2$type <- as.character(t2$type)

t2 <- t2[c(5,6,4,1,2,3),]
t2$type <- c("Urinary LAM", "Sputum Xpert", "TB blood culture", "Aerobic blood culture", "CSF culture or CRAG", "Malaria RDT")

t2[c(2,5,10,15,19,21)] -> t2
names(t2) <- c("Test", "Positive", "Negative", "Unknown","All", "p")

t2.n <- e1 %>% dplyr::group_by(hivstatus, .drop = FALSE) %>% dplyr::summarise (n = dplyr::n())

rbind(
  data.frame(Test = "Number of participants", Positive = t2.n$n[t2.n$hivstatus == "Reactive"], 
             Negative = t2.n$n[t2.n$hivstatus == "Non reactive"],
             Unknown = t2.n$n[t2.n$hivstatus == "Unknown"],
             All = sum(t2.n$n),
             p = "-"),
  t2
) -> t2



rbind(t2,
      data.frame(Test = "Total with diagnosis",
                 Positive = t2.grand.tots$str[t2.grand.tots$hivstatus == "Reactive"],
                 Negative = t2.grand.tots$str[t2.grand.tots$hivstatus == "Non reactive"],
                 Unknown = t2.grand.tots$str[t2.grand.tots$hivstatus == "Unknown"],
                 All = t2.grand.tots$str[t2.grand.tots$hivstatus == "Total"],
                 p =  t2.grand.tots.pval)) -> t2

kable(t2, "latex", booktabs =T, 
      row.names = F, longtable = F,escape = T,caption = "Diagnostic tests performed and results, stratified by HIV status."  ) %>%
  kable_styling( full_width = F, latex_options = c("HOLD_position")) %>%
group_rows(index=c(" " = 1, "TB diagnostics" = 3, "Other diagnostics" = 3)) %>%
  add_header_above(c(" ", "HIV status" = 3, " ", " ")) %>%
  column_spec(5, bold = TRUE) %>%
  row_spec(8, bold = TRUE) %>%
  footnote(general = "LAM = Lipoarabinomannan, CSF = Cerebrospinal fluid, CRAG = Cryptococcal antigen, RDT = Rapid diagnostic test. p-values are Fisher's exact test across the three HIV status strata, and hence may be different from the pairwise Fisher's tests presented in the text. Urinary LAM and TB blood culture were not carried out in HIV negative participants.", threeparttable = T,  fixed_small_size = T) %>% landscape()

```


```{r sep-euler-plot, echo = F, warning = F, message = F, fig.scap="Venn diagram of positive diagnostic tests", out.extra='', fig.cap="Venn diagram showing overlap of positive diagnostic tests; culture of blood and CSF shown in red, malaria in green and TB diagnostics in blue. The CSF variable in includes either a positive culture for a pathogenic bacteria or positive cryptococcal antigen, BSI a positive aerobic culture of pathogenic bacteria from blood and MTB BSI a positive mycobacterial culture of tuberculosis from blood. BSI: Bloodstream infection, CSF: Cerebrospinal fluid, mRDT: Malaria rapid diagnostic test, MTB BSI: Mycobacterium tuberculosis bloodstream infection, uLAM: urinary lipoarabinomannan.", fig.width = 5, fig.height = 6, out.height = "70%"}

 set.seed (99)
euler(as.data.frame(sapply(a[c(3:8, 10)], as.logical)), shape = "circle") -> eul

plot(eul, edges = "grey30", labels = list(labels = c("BSI","CSF","Malaria","MTB BSI","uLAM","Xpert","No diagnosis"), fontsize = 12), fills = list(fill =c(hue_pal()(3)[1],hue_pal()(3)[1], hue_pal()(3)[2], hue_pal()(3)[3],hue_pal()(3)[3], hue_pal()(3)[3] , "grey" ), alpha = 0.8)) 




```


```{r sep-upset-plot, echo = F, warning = F, message = F, fig.scap="UpSet plot of positive diagnostic tests", out.extra='', fig.cap="UpSet plot of overlap of positive diagnostic tests, showing that for the majority of participants, one test alone is positive. Red colour indicates HIV-infected; black is a composite of HIV-negative and unknown. The CSF variable in includes either a positive culture for a pathogenic bacteria or positive cryptococcal antigen, BSI a positive aerobic culture of pathogenic bacteria from blood and MTB BSI a positive mycobacterial culture of tuberculosis from blood. BSI: Bloodstream infection, CSF: Cerebrospinal fluid, CRAG: Cryptococcal antigen, mRDT: Malaria rapid diagnostic test, MTB BSI: Mycobacterium tuberculosis bloodstream infection, uLAM: urinary lipoarabinomannan.", fig.width = 6, fig.height = 5, out.height = "50%"}



names(a) <- c("pid", "hivstatus", "BSI", "CSF culture/CRAG +", "mRDT", "MTB BSI", "uLAM+", "Sputum Xpert+",
              "tb", "No Diagnosis")

#upset(a[-9], nsets = 7,order = "freq", queries = list(list(query = elements, params = list("hivstatus", "Reactive", color = "#FC8D62" , active = T)))) 

#pdf(file = paste0(wd, "figures/upset.pdf"), width = 6, height = 5)
upset(a[-9], nsets = 7,order = "freq", query.legend = "bottom",
      queries = list(
        list(query = elements, params = list("hivstatus", "Reactive"), color = pal_lancet()(2)[2] , active = T, 
             query.name = "HIV+")
      )
)
#dev.off()      
 


```

```{r sep-bc-plot, echo = F, warning = F, message = F, fig.scap="Pathogenic isolates recovered from aerobic blood culture.", out.extra='', fig.cap="Pathogenic isolates recovered from aerobic blood culture. 26 blood cultures in 24 participants were positive for 28 pathogens in total.", fig.width = 7, fig.height = 2.3, out.height= "70%"}

melt(bc.full[c("pid", "typhi", "saen", "saty", "esco","klpn", "hib", "stpn", "crne", "acba", "enfam", "enfas", "stau", "prot")]) %>% filter (value > 0) -> bc.full.melt



merge(bc.full.melt, select(enroll, pid, hivstatus)) -> bc.full.melt

bc.full.melt$hivstatus <- factor(bc.full.melt$hivstatus, levels = c("Reactive", "Non reactive", "Unknown"))


ggplot(bc.full.melt, aes(fct_rev(fct_infreq(variable)), fill = hivstatus)) + geom_bar(alpha = 0.8) + coord_flip() + scale_fill_manual(values = c(pal_lancet()(2)[c(2,1)], "darkgrey"), labels = c("HIV+", "HIV-", "Unknown"), name = "HIV status") + theme_bw() +
  scale_x_discrete("", labels = expression(italic("Proteus mirabilis"),italic("Enterococcus faecium"),italic("Acinetobacter baumannii"), italic("Streptococcus pneumoniae"),italic("Haemophilus influenzae"),italic("Klebsiella pneumoniae"),italic("Stapylococcus aureus"),italic("Cryptococcus neoformans"),paste(italic("Salmonella"), "Typhimurium"),italic("Escherichia coli"),paste(italic("Salmonella"), "Typhi"))) + scale_y_continuous(name = "n", breaks = c(0,2,4,6,8,10)) 


```


### Treatment

At least one antimicrobial drug was received by 214/225 (95%) of the cohort during their admission (Table \@ref(tab:time-to-ab-table)), most commonly an antibacterial (207/225 [92%]), but also a significant minority received antituberculous chemotherapy (63/225 [28%]). Of those receiving antituberculous therapy, 10/63 (16%) were taking the medication prior to admission, and the remainder were initiated on therapy during admission. The first antibacterial agent administered was most often ceftriaxone, (181/207 [87%]) but ciprofloxacin (9%), amoxicillin (3%) and metronidazole (1%) were also used. Median door to antimicrobial time was 5.3 hours (IQR 3.7-10.8) for antibacterials and 4.5 hours (IQR 3.1-21.7) for antimalarials but longer for antifungals at 47.7 hours (IQR 27.9-73.9) and longer still for antitubercular therapy at 120.9 hours (IQR 63.7-171.0). Cumulative incidence curves for administration of the different antimicrobial classes are shown in Figure \@ref(fig:sep-abtime-fluid-plot)A-D.

Of all participants, 85% (192/225) received any intravenous fluid in the first 6 hours of enrolment to the study; of these, most received 0.9% saline (160/192 [83%] of those receiving fluid) but 5% dextrose (91/192 [57%]) were also used; Ringer's lactate (6/192 [6%]) and blood (2/192 [1%]) were rarely administered. Of the 192 patients who were administered any fluid, a median of 1.5L (IQR 1.0-2.0L) was administered over the 6hr study period; fluid administration as a function of time is shown in Figure \@ref(fig:sep-abtime-fluid-plot)E.

```{r treatment-setup, include = F}

df.abs$event <- as.numeric(!df.abs$first_ab == "none")
df.abs$t <- df.abs$time_to_abx
df.abs$t[df.abs$event == 0] <- 1000

df.tb$event <- as.numeric(df.tb$any_tb_rx == "yes" | df.tb$any_tb_rx == "on admission")
df.tb$t <- df.tb$time_to_tb_rx
df.tb$t[df.tb$any_tb_rx == "on admission"] <- 0
df.tb$t[df.tb$any_tb_rx == "none"] <- 1000


df.mal$event <- as.numeric((!is.na(df.mal$time_to_mal_rx)))
df.mal$t <- df.mal$time_to_mal_rx
df.mal$t[df.mal$event == 0] <- 1000

df.fung$event <- as.numeric((!is.na(df.fung$time_to_fung_rx)))
df.fung$t <- df.fung$time_to_fung_rx
df.fung$t[df.fung$event == 0] <- 1000

survfit(Surv(t, event) ~ 1, data = df.fung) -> fit.fung
survfit(Surv(t, event) ~ 1, data = df.mal) -> fit.mal
survfit(Surv(t, event) ~ 1, data = df.tb) -> fit.tb
survfit(Surv(t, event) ~ 1, data = df.abs) -> fit

fit$am.type <- "abs"
fit.tb$am.type <-"tb"
fit.mal$am.type <-"malaria"
fit.fung$am.type <-"antifucngals"

fit.all <- bind_rows(
  data.frame(time = fit$time, surv = fit$surv, 
             lower= fit$lower, upper = fit$upper,
             type = "abs", stringsAsFactors = F),
  data.frame(time = fit.tb$time, surv = fit.tb$surv, 
             lower= fit.tb$lower, upper = fit.tb$upper,
             type = "tb", stringsAsFactors = F),
  data.frame(time = fit.mal$time, surv = fit.mal$surv, 
             lower= fit.mal$lower, upper = fit.mal$upper,
             type = "malaria", stringsAsFactors = F),
  data.frame(time = fit.fung$time, surv = fit.fung$surv, 
             lower= fit.fung$lower, upper = fit.fung$upper,
             type = "antifungal", stringsAsFactors = F),
  
)

ab_sum_tbl <- data.frame(
  antimicrobial = c(rep("Antibacterial",1), rep("Antimalarial",1), 
                    rep("Antifungal",1),  rep("Antitubercular",1)),
  t = c(median_iqr_str(as.numeric(df.abs$time_to_abx),1),median_iqr_str(as.numeric(df.mal$time_to_mal_rx),1),
        median_iqr_str(as.numeric(df.fung$time_to_fung_rx),1),median_iqr_str(as.numeric(subset(df.tb, any_tb_rx == "yes")$time_to_tb_rx),1)),
  n = c(prop_str(as.numeric(df.abs$event))[[1]], prop_str(as.numeric(df.mal$event))[[2]],
        prop_str(as.numeric(df.fung$event))[[2]], paste0(prop_str(as.numeric(df.tb$event))[[2]], "*"))
)

ab_sum_tbl[c(1,3,2)] -> ab_sum_tbl
ab_sum_tbl[c(1,4,3,2),] -> ab_sum_tbl

```

```{r time-to-ab-table, echo =F, warning=F, message=F}

kable(ab_sum_tbl, "latex", booktabs =T, 
      row.names = F, longtable = F,escape = T,
      caption = "Door-to-antimicrobial times.",
      col.names = c("Antimicrobial class", "No. participants", "Median [IQR] time (hours)")) %>%
  kable_styling( full_width = F) %>%
  footnote(symbol = "10/63 participants who received antitubercular agents during admission were taking them prior to admission; they are excluded from the calculation of median door-to-antimicrobial time for this class. ", threeparttable = T, fixed_small_size = T)

subset(e1, !(pid %in% subset(df.abs, first_ab != "none")$pid | pid %in% subset(df.mal, !is.na(first_ab))$pid  | 
               pid %in% subset(df.fung, !is.na(first_ab))$pid   | pid %in%  subset(df.tb,any_tb_rx != "none")$pid ))$pid -> a


```

```{r treatment-plot-setup, include = F}


brk <-  seq(0,192, 24)

p.abs <- ggplot(filter(fit.all, type == "abs"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,1), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw()+ scale_x_continuous(breaks =brk)

p.tb <- ggplot(filter(fit.all, type == "tb"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.3), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw()  + scale_x_continuous(breaks =brk)

p.mal <- ggplot(filter(fit.all, type == "malaria"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.15), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw() + scale_x_continuous(breaks =brk)

p.fung <- ggplot(filter(fit.all, type == "antifungal"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.15), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw() + scale_x_continuous(breaks =brk)

ggplot(fluid %>% pivot_longer(-pid), aes(name, value)) + geom_jitter(size = 0.5, color = "darkgrey") + geom_boxplot(alpha = 0.6, width = 0.5, outlier.shape = NA) + theme_bw() + labs(x= "Time (hours)", y = "Volume (ml)") -> p.fluid


            
  
##pp <- ggdraw() +
##  draw_plot(p.abs) +
##  draw_plot(plt.inset, x = 0.3, y = 0.1, width = 0.5, height = 0.5)

```

```{r sep-abtime-fluid-plot, echo = F, warning = F, message = F, fig.scap="Antimicrobial and fluid administration as a function of time.", out.extra='', fig.cap="Timing of antimicrobial and fluid administration. A-D: Cumulative incidence of administration of antibacterial (A), antitubercular (B), antifungal (C) and antimalarial (D) agents as a function of time since arrival at hospital in hours. E: Total volumne of administered intavenous fluid as a function of time since enrollment to study in hours. Boxplots show median, quartiles box and 1.5 times interquartile range as whiskers. Points are jittered around the hour at which they were measured to show distribution. ", fig.width = 6, fig.height = 8, out.width= "80%", fig.align= "center"}

ggarrange(
  ggarrange(p.abs, p.tb, ncol = 2, nrow = 1, labels = c("A", "B")), 
  ggarrange(p.fung, p.mal, ncol = 2, nrow = 1, labels = c("C", "D")),
  ggarrange(NULL, p.fluid, NULL, ncol = 3, nrow = 1, widths = c(0.5,1,0.5), labels = c(NA, "E", NA)),
            ncol = 1,nrow = 3)

```

### Outcome

```{r los-setup, include = F}

los <- merge(select(e1, pid, data_date), select(oc, pid, hospoutcome, hoc.datetime ), all.x = T)
los$hoc.datetime <- date(los$hoc.datetime)
los$los <- difftime(los$hoc.datetime, los$data_date, units = "days")

los_str <- median_iqr_str(as.numeric(subset(los, hospoutcome ==1)$los))


```

Median hospital stay was 4 (IQR 1-9) days. Case fatality rate was 18% (95% CI 13-23%) at 28 days, 24% (95% CI 18-30%) at 90 days and 31% (95% CI 25-38) at 180 days, and higher in HIV-infected participants at each time point (Table \@ref(tab:outcome-table)), though not statistically significant on pairwise Fisher's exact test (HIV-infected vs noninfected 19% vs 13%, [p = 0.14] at 28 days, 27% vs 17%, [p = 0.44] at 90 days and 36% vs 21% [p = 0.29] at 180 days). Kaplan-meier estimation of the survival function (Figure \@ref(fig:outcome-km-plots)) showed a precipitous decline in survivorship to around day 30 and cfr declined thereafter, to the end of the study period. Stratifying the analysis by HIV status revealed that early deaths (within the first 1-2 weeks) occur at similar rates in the two groups before the curves diverge; log-rank test suggested a significant difference in survival function between the two groups (p = 0.03). In view of the fact that a number of the HIV-infected participants were likely to be failing ART, only two were recorded as switching to second line therapy during the study period, though details of any interventions (e.g. ART adherence counselling) or HIV viral load testing carried out as part of routine care were not captured.

Health related quality of life measures, as assessed by EQ-5D-3L, are shown in Figure \@ref(fig:outcome-morbidity) for participants with sepsis and the community cohort as a comparator. Acutely, participants with sepsis reported were significantly disabled, reporting at least moderate impairment across all domains in the majority of cases, and over 90% of participants reporting at least moderate impairment in activities of daily living and experiencing at least moderate pain or discomfort. However, recovery following treatment in survivors was rapid. The mean EQ-5Q utility score (a measure of the weight compared to a health state compared to 1, perfect health) of healthy community controls was 0.910 (SD 0.102) at enrolment, significantly higher than participants with sepsis at enrolment (utility score 0.496 (SD 0.251), p = < 0.0001 versus community scores by t-test), but comparable to participants with sepsis at their 12 week assessment (0.913 (SD 0.147), p = 0.903 versus community enrolment scores).

```{r outcome-table, echo =F, warning=F, message=F}

v1 <- visits %>% filter(arm == 1) 

v1$t <- apply(v1[7:10], 1,max, na.rm= T )

v1$t[!is.na(v1$died_date)] <- v1$died_date[!is.na(v1$died_date)]

#v1$t <- v1$t * 7
v1$died <- v1$status
v1$died[v1$died == 2] <- 0

v1 <- select(v1, pid, enrolled, arm, t, died)

#v1$d28_death

v1$d28_death <- NA

v1$d28_death[(v1$t <= 28) & (v1$died == 1)] <- 1
v1$d28_death[(v1$t >= 28)] <- 0

v1$d90_death[(v1$t <= 90) & (v1$died == 1)] <- 1
v1$d90_death[(v1$t >= 90)] <- 0

v1$d180_death[(v1$t <= 180) & (v1$died == 1)] <- 1
v1$d180_death[(v1$t >= 180)] <- 0

merge(v1, select(enroll, pid, hivstatus)) -> v1

v1$died <- as.numeric(v1$died)


merge(
v1 %>% 
  dplyr::select(pid, hivstatus, d28_death, d90_death, d180_death) %>% 
  pivot_longer(-c(pid, hivstatus)) %>% group_by(name, hivstatus) %>%
  summarise(n = sum(!is.na(value)), mort =  prop_confint_str(value)) %>%
  pivot_wider(id_cols = c(name), names_from = hivstatus, values_from = c(n,mort)),

v1 %>% 
    dplyr::select(pid, hivstatus, d28_death, d90_death, d180_death) %>% 
    pivot_longer(-c(pid, hivstatus)) %>% group_by(name) %>%
    summarise(n = sum(!is.na(value)), mort =  prop_confint_str(value)),
by = "name") -> mort

mort[,c(1,3,6,2,5,4,7, 8, 9)] -> mort
mort[c(2,3,1),] -> mort
mort$name <- c("Day 28", "Day 90", "Day 180")

#(gsub("%", "\\\\%", mort[c(3,5,7,9)])) -> mort[c(3,5,7,9)]

kable(mort, "latex", booktabs =T,  row.names = F, longtable = F,escape = TRUE,
      caption = "Day 28, 90 and 180 mortality stratified by HIV status",
      col.names = c(" ", "n", "Mortality" , "n", "Mortality", "n", "Mortality","n", "Mortality" )) %>%
        add_header_above(c(" " = 1, "HIV+" = 2, "HIV-" = 2, "HIV Unknown" = 2, "Total" = 2)) %>%
  kable_styling( full_width = F) %>%
    column_spec(8, bold = T) %>% 
  column_spec(9, bold = T) %>%
  footnote(general = "n in this table indicates the number of patients with known vital status, contributing data at the given time point (i.e. not lost to follow up, withdrawn, or transferred out).", threeparttable = T, fixed_small_size = T)

# calc p values

v1 %>% dplyr::select(pid, hivstatus, d28_death, d90_death, d180_death) %>% 
  pivot_longer(-c(pid, hivstatus)) %>% group_by(name, hivstatus) %>%
  summarise(n = (sum(!is.na(value))), dead = sum(sum(value == 1, na.rm = T))) ->ft

#fisher.test(ft[1:2,3:4])
```

```{r outcome-km-plots, echo =F, warning=F, message=F,fig.scap="Kaplan-Meier survival curves.", out.extra='', fig.cap="Kaplan-Meier survival curves of all included participants (A) and stratified by HIV status (B). Crosses indicate censoring. p value from log-rank test comparing survival of HIV-infected to HIV-noninfected participants shown (p = 0.03).", fig.width= 8, fig.height =4, }

psurv1 <- ggsurvplot(survfit(Surv(t,died) ~ 1, data = v1), conf.int = T, xlim = c(0, 190), ylim = (c(0.6,1)), ggtheme = theme_bw(), palette = "black", size = 0.5,legend = "none", break.time.by = 30)

psurv1 <- psurv1$plot

psurv2 <- ggsurvplot(survfit(Surv(t,died) ~ hivstatus, data = subset(v1, hivstatus != "Unknown")), conf.int = T, xlim = c(0, 190), ylim = (c(0.6,1)), ggtheme = theme_bw(), size = 0.5, break.time.by = 30, pval = TRUE, pval.coord = c(15,0.65), pval.size = 4)

psurv2 <- psurv2$plot

psurv2 + theme(legend.position = "right", legend.title = element_blank()) + scale_fill_manual(labels = c("HIV-", "HIV+"), values = pal_lancet()(2)[c(1,2)]) + scale_color_manual(labels = c("HIV-", "HIV+"), values = pal_lancet()(2)[c(1,2)]) -> psurv2

ggarrange(psurv1, psurv2, labels = c("A", "B"), widths = c(0.8,1))
```

```{r outcome-morbidity, echo =F, warning=F, message=F,fig.scap="Health-related QoL following admission with sepsis.", out.extra='', fig.cap="Health-related quality of life following sepsis admission, compared to community controls, showing a return to usual quality of life by 12 weeks following admission. A: proportion of participants across each of the five domains of the EQ-5D questionnaire who report at least moderate impariment. B: EQ-5D utility score derived using the Zimbabwean tariff set. The utility score is interpreted as the weight attached to a health state compared to perfect health, which is assigned a value of 1. By 12 weeks there is no statistically significant difference between sepsis and baseline community participant utility scores (p = 0.90 by t-test).", fig.width= 9, fig.height =5, }

eq <- read.csv("/Users/joelewis/Documents/PhD/Data/Current/portal_downloads/dassim_eq05_raw.csv", stringsAsFactors = F)



eq$assess_date2 <- parse_date(eq$assess_date, "%d-%b-%Y")

eq <- select(eq, -data_date)
names(eq)[names(eq) == "assess_date"] <- "data_date"


merge(eq, select(followup, pid, data_date, d2visit ), by = c("pid", "assess_date2"), by.y = c("pid", "data_date"), all.x = T) -> eq

eq$d2visit <- eq$d2visit + 1

eq$visit_type[is.na(eq$visit_type)] <- eq$d2visit[is.na(eq$visit_type)]

eq <- merge(eq, select(enroll,pid, arm, hivstatus), all.x = T)



eq %>% select(arm, visit_type, walk, self, usual, pain, anxiety) %>% 
  pivot_longer(-c(arm, visit_type)) %>% filter(!is.na(arm) & !is.na(value) & !is.na(visit_type)) %>% 
  group_by(arm, visit_type, name) %>% summarise(x = sum(value >= 2), 
                                                n = n(), 
                                                prop = x / n,
                                                lci = binom.test(x,n)$conf.int[[1]],
                                                uci = binom.test(x,n)$conf.int[[2]]) -> eq.1

eq.1$name[eq.1$name == "anxiety"] <- "Anxiety"
eq.1$name[eq.1$name == "pain"] <- "Pain"
eq.1$name[eq.1$name == "self"] <- "Self Care"
eq.1$name[eq.1$name == "usual"] <- "Usual Activities"
eq.1$name[eq.1$name == "walk"] <- "Walking"

eq.1$visit_type[eq.1$visit_type == 1] <- 0
eq.1$visit_type[eq.1$visit_type == 2] <- 1
eq.1$visit_type[eq.1$visit_type == 4] <- 12
eq.1$visit_type[eq.1$visit_type == 3] <- 4

eq.1$visit_type[eq.1$visit_type == 5] <- 24

eq.1 <- subset(eq.1, arm %in% c(1,3))
eq.1$arm[eq.1$arm == 1] <- "Sepsis"
eq.1$arm[eq.1$arm == 3] <- "Community"
eq.1$arm <- factor(eq.1$arm, levels = c("Sepsis", "Community"))

ggplot(eq.1, aes(visit_type,prop, color = arm, group = arm) ) + 
  geom_point( aes(shape = arm)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci, ymax = uci, fill = arm), color = NA, alpha = 0.3) +
  geom_point( aes(shape = arm), data = subset(eq.1, arm == "Sepsis")) + 
  geom_line(data = subset(eq.1, arm == "Sepsis")) +
  facet_wrap(~name, nrow = 1) + 
  theme_bw() + labs(x = "Week post enrolment", y = "Proportion") +
  theme(legend.title = element_blank())  -> p1 #+
 # scale_color_manual(values = c("black", "darkgrey")) 

eq$arm[eq$arm == 1] <- "Sepsis"
eq$arm[eq$arm == 3] <- "Community"

eq$visit_type[eq$visit_type == 1] <- 0
eq$visit_type[eq$visit_type == 2] <- 1
eq$visit_type[eq$visit_type == 4] <- 12
eq$visit_type[eq$visit_type == 3] <- 4

eq$visit_type[eq$visit_type == 5] <- 24

eq$arm <- factor(eq$arm, levels = c("Sepsis", "Community", 2, 4))

  names(eq)[names(eq) == "walk"] <- "MO"
  names(eq)[names(eq) == "self"] <- "SC"
  names(eq)[names(eq) == "usual"] <- "UA"
  names(eq)[names(eq) == "pain"] <- "PD"
  names(eq)[names(eq) == "anxiety"] <- "AD"
  
  eq$utility_score <- NA
  eq$utility_score[complete.cases(eq[8:12])] <-  eq5d(eq[8:12][complete.cases(eq[8:12]),],version = "3L", type = "TTO", country = "Zimbabwe") 
  
  ggplot(subset(eq, arm != 2 & arm != 4 & !is.na(visit_type) ), 
         aes(as.factor(visit_type), utility_score, fill = arm, color = arm)) +
geom_boxplot(outlier.size = 0.5, alpha = 0.3, width = 0.5, position = position_dodge2(preserve = "single"), outlier.alpha = 1) +
theme_bw() +
#geom_hline(linetype = "dashed", yintercept = median(subset(eq, arm == 3)$vas_score )) +
    theme(legend.title = element_blank()) +
    labs(y = "Utility score", x= "Week post enrolment") -> p2

  ggarrange(p1, ggarrange(NULL,p2,NULL, ncol = 3, nrow = 1,
                          widths = c(0.15,1,0.15), labels = c(NA, "B", NA)),
            ncol = 1, nrow = 2, labels = c("A", NA))


```

### Determinants of mortality

Bivariable associations of mortality are shown in Table \@ref(tab:bivariate-sev-mort-assoc) with variables grouped into putative host, severity, diagnosis and treatment variables. Variables associated with immunosuppression - CD4 count and haemoglobin - were associated with death in unadjusted analysis, as were well recognised markers of disease severity: shock, hypoxia, reduced conscious level, hyperlactataemia, and inability to ambulate, as were reduced venous bicarbonate and increased venous urea. A diagnosis of malaria was strongly associated with survival (0/21 died). Conversely, a diagnosis of meningitis was associated with mortality (Table \@ref(tab:bivariate-sev-mort-assoc)) though numbers were small (n = 4). Receipt of antibacterials, antifungals or antimalarials showed no association with mortality, though almost all participants received antibacterials and only a minority antimalarials and antifungals, so moderate effect sizes would be unlikely to be detected. However, receipt of antituberculous chemotherapy therapy was associated with survival: 8% (4/53) of participants receiving TB therapy died compared to 21% (35/169) who did not receive it (p = 0.04 by Fisher's exact test). 

All of these associations are likely to be affected by confounding, so I constructed logistic regression models to attempt to produce unbiased effect estimates (Table \@ref(tab:log-reg-mod-tab). There were some difficulties with these models. Separation occurred when malaria and meningitis diagnoses were included - they perfectly predicted outcome, so parameter estimates become unstable - and so they were excluded from the model. Receipt of TB therapy remained strongly associated with survival (aOR 0.17 [95% CI 0.03-0.74]) as did higher haemoglobin (aOR 0.69 [95% CI 0.52-0.86] per 1g $dL^{-1}$ increase) and higher oxygen saturation (aOR 0.67 [95% CI 0.47-0.96] per 5% increase). Perhaps surprisingly, an _increased_ respiratory rate was associated with survival (aOR 0.35 (0.14-0.81) per 10 breaths min$^{-1}$ increase; less surprisingly, inability to stand on admission strongly predicted mortality (aOR 14.55 [95% CI 3.81-69.78]).

```{r bivariate-sev-mort-assoc, echo =F, warning=F, message=F}

df.temp <- dplyr::select(df,pid, d28_death, hivstatus,hivonart, calc_age,ptsex,screentemp, t0sbp, t0dbp, t0map, t0hr, t0rr, t0spo2, gcs, ustand, lactate_value,
                         WCC, CD4_Absolute, Haemoglobin, Platelets, NA.,Potassium, Urea, Creatinine, CO2, Chloride, fluid_6hr, any_tb_rx, time_to_tb_rx, first_mal_rx, time_to_mal_rx, first_fung_rx, time_to_fung_rx, first_ab, time_to_abx, fluid_6hr,
                         bc, tb, csf, malaria
) 

df.temp$fluid_6hr <- df.temp$fluid_6hr/1000

apply(df.temp[c("tb", "malaria", "bc", "csf")], 1, sum) -> df.temp$n_diagnoses


#df.temp2 <- subset(df.temp2, n_diagnoses < 2 & csf == 0)

df.temp$no_diagnosis <- as.numeric(df.temp$n_diagnoses == 0)


df.temp$time_to_abx <- as.numeric(df.temp$time_to_abx)
df.temp$time_to_tb_rx <- as.numeric(df.temp$time_to_tb_rx)
df.temp$time_to_mal_rx <- as.numeric(df.temp$time_to_mal_rx)
df.temp$time_to_fung_rx <- as.numeric(df.temp$time_to_fung_rx)

df.temp$any_ab <- as.numeric(df.temp$first_ab != "none")
df.temp$any_mal_rx <- as.numeric(!is.na(df.temp$first_mal_rx))
df.temp$any_fung_rx <- as.numeric(!is.na(df.temp$first_fung_rx))

df.temp$any_tb_rx[df.temp$any_tb_rx == "on admission"] <- "none"
df.temp$any_tb_rx[df.temp$any_tb_rx == "none"] <- 0
df.temp$any_tb_rx[df.temp$any_tb_rx == "yes"] <- 1
df.temp$any_tb_rx <- as.numeric(df.temp$any_tb_rx)

df.temp <- dplyr::select(df.temp, -c(first_mal_rx, first_fung_rx, first_ab, n_diagnoses))

df.temp[df.temp == 999] <- NA

df.temp$CD4_Absolute[df.temp$hivstatus != "Reactive"] <- NA
df.temp$hivstatus[df.temp$hivstatus == "Reactive"] <- 1
df.temp$hivstatus[df.temp$hivstatus == "Non reactive"] <- 0
df.temp$hivstatus[df.temp$hivstatus == "Unknown"] <- NA
df.temp$hivstatus <- as.numeric(df.temp$hivstatus)


df.temp$ptsex[df.temp$ptsex == "Male"] <- 1
df.temp$ptsex[df.temp$ptsex == "Female"] <- 0
df.temp$ptsex <- as.numeric(df.temp$ptsex)

df.temp$hivonart[df.temp$hivonart == "Yes"] <- 1
df.temp$hivonart[df.temp$hivonart == "No"] <- 0
df.temp$hivonart <- as.numeric(df.temp$hivonart)
#df.temp$ustand <- as.character(df.temp$ustand)

df.temp$t0sbp[is.na(df.temp$t0sbp)] <- 50
df.temp$t0dbp[is.na(df.temp$t0dbp)] <- 30
df.temp$t0map[is.na(df.temp$t0map)] <- 36.6

df.temp %>% select(-c(hivstatus, ptsex, ustand, hivonart, any_ab, any_fung_rx, any_mal_rx, any_tb_rx,  time_to_mal_rx, malaria, tb, no_diagnosis, csf, bc, pid)) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name) %>% dplyr::summarise(pval = kruskal.test(value ~ d28_death)$p.value) -> pvals

df.temp %>% select(-c(hivstatus, ptsex, ustand, hivonart, any_ab, any_fung_rx, any_mal_rx, any_tb_rx,  tb, no_diagnosis, csf, bc, malaria, pid)) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, d28_death) %>% dplyr::summarise( median = median(value, na.rm = T),
                                                             LQ = quantile(value, 0.25, na.rm = T),
                                                              UQ = quantile(value, 0.75, na.rm = T)) -> p




paste0(
  specify_decimal(p$median, 1), " (",
  specify_decimal(p$LQ, 1), "-",
  specify_decimal(p$UQ, 1) ,")"
) -> p$med_str

p %>% select(name, d28_death, med_str) %>% pivot_wider(names_from = d28_death, values_from = med_str) -> p

p <- merge(p, pvals, all.x = T)


df.temp %>% dplyr::select(d28_death, hivstatus, hivonart, ptsex, ustand, any_ab, any_fung_rx, any_mal_rx, any_tb_rx, bc, tb, malaria, csf, no_diagnosis) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, value) %>%
  dplyr::summarise(died = sum(d28_death == 1, na.rm = T), alive = sum(d28_death == 0, na.rm = T)) %>% filter(!is.na(value)) %>% group_by(name) %>%
   group_by(name) %>% dplyr::summarise(pval = fisher.test(matrix(c(died, alive), ncol =2))$p.value) -> p.catpvals

df.temp %>% dplyr::select(d28_death, hivstatus, hivonart, ptsex, ustand, any_ab, any_fung_rx, any_mal_rx, any_tb_rx, bc, tb, malaria, csf, no_diagnosis) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, d28_death) %>% dplyr::summarise(`1` = sum(value == 1, na.rm = T), 
                                                        total = sum(!is.na(value)),
                                                        prop = `1`/total) -> p.cat

p.cat$str <- paste0(
  p.cat$`1`, "/", p.cat$total,
  " (", specify_decimal(p.cat$prop *100,0), "%)"
)


p.cat %>% select(name, d28_death, str) %>% pivot_wider(names_from = d28_death, values_from = str) -> p.cat
p.cat <- merge(p.cat, p.catpvals)



p <- bind_rows(p,p.cat)

p$boldcol <- FALSE 
p$boldcol[p$pval <= 0.05] <- TRUE

p$pval <- specify_decimal(p$pval, 3)
p$pval[p$pval == "0.000"] <- "<0.001"


#p[match(c("calc_age", "ptsex", "hivstatus", "hivonart","CD4_Absolute", "Haemoglobin","screentemp", "t0hr", "t0sbp", "t0dbp", "t0map",
#        "t0rr", "t0spo2","gcs", "ustand", "lactate_value" , "WCC", "Platelets", "NA.", "Potassium",
#        "Chloride", "CO2", "Urea", "Creatinine", "bc", "tb", "malaria", "csf", "no_diagnosis",
#        "any_ab", "time_to_abx", "any_fung_rx","time_to_fung_rx", "any_mal_rx", "time_to_mal_rx", "any_tb_rx","time_to_tb_rx", "fluid_6hr"), p$name),] -> p

p[match(c("calc_age", "ptsex", "hivstatus", "hivonart","CD4_Absolute", "Haemoglobin","screentemp", "t0hr", "t0sbp", "t0dbp", "t0map",
        "t0rr", "t0spo2","gcs", "ustand", "lactate_value" , "WCC", "Platelets", "CO2", "Urea", "Creatinine", "bc", "tb", "malaria", "csf", "no_diagnosis",
        "any_ab", "time_to_abx", "any_fung_rx","time_to_fung_rx", "any_mal_rx", "time_to_mal_rx", "any_tb_rx","time_to_tb_rx", "fluid_6hr"), p$name),] -> p


p <- p[c("name", "1", "0", "pval", "boldcol")]
names(p) <- c("Variable", "Died", "Survived", "p", "boldcol")

boldrows <- which(p$boldcol %in% TRUE)

p$Variable[p$Variable == "calc_age"] <- "Age (years)"
p$Variable[p$Variable == "ptsex"] <- "Male sex"
p$Variable[p$Variable == "hivstatus"] <- "HIV Infected\\textsuperscript{*}"
p$Variable[p$Variable == "hivonart"] <- "Taking ART\\textsuperscript{\\dag}"
p$Variable[p$Variable == "Haemoglobin"] <- "Haemoglobin (x10\\textsuperscript{9} g dL\\textsuperscript{-1})"
p$Variable[p$Variable == "CD4_Absolute"] <- "CD4 count\\textsuperscript{\\dag} ($\\mu$L\\textsuperscript{-1})"
p$Variable[p$Variable == "screentemp"] <- "Temperature (\\textdegree C)"
p$Variable[p$Variable == "t0hr"] <- "Heart rate (min\\textsuperscript{-1}))"
p$Variable[p$Variable == "t0sbp"] <- "Systolic BP (mmHg)"
p$Variable[p$Variable == "t0dbp"] <- "Diastolic BP (mmHg)"
p$Variable[p$Variable == "t0map"] <- "Mean arterial BP (mmHg)"
p$Variable[p$Variable == "t0rr"] <- "Respiratory rate (min\\textsuperscript{-1}))"
p$Variable[p$Variable == "t0spo2"] <- "Oxygen saturation (%)"
p$Variable[p$Variable == "gcs"] <- "GCS"
p$Variable[p$Variable == "ustand"] <- "Unable to stand"
p$Variable[p$Variable == "lactate_value"] <- "Lactate (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "WCC"] <- "White cell count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p$Variable[p$Variable == "Platelets"] <- "Platelet count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p$Variable[p$Variable == "NA."] <- "Sodium (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Potassium"] <- "Potassium (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "CO2"] <- "Bicarbonate (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Urea"] <- "Urea (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Creatinine"] <- "Creatinine (mmol L\\textsuperscript{-1})"

p$Variable[p$Variable == "bc"] <- "BSI"
p$Variable[p$Variable == "tb"] <- "TB"
p$Variable[p$Variable == "malaria"] <- "Malaria"
p$Variable[p$Variable == "csf"] <- "Meningitis"
p$Variable[p$Variable == "no_diagnosis"] <- "No diagnosis"

p$Variable[p$Variable == "any_ab"] <- "Antibacterials"
p$Variable[p$Variable == "time_to_abx"] <- "Time to Antibacterials (hr)"
p$Variable[p$Variable == "any_fung_rx"] <- "Antifungals"
p$Variable[p$Variable == "time_to_fung_rx"] <- "Time to Antifungals (hr)"
p$Variable[p$Variable == "any_mal_rx"] <- "Antimalarials"
p$Variable[p$Variable == "time_to_mal_rx"] <- "Time to Antimalarials (hr)"
p$Variable[p$Variable == "any_tb_rx"] <- "Antimycobacterials"
p$Variable[p$Variable == "time_to_tb_rx"] <- "Time to Antimycobacterials (hr)"

p$Variable[p$Variable == "fluid_6hr"] <- "IV fluid (L)"

sub("%", "\\\\%", p$Died) -> p$Died
sub("%", "\\\\%", p$Survived) -> p$Survived

sub("%", "\\\\%", p$Variable) -> p$Variable



kable(select(p,-boldcol), "latex", booktabs =T, 
      row.names = F, longtable = F, ,escape = F,caption = "Bivariate associations with death by 28 days" ) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  row_spec(boldrows, bold = T) %>%
  pack_rows("Host Variables", 1,6, bold = F) %>% 
   pack_rows("Severity Variables", 7, 21, bold = F)  %>%
    pack_rows("Diagnosis", 22,26, bold = F) %>% 
   pack_rows("Treatment Received", 27, 35, bold = F)  %>%
  footnote(general = "BP = Blood pressure, GCS = Glasgow coma scale. Numeric variables are presented as median (IQR) and categorical variables as proportions. P-values are from Kruskal-Wallace test for continuous variables and Fisher's exact test for categorical variables." , symbol = c("Participants with HIV status unknown not included in this row","Includes only HIV-infected participants"), threeparttable = T, fixed_small_size = T)

df.temp$fluid_6hr <- df.temp$fluid_6hr * 1000

```

```{r log-reg-mod-tab, echo = FALSE, warning=FALSE, message = FALSE}

df.mod <- dplyr::select(df.temp, screentemp, d28_death, hivstatus, 
calc_age, ptsex, screentemp, t0map, t0hr, t0rr, t0spo2,
gcs,ustand, lactate_value, WCC, Haemoglobin, Platelets,
CO2, Urea, Creatinine, fluid_6hr, any_tb_rx, any_ab, any_mal_rx, any_fung_rx,
bc, tb, csf, malaria)

df.mod$hivstatus[is.na(df.mod$hivstatus)] <- "uk"

# uv OR

vars <- names(df.mod[-2])
uv_mods <- list()
for (i in 1:length(vars)) {
uv_mods[[i]] <- glm(d28_death ~ ., data = df.mod[c("d28_death", vars[i])], family = binomial)  
}

do.call(rbind, lapply(uv_mods, function(x) bind_cols(tidy(x), confint_tidy(x)))) -> uv_mods
uv_mods <- subset(uv_mods, term != "(Intercept)")

uv_mods[uv_mods$term == "calc_age",][c(2,6:7)] <- uv_mods[uv_mods$term == "calc_age",][c(2,6:7)] * 5
uv_mods[uv_mods$term == "t0map",][c(2,6:7)] <- uv_mods[uv_mods$term == "t0map",][c(2,6:7)] * 10
uv_mods[uv_mods$term == "t0hr",][c(2,6:7)] <- uv_mods[uv_mods$term == "t0hr",][c(2,6:7)] * 10
uv_mods[uv_mods$term == "t0rr",][c(2,6:7)] <- uv_mods[uv_mods$term == "t0rr",][c(2,6:7)] * 10
uv_mods[uv_mods$term == "t0spo2",][c(2,6:7)] <- uv_mods[uv_mods$term == "t0spo2",][c(2,6:7)] * 5
uv_mods[uv_mods$term == "Platelets",][c(2,6:7)] <- uv_mods[uv_mods$term == "Platelets",][c(2,6:7)] * 100
uv_mods[uv_mods$term == "Creatinine",][c(2,6:7)] <- uv_mods[uv_mods$term == "Creatinine",][c(2,6:7)] * 10


uv_mods$estimate <- exp(uv_mods$estimate)
uv_mods$conf.low <- exp(uv_mods$conf.low)
uv_mods$conf.high <- exp(uv_mods$conf.high)

uv_mods$estimate[uv_mods$term == "malaria" | uv_mods$term == "any_mal_rx"] <- NA
uv_mods$conf.low[uv_mods$term == "malaria" | uv_mods$term == "any_mal_rx"] <- NA
uv_mods$conf.high[uv_mods$term == "malaria" | uv_mods$term == "any_mal_rx"] <- NA
uv_mods$p.value[uv_mods$term == "malaria" | uv_mods$term == "any_mal_rx"] <- NA


uv_mods$mods_str <- glue('{specify_decimal(uv_mods$estimate,2)} ({specify_decimal(uv_mods$conf.low,2)}-{specify_decimal(uv_mods$conf.high,2)})')

df.mod2 <- dplyr::select(df.temp, screentemp, d28_death, hivstatus, 
calc_age, ptsex, screentemp, t0map, t0hr, t0rr, t0spo2,
gcs,ustand, lactate_value, WCC, Haemoglobin, Platelets,
CO2, Urea, Creatinine, fluid_6hr, any_tb_rx, any_fung_rx,
bc, tb)

df.mod2$hivstatus[is.na(df.mod2$hivstatus)] <- "uk"

mv_mod <- glm(d28_death ~., data = df.mod2, family = "binomial")
bind_cols(tidy(mv_mod), confint_tidy(mv_mod)) -> mv_mod
mv_mod <- subset(mv_mod,term != "(Intercept)")



mv_mod[mv_mod$term == "calc_age",][c(2,6:7)] <- mv_mod[mv_mod$term == "calc_age",][c(2,6:7)] * 5
mv_mod[mv_mod$term == "t0map",][c(2,6:7)] <- mv_mod[mv_mod$term == "t0map",][c(2,6:7)] * 10
mv_mod[mv_mod$term == "t0hr",][c(2,6:7)] <- mv_mod[mv_mod$term == "t0hr",][c(2,6:7)] * 10
mv_mod[mv_mod$term == "t0rr",][c(2,6:7)] <- mv_mod[mv_mod$term == "t0rr",][c(2,6:7)] * 10
mv_mod[mv_mod$term == "t0spo2",][c(2,6:7)] <- mv_mod[mv_mod$term == "t0spo2",][c(2,6:7)] * 5
mv_mod[mv_mod$term == "Platelets",][c(2,6:7)] <- mv_mod[mv_mod$term == "Platelets",][c(2,6:7)] * 100
mv_mod[mv_mod$term == "Creatinine",][c(2,6:7)] <- mv_mod[mv_mod$term == "Creatinine",][c(2,6:7)] * 10

mv_mod$estimate <- exp(mv_mod$estimate)
mv_mod$conf.low <- exp(mv_mod$conf.low)
mv_mod$conf.high <- exp(mv_mod$conf.high)

mv_mod$mods_str <- glue('{specify_decimal(mv_mod$estimate,2)} ({specify_decimal(mv_mod$conf.low,2)}-{specify_decimal(mv_mod$conf.high,2)})')

names(mv_mod)[-1] <- paste0(names(mv_mod)[-1], "_mv")
names(uv_mods)[-1] <- paste0(names(uv_mods)[-1], "_uv")

lr_tab <- merge(dplyr::select(uv_mods, term, mods_str_uv, p.value_uv), 
                dplyr::select(mv_mod, term, mods_str_mv, p.value_mv), all.x = T)

lr_tab$bold_uv <- lr_tab$p.value_uv <= 0.05
lr_tab$p.value_uv <- specify_decimal(lr_tab$p.value_uv ,3)
lr_tab$p.value_uv[lr_tab$p.value_uv == "0.000"] <- "<0.001" 


lr_tab$bold_mv <- lr_tab$p.value_mv <= 0.05
lr_tab$p.value_mv <- specify_decimal(lr_tab$p.value_mv ,3)

lr_tab$p.value_mv[lr_tab$p.value_mv == "0.000"] <- "<0.001" 

lr_tab[lr_tab == "NA (NA-NA)" | is.na(lr_tab) | lr_tab == "NA"] <- "-"

lr_tab[match(c("calc_age", "ptsex", "hivstatus1", "hivstatusuk", "Haemoglobin","screentemp", "t0hr", "t0map",
        "t0rr", "t0spo2","gcs", "ustand", "lactate_value" , "WCC", "Platelets", "CO2", "Urea", "Creatinine", "bc", "tb", "malaria", "csf", 
        "any_ab", "any_fung_rx","any_mal_rx",  "any_tb_rx", "fluid_6hr"), lr_tab$term),] -> lr_tab


lr_tab$term[lr_tab$term == "calc_age"] <- "Age (per 5 years increase)"
lr_tab$term[lr_tab$term == "ptsex"] <- "Male sex (vs female)"
lr_tab$term[lr_tab$term == "hivstatus1"] <- "HIV Infected (vs uninfected)"
lr_tab$term[lr_tab$term == "hivstatusuk"] <- "HIV Unknown (vs uninfected)"
lr_tab$term[lr_tab$term == "Haemoglobin"] <- "Haemoglobin (per g dL\\textsuperscript{-1} increase)"
lr_tab$term[lr_tab$term == "screentemp"] <- "Temperature ( per \\textdegree C increase)"
lr_tab$term[lr_tab$term == "t0hr"] <- "Heart rate (per 10 min\\textsuperscript{-1}) increase)"
lr_tab$term[lr_tab$term == "t0map"] <- "Mean arterial BP (per 10 mmHg increase)"
lr_tab$term[lr_tab$term == "t0rr"] <- "Respiratory rate (per 10 min\\textsuperscript{-1}) increase)"
lr_tab$term[lr_tab$term == "t0spo2"] <- "Oxygen saturation (per 5% increase)"
lr_tab$term[lr_tab$term == "gcs"] <- "GCS (per 1 unit increase)"
lr_tab$term[lr_tab$term == "ustand"] <- "Unable to stand"
lr_tab$term[lr_tab$term == "lactate_value"] <- "Lactate (per 1 mmol L\\textsuperscript{-1} increase)"
lr_tab$term[lr_tab$term == "WCC"] <- "White cell count (per 1x10\\textsuperscript{9} L\\textsuperscript{-1} increase)"
lr_tab$term[lr_tab$term == "Platelets"] <- "Platelet count (per 100x10\\textsuperscript{9} L\\textsuperscript{-1} increase)"
lr_tab$term[lr_tab$term == "CO2"] <- "Bicarbonate (per 1 mmol L\\textsuperscript{-1} increase)"
lr_tab$term[lr_tab$term == "Urea"] <- "Urea (per 1 mmol L\\textsuperscript{-1} increase)"
lr_tab$term[lr_tab$term == "Creatinine"] <- "Creatinine (per 10 mmol L\\textsuperscript{-1} increase)"

lr_tab$term[lr_tab$term == "bc"] <- "BSI (vs no BSI)"
lr_tab$term[lr_tab$term == "tb"] <- "TB (vs no TB)"
lr_tab$term[lr_tab$term == "malaria"] <- "Malaria (vs no malaria)"
lr_tab$term[lr_tab$term == "csf"] <- "Meningitis (vs no meningitis)"

lr_tab$term[lr_tab$term == "any_ab"] <- "Received any antibacterial (vs none)"

lr_tab$term[lr_tab$term == "any_fung_rx"] <- "Received any antifungal (vs none)"
lr_tab$term[lr_tab$term == "any_mal_rx"] <- "Received any antimalarial (vs none)"
lr_tab$term[lr_tab$term == "any_tb_rx"] <- "Received any antimycobacterial (vs none)"

lr_tab$term[lr_tab$term == "fluid_6hr"] <- "IV fluid received (per L increase)"

sub("%", "\\\\%", lr_tab$term) -> lr_tab$term

text_spec(lr_tab$mods_str_uv[lr_tab$bold_uv == "TRUE"],  format = "latex", bold = TRUE) -> lr_tab$mods_str_uv[lr_tab$bold_uv == "TRUE"]
text_spec(lr_tab$p.value_uv[lr_tab$bold_uv == "TRUE"],format = "latex", bold = TRUE) -> lr_tab$p.value_uv[lr_tab$bold_uv == "TRUE"]

text_spec(lr_tab$mods_str_mv[lr_tab$bold_mv == "TRUE"],format = "latex", bold = TRUE) -> lr_tab$mods_str_mv[lr_tab$bold_mv == "TRUE"]
text_spec(lr_tab$p.value_mv[lr_tab$bold_mv == "TRUE"], format = "latex",bold = TRUE) -> lr_tab$p.value_mv[lr_tab$bold_mv == "TRUE"]


kable(select(lr_tab,-c(bold_mv, bold_uv)), "latex", booktabs =T, 
      row.names = F, longtable = T, ,escape = F,caption = "Unadjusted and adjusted odds ratios of death by 28 days" ,
        col.names = c("Variable", "OR (95\\% CI)", "P-value", "aOR (95\\% CI)", "P-value")) %>%
  add_header_above(c(" " = 1, "Bivariable models" = 2, "Multivariable models" = 2)) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header")) %>%
  pack_rows("Host Variables", 1,5, bold = F) %>% 
   pack_rows("Severity Variables", 6, 18, bold = F)  %>%
    pack_rows("Diagnosis", 19,22, bold = F) %>% 
   pack_rows("Treatment Received", 23, 27, bold = F)  %>%
  footnote(general = "BP = Blood pressure, GCS = Glasgow coma scale, BSI = Bloodstream infection, TB = tuberculosis. Separation occurred for those variables for which no parameter estimates are given, and they were excluded from the multivariable model. All odds ratios are for as increase in the variables shown." , threeparttable = T, fixed_small_size = T) %>% landscape()


```

\clearpage

## Discussion

### Demographics and outcome: significant longer-term mortality

In this chapter, I have presented a clinical and microbiologic description of sepsis in adults in Blantyre, Malawi. Inkeeping with sepsis cohorts elsewhere, the participants are young, with high prevalence of HIV infection. The proportion of HIV-infected participants (67% of those with known HIV status) is comparable to a study of Sepsis-2 defined sepsis which recruited in QECH in 2008/9 (75%) but lower than sSA sepsis studies with the highest prevalence of HIV-infected participants Uganda in 2006[@Jacob2009] (85%) and 2009[@Jacob2012] (86%) and Zambia in 2012-13[@Andrews2017] (90%). Notably, the proportion of participants receiving HIV therapy (82%) is high compared to other sepsis studies in sSA: higher than the 08/09 Malawian study (44%), Uganda (12-24%) and Zambia (51%), which likely reflects both the success of the Malawian ART programme as well as the impressive increases in ART coverage across the continent. Despite this ostensibly high coverage, it is likely that presentation with sepsis is increasingly manifestation of ART failure for most participants as evidenced by the low CD4 cell counts despite ART. In the significant minority of participants who recently initiated ART - 25% of those on ART started it less than three months before presentation - it seems likely that immune reconstitution inflammatory syndrome (IRIS) is playing a significant role.

Participants had been unwell for some time: a median 7 days. Published data on length of current illness in sepsis is both high and low-resource settings is lacking, but what data there are from elsewhere in sSA suggest that this is not unusual[@Andrews2014;@Andrews2017;@M.A.M.2015; @Amir2016]. Barriers to accessing care were not addressed in this study and so the reasons for delaying hospital attendance (including the role of patient and healthcare factors) are not clear; 55% of participants had sought care for their current illness prior to presentation at the hospital, usually at the health centre. Optimum triage and other management of critically unwell patients at the health centre in a resource limited setting is not clear, and is likely to differ from hospital management. This could represent a fruitful area for future research. 

The 28-day mortality of the cohort was 18% at 28 days, comparable to the pooled Sepsis-2 sepsis mortality from the systematic review and meta analysis presented in Chapter 1 (23% 95% CI [12-38%]) though considerably lower than the pooled Sepsis-2 severe sepsis mortality (49% 95% CI [39-58]). This is perhaps surprising as the inclusion criteria of this study include organ dysfunction criteria that are more similar to Sepsis-2 severe sepsis definitions than the Sepsis-2 sepsis definitions that are based on the systemic inflammatory response syndrome (SIRS), and would perhaps be expected to result in a higher mortality. In particular, the previous Malawian sepsis study (in the same hospital) from 2008/09 used a SIRS based definition of sepsis and found a mortality of 22%, with a severe sepsis mortality (defined using either 2 SIRS criteria and SBP < 90mmHg or any two of SBP < 90mmHg, capillary refill time > 2s, oxygen saturations < 90% or thrombocytopaenia) of 50%[@Waitt2015]. There are several possible explanations for this. First, there is likely an effect of differing inclusion criteria: this study includes a respiratory rate criterion for recruitment, which has been shown elsewhere in sSA in large pooled datasets to be associated with mortality[@Moore2017], a finding which was not replicated here. Second, sepsis mortality at our centre may be improving, either through improved management, or by population level changes resulting in improved health such as widespread ART coverage or reducing malaria incidence. Certainly, improving sepsis mortality in high-income settings is a trend that has been seen since the pivotal early goal directed therapy trial in 2001[@Rivers2001;@PRISMInvestigators2017;@Kaukonen2014]. Third, participants in this study received reasonably intensive monitoring over the first 6 hours of their hospital attendance, which may have contributed to improved processes of care and hence improved outcomes. There is no way to address these hypotheses with the available data.

Participants continued to die post 28-days, to the end of the study period; this was most apparent in HIV-infected participants in whom there was a near-doubling of mortality from 19% at 28 days to 36% at 180 days. To my knowledge, this is the first data on post-30 day outcomes in sepsis in sSA, and demonstrates that longer term mortality following an admission with sepsis is a significant problem. The causes of late (post 28-day) death are unknown from this study. Given the advanced HIV of many of the participants, and the high prevalence of TB, opportunistic infection seems likely. Despite the suspicion of ART failure at baseline, switching to second line ART was unusual in participants who survived to discharge. This is perhaps not entirely surprising, as WHO and Malawian treatment guidelines mandate two elevated HIV viral load tests at least three months apart he context of good adherence to diagnose ART failure and before switching to second line therapy, which may not have occurred during the six-month study period. Details of any HIV viral load testing performed as part of standard care (as well as any adherence counselling received) were also not captured in this study, so the proprtion of true virologic ART failure are unknown. Nevertheless it is tempting to speculate that rapid adherence interventions or ART switching could improve post discharge outcomes in sepsis in Malawi. This could be an area of future research (Chapter 9), and is of increasing relevance as more people are exposed to first-line ART thanks to the success of global ART roll out.

In contrast to significant medium long term mortality, health-related quality of life (HRQoL, as measured by EQ-5D-3L) seems to return to baseline by 12 weeks following sepsis admission, in contrast to high income settings where longer term morbidity is significant[@Winters2010]. This may represent different patient populations with differing levels of physiologic reserve and capacity for recovery from critical illness, as the patient population in this study is significantly younger than a high-income setting sepsis population. It may also reflect the lack of resources available in LMIC: patients who would survive, but with disability, in a high-resource setting may die in a low-resource one. Nevertheless, the rapid return to a comparable HRQoL to healthy community controls following sepsis admission could make improvement of sepsis outcome a cost-effective condition. Once again, to my knowledge, this HRQoL is the first available such data from sepsis in sSA, and can inform health economics analyses in sepsis here: the EQ-5D-3L utility scores can be used to calculate DALYs (disability-adjusted life years) in such an analysis.

### Aetiology: TB dominates as a cause of sepsis

The aetiology of sepsis in this cohort is dominated by TB, with 34% of participants having at least one positive diagnostic test for TB. The majority of these were positive for urinary LAM. The prevalence of culture-confirmed MTB BSI was lower than expected; in previous studies of Sepsis-2 defined severe sepsis in Uganda[@Jacob2009; @Jacob2012] and Zambia[@Andrews2014; @Andrews2017] it was 28-40% in HIV-infected participants. In Malawi in the pre-ART era[@Archibald2000] the prevalence of MTB BSI in febrile adults at QECH was 14% (21/173), and 9% (9/104) in 2011 in the same centre in HIV-infected adults admitted with fever and chronic cough[@Feasey2013]. The 6% (8/138) I find here in HIV-infected participants therefore seems low. This could be due to technical (e.g. bottle under or over filling with blood) or laboratory factors, though the latter seems unlikely as the testing was carried out at the same laboratory and with the same SOP as the 2011 study by Feasey et al[@Feasey2013]. This could also be a true finding: given the association of MTB BSI with mortality the lower than expected mortality of this cohort could go hand-in-hand with a lower than expected MTB BSI prevalence, for example, or the high ART prevalence (despite the suspicion of common ART failure) could have an effect on the prevalence of MTB BSI. 

Other identified causes of sepsis are as might be expected. _Salmonella_ Typhi was the commonest blood stream infection isolate, reflecting the ongoing Typhoid epidemic in Blantyre which began in 2011[@Feasey2015], and seemed to be associated with HIV-uninfected participants, as has been previously described[@Reddy2010]. 51% of the cohort have an unknown diagnosis _Add PHE serology here when back and tidy up - compare unknown diagnosis fraction to eg crump tanzania paper_

### Determinants of mortality

Several expected markers of disease severity were associated with 28-day mortality, as have previously been described[@Seymour2017;@Waitt2015; @Jacob2012]. Unexpectedly, tachypnoea was associated with survival. The reasons for this are not clear. It could be that participants better able to mount an inflammatory response (and hence an increased respiratory rate) are more likely to survive, or that the effect is driven by low respiratory rates in the very unwell. It could also be explained by bias: elevated respiratory rate was an inclusion criterion for the study, as were shock, reduced conscious level and hypoxia. If unmeasured factors associated with mortality were also associated with these other inclusion criteria then this could cause an apparent mortality benefit to tachypnoea: a collider bias. 

A diagnosis of malaria was strongly associated with survival to 28 days. In Malawi - a malaria endemic country - most adults will have some level of immunity[@Doolan2009], which may explain this finding, but it is possible that the rapid diagnosis and treatment facilitated by the availability of malaria rapid diagnostic tests also contributes. Meningitis - all cryptococcal - strongly predicted death by 28 days, reflecting the well-described high mortality of this condition[@Gaskell2014].

There was no signal of an association between time to antibacterials or volume of IV fluid administered and survival to 28 days. In high-resource settings, rapid administration of antimicrobials has been shown to be associated with improved survival in sepsis[@Kumar2006;@Kahn2019;@Seymour2017], and all sepsis guidelines stress the importance of rapid administration of antimicrobials[@Levy2018]. This is based purely on observational evidence and no RCT has ever been (or will be, given the ethical issues) carried out; these studies are all open to confounding and require adjustment for disease severity. In this study, no significant effect of time-to-antibacterials was seen, though it is important not to interpret this lack of detected effect as lack of effect. The largest study to address this question, in a high income setting (New York, USA) found an adjusted odds ratio of 1.04 (95% CI 1.02-1.05) for death per hour delay of antibiotics, and included 49,331 participants[@Seymour2017], so lack of demonstration of effect here could be due to underpowering. I also have not, in this chapter, attempted to provide an estimate of the effect of time-to-antibacterials on mortality that is adjusted for confounding. Confounding could easily mask any apparent effect (i.e. sick patients given antibacterials quicker). I present an attempt to address this using modelling in the next chapter. 

However it is important to be cognisant of the differences of this cohort to sepsis cohorts in high-income settings: presentation here was subacute, participants were often unwell for many days, and pathogens such as _S._ Typhi and TB would perhaps not be expected to cause such fulminant illness as the Gram-negative pathogens that often cause sepsis in high-income settings. In this context, rapidity of antimicrobial administration may not be such a critical determinant of survival. Further, most participants simply did not have sepsis caused by a pathogen that would be responsive to broad-spectrum antibacterials.

There was no detected benefit or harm associated with volume of intravenous fluid administered. How to safely administer intravenous fluid in sSA is unclear after RCTs in children[@Maitland2011] and adults[@Andrews2017] have shown harm to be associated with aggressive fluid resuscitation. Participants in this study received a comparable volume of fluid to the usual care arm of the Zambian RCT in adults[@Andrews2017], given that the trial was recruiting participants with shock: median 2.0L (IQR 1.0-2.5L) by 6 hours versus 1.5L (1.0 - 2.0L) in this study. The intervention arm of the RCT received 3.5L (2.7-4.0L). It may be that participants in this study did not receive enough fluid to be harmful; that there was insufficient variation in fluid exposure to detect an effect on mortality, that the current study is underpowered (particularly with the lower than expected mortality); that only a subset of the participants in this study (i.e. those with shock) would benefit from fluid; or that the Zambian study population differs in some way and so response to fluid was different.

Perhaps the most striking finding is the strong association of receipt of TB therapy with survival. Care must be taken in interpreting this as cause and effect, because of the risks of confounding, and especially considering the limitations of the modelling undertaken in this chapter (see limitations). A protective effect of TB therapy in sepsis is plausible, however, from prior studies: autopsy studies show that TB is under diagnosed in HIV-infected patients who die in hospital[@Gupta2015a]. The STAMP trial[@Gupta-Wright2018] found a mortality benefit in some a priori subgroups of a strategy of screen-and-treat with urinary LAM for all HIV-infected inpatients, suggesting a significant burden of undiagnosed TB, and prior sepsis cohorts in sSA have found TB as a common cause of sepsis. A retrospective study of 149 HIV infected adults with sepsis in Uganda[@Hazard2019], 55 of whom received anti-TB therapy, found an association between receipt of TB therapy and survival in Sepsis-2 severe sepsis (hazard ratio 0.32 95% CI 0.13-0.80 from Cox proportional hazard model) but not Sepsis-2 sepsis (hazard ratio 1.24 95% CI 0.53-2.90), but is hampered by its retrospective design.

What, then, is the role of TB therapy in sepsis in sSA? RCTs of empirical TB treatment have not previously been successful. The REMEMBER trial recruited outpatients with CD4 cell count below 50 cells $\mu L^{-1}$ and randomised them to isoniazid preventative therapy or full TB therapy, and found no mortality benefit. STASIS found no difference in mortality between a strategy of Xpert and urine LAM screening versus empiric TB therapy in outpatients with CD4 count below 100 cells[@Blanc2018] $\mu L^{-1}$ and TB Fast Track found no mortality benefit in empiric therapy for outpatients with CD4 cell count below 150 $\mu L^{-1}$ if they were randomised to an algorithm that started TB therapy if they were assessed as high risk for TB using a combination of diagnostic tests (including urinary LAM) and clinical features (including BMI and haemoglobin)[@Grant2016]. However all of these studies recruited ambulatory outpatients; it may be that inpatients have more disseminated TB, or a higher baseline risk of mortality. Empiric TB therapy for sepsis in a high-HIV/TB burden setting is a strategy that has never been assessed in an RCT.

The WHO provides guidance on empiric TB therapy in inpatients, however[@WorldHealthOrganisation2007]: _"Hospitalised HIV-infected patients in high TB burden settings with cough and so-called "danger signs" (fever > 39\textdegree C, inability to stand, respiratory rate above 30 min$^{-1}$, heart rate above 120 min$^{-1}$) should receive broad spectrum antimicrobials for 3-5 days, and, if there is no improvement, consider empiric TB therapy"._ This strategy was largely based on expert opinion, but has been shown to improve survival compared to usual care in a before-after study in South Africa[@Holtz2011]. Whether a 3-5 day delay will worsen outcomes in critically unwell patients with TB is unknown. There was no apparent relationship seen in this study between time to antitubercular therapy and death, but numbers were small (n= 53), and TB therapy administration was reasonably rapid, with a median of 120.6 hours from admission to administration of TB therapy; 56% (35/53) of participants received TB therapy in less than 5 days. 

In this context, the finding of a putative survival benefit for TB treatment in participants with sepsis is worth exploring further. Is it possible to produce unbiased estimates of the association of TB therapy with mortality, given the problems with the modelling approach presented in this chapter? Is it possible to move beyond association and assess the causal effect of TB therapy on mortality? Is any benefit confined to particular subgroups, especially groups that can be easily identified in low resource settings, to guide future sepsis treatment protocols? I take up these questions in the following chapter.

### Limitations

There are limitations to this study. There is no community control group, so it is not possible to say whether the positive malaria rapid tests in this study represent incidental parasitaemia or disease. Malaria films could perhaps inform this question by quantifying parasitameia, but were not done. Only one aerobic blood culture and mycobacterial blood culture were done, and both tests are known to have suboptimal sensitivity with only a single culture[@Cockerill2004; @Barr2018]. No anaerobic culture was possible. HIV viral load testing was not done due to resource limitations. 

There are several flaws with the logistic regression models used in this chapter that mean the parameter estimates from them may be biased. Separation was a significant challenge. This is a phenomenon where some predictor variable levels perfectly predict outcome, meaning that parameter value estimates become unstable. In this case, this occurred with malaria and meningitis, so these two precitor variables - both of which were very strongly associated with the outcome variable - were excluded from the model. If other variables were associated with these excluded variables then this could give biased estimates thanks to confounding. In addition, the model is very likely over-parametrised - around ten outcomes for each predictor variable are needed to avoid this[@Harrell2001] meaning that the out-of-sample predictive ability of this model would likely be poor, and would restrict the generalisability of findings. Choosing which variables to include in the model, however, is not an easy task, and strategies such as stepwise variable inclusion have been shown to produce biased parameter estimates[@Harrell2001]. It may also be that some of the predictor variables are collinear - tachycardia and increased respiratory rate are associated with shock, for example, which can inflate the apparent standard errors of parameter estimates. Finally, it is likely that the mortality hazard of some variables included in the model is mediated by other variables (e.g. HIV mortality hazard may be disease mortality), and so interpretation of the parameters is difficult without an explicit causal framework[@Westreich2013].

## Conclusions and further work

In conclusion, this chapter presents an in-depth clinical and microbiologic assessment of sepsis in Blantyre, Malawi, and finds that sepsis here is in some ways a subacute illness, with the dominant cause being tuberculosis. Nevertheless, long-term mortality is significant, and empiric TB therapy seemingly has a strong protective effect. Given the likelihood of confounding, arising partially from difficulties in the logistic regression modelling strategy I have used, this latter conclusion should remain speculative. In the next chapter, I extend the modelling presented here to attempt to address the problems I have identified.

Notwithstanding the next chapter of this thesis, some further work is planned. 

* Fluid administration in sepsis in sSA is clearly complex, and longitudinal modelling of response to fluid over the first six hours of hospital admission in this cohort is planned. 
* 49% of the cohort still have no diagnosis, and further testing for e.g. Q-fever, Brucellosis, PCP and histoplasmosis could provide insight into the role of these pathogens as causes of sepsis in sSA. 
* The reason for the low prevalence of TB BSI in combination with a high prevalence of urine LAM positivity is unknown, and running Xpert ultra on stored blood samples may help to understand if there were technical problems with the mycobacterial blood cultures. 



