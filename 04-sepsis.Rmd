# Sepsis in Blantyre, Malawi
 
```{r ch4-setup, include = F}

library(plyr)
library(reshape2)
library(tidyverse)
library(knitr)
library(kableExtra)
library(grid)
library(ggpubr)
library(pheatmap)
library(UpSetR)
library(eulerr)
library(RColorBrewer)
library(scales)
library(lubridate)
library(survival)

wd <- "chapter_4/"
output = "latex"

# generate figures
#source("chapter_4/generate_consort_diagram.R")
source("final_cleaning_scripts/load_and_clean_followup_and_enroll_labelled.R")
source("other_scripts/summary_table_functions.R")
source("final_cleaning_scripts/make_composite_hivstatus_variable.R")
#source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_bloods.R")
source("final_cleaning_scripts/load_and_clean_aetiol.R")
source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_upto72.R")
source("final_cleaning_scripts/load_and_clean_post72.R")


h1.ustand <- read.csv("/Users/joelewis/Documents/PhD/Data/Current/portal_downloads/other_datasets/h1_ustand.csv")

e1$datefirstunwell[e1$unwelfreq == "Weeks"] <- e1$datefirstunwell[e1$unwelfreq == "Weeks"] * 7
e1$datefirstunwell[e1$unwelfreq == "Months"] <- e1$datefirstunwell[e1$unwelfreq == "Months"] * 30


```

## Chapter overview

## Methods

blah blah



## Results

### Study population

Figure \@ref(fig:consort-diag) shows flow through the study. 225 patients were recruited in 20 months between 19th February 2017 and 2nd October 2018. In total, 4 patients (2%) were lost to follow up over the 180-day study period; 5 patients (2%) withdrew; and 7 patients (3%) transferred out of the study area before 180 days. Four of the five patients who withdrew gave a reason for their wish to withdraw, all that they no longer wished the inconvenience of being involved in the study. 15/225 (7%) patients had their final study visit before 180 days, and so were not included in the 180-day outcome analysis.

### Symptoms and health-seeking behaviour

Table \@ref(tab:sep-t1-demog-dassim) shows the baseline characteristics of the recruited participants. They were young (median [IQR] age 36 [28-44]) and predominantly HIV-infected. Of those who were HIV-infected, the majority (117/143 [82%]) were on ART, almost exclusively the Malawian first-line regimen of efavirenz, lamivudine and tenofovir, and 88/117 (75%) had been taking ART for more than three months. Figure \@ref(fig:sep-present) shows the presenting symptoms of the participants. Almost all (221/225 [98%] of participants) experienced subjective fever. Participants had been unwell for some time, a median (IQR) of `r median_iqr_str(e1$datefirstunwell)` days; 32/225 (14%) of participants had been unwell for more than 4 weeks. 18/225 (8%) of participants had been admitted to hospital within the last 4 weeks. Over half (123/225 [55%]) of participants had sought care for their current ilness (Table \@ref(tab:sep-healthseek)), most commonly (101/123 [82%] of participants) at a government health centre, a median (IQR) of 2 (1-6) days previously. 60/225 (27%) of all participants had recieved an antimicrobial for their current illness: 7/60 (12%) of all prehospital antimicrobials were antimalarials, the remainder anitbacterial, most commonly co-trimoxazole or ciprofloxacin. Prehopsital intravenous or intramuscular antimirobials were administered in 16/60 (27%) participants recieving antimicrobials: ceftriaxone (n=6), benzylpenicillin (n=4), gentamicin (n=3) and artesunate (n=3).

```{r consort-diag, echo = F, fig.cap = "Study recruitment and follow up.",  out.height = '12cm', fig.align = 'center'}

knitr::include_graphics(paste0(wd, "/figures/consort_diagram.pdf"))

```

\renewcommand{\arraystretch}{0.8}
```{r sep-t1-demog-dassim, echo = F, warning = F, message = F}

e1 <- subset(enroll, arm == 1)
e1$art.time <- as.numeric((e1$data_date - e1$hivartstart) /(365.25/12))
e1$hivart[e1$hivart != "5A" & !is.na(e1$hivart)] <- "ART regimen: other"
e1$animalskept[e1$animalskept == "Other"] <- "Elsewhere"
e1$keep.other[e1$keep.cattle == "Yes" | e1$keep.sheep == "Yes" | e1$keep.mules == "Yes"] <- "Yes"
e1.sum <- select(e1, calc_age, ptsex, hivstatus,tbstatus, tbongoing, hivonart, hivart, art.time, hivcpt, 
                  tobaccoyn, alcoholyn,  highestedu,
                 job,  toilet , watersource,
                 electricityyn, fuel, 
                 keepanim, keep.poultry,  keep.goats,
                 keep.dogs, keep.other)

pretty_tbl_df(e1.sum) -> e1.sum
## tweeaky tweaky
e1.sum <- subset(e1.sum, `levels` != "No")
e1.sum <- subset(e1.sum, `levels` != "Female")

e1.sum$levels[e1.sum$variable == "calc_age"] <- "Age (years)"
e1.sum$levels[e1.sum$variable == "ptsex"] <- "Male sex"
e1.sum$variable[e1.sum$variable %in% c("calc_age", "ptsex")] <- "Demographics"

# art variables
e1.sum$levels[e1.sum$levels %in% c("Reactive", "Non reactive", "Unknown")] <- 
  paste0("HIV ", str_to_title(e1.sum$levels[e1.sum$levels %in% c("Reactive", "Non reactive", "Unknown")]))
e1.sum$levels[e1.sum$variable == "hivonart"] <- "Current ART"
e1.sum$levels[e1.sum$variable == "hivcpt"] <- "Current CPT\\textsuperscript{\\dag}"
e1.sum$levels[e1.sum$levels == "5A"] <- "ART regimen: EFV/3TC/TDF"
e1.sum$levels[e1.sum$variable == "art.time"] <- "Months on ART"
e1.sum$variable[e1.sum$variable == "hivstatus"] <- "HIV/TB status"
e1.sum$variable[grepl("art", e1.sum$variable)] <- "ART status*"
e1.sum$variable[grepl("cpt", e1.sum$variable)] <- "ART status*"
# tb variables
e1.sum$levels[e1.sum$variable == "tbstatus"] <- "Ever treated for TB"
e1.sum$levels[e1.sum$variable == "tbongoing"] <- "Of those, current TB treatment"
e1.sum$variable[grepl("tb", e1.sum$variable)] <- "HIV/TB status"


e1.sum <- e1.sum[c(1:8,11,9,10,12:nrow(e1.sum)),]



# tobacco use
e1.sum$levels[grepl("tobacco", e1.sum$variable)] <- paste0(e1.sum$levels[grepl("tobacco", e1.sum$variable)], " tobacco" )
e1.sum$variable[grepl("tobacco", e1.sum$variable)] <- "Tobacco/alcohol use"

# alcohol use
e1.sum$levels[e1.sum$variable == "alcoholyn"] <- "Current alcohol"
e1.sum$variable[grepl("alcohol", e1.sum$variable)] <- "Tobacco/alcohol use"

# education
e1.sum$variable[grepl("highestedu", e1.sum$variable)] <- "Education"

# employment 
e1.sum$variable[grepl("job", e1.sum$variable)] <- "Employment"

# toilet

e1.sum$variable[grepl("toilet", e1.sum$variable)] <- "Toilet facilities"

# toilet

e1.sum$variable[grepl("water", e1.sum$variable)] <- "Main water source"

# electricity
e1.sum$levels[e1.sum$variable == "electricityyn"] <- "Electricity available in house"
e1.sum$variable[grepl("electric", e1.sum$variable)] <- "Electricty"

e1.sum$variable[grepl("fuel", e1.sum$variable)] <- "Main cooking fuel"

# animals

e1.sum$levels[grepl("keep", e1.sum$variable)] <- e1.sum$variable[grepl("keep", e1.sum$variable)]

sub("keep.", "",e1.sum$levels) -> e1.sum$levels
str_to_title(e1.sum$levels[grepl("keep", e1.sum$variable)] ) -> e1.sum$levels[grepl("keep", e1.sum$variable)]
e1.sum$levels[e1.sum$levels == "Nim"] <- "Any animal"

e1.sum$variable[grepl("keep", e1.sum$variable)] <- "Animals at home?"

e1.sum <- e1.sum[c(1:45, 47,46,47:nrow(e1.sum)),]

kstring <- make_kable_rowgroup_string(e1.sum)
e1.sum$levels[e1.sum$levels== "Yes" | e1.sum$levels== "Median (IQR)" ] <- 
  e1.sum$variable[e1.sum$levels== "Yes" | e1.sum$levels== "Median (IQR)" ]
#rownames(e1.sum) <- e1.sum$`levels`
#rownames(e1.sum)[!(rownames(e1.sum) %in% kstring)]

sub("%", "\\\\%", e1.sum$value) -> e1.sum$value

kable(select(e1.sum,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = T, escape = F, col.names = c("Variable","Value"), caption = "Participant Characteristics" ) %>%
  kable_styling(full_width = F,latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring) %>%
  footnote(general = "ART = Antiretroviral therapy, CPT = Co-trimoxazole preventative therapy, EFV: Efavirenz, 3TC: Lamivudine, TDF: Tenofovir. Numeric values are median (IQR)) unless otherwise stated.", symbol = c("ART status includes HIV reactive only as denominator", "Missing CPT data for two participants. ") ,threeparttable = T, fixed_small_size = T)



```

```{r sep-healthseek, echo = F, warning = F, message = F}

e1$phxstartdate_n[grepl("Weeks", e1$prehfreq)] <- e1$phxstartdate_n[grepl("Weeks", e1$prehfreq)] * 7
e1$phxstartdate_n[grepl("Months", e1$prehfreq)] <- e1$phxstartdate_n[grepl("Months", e1$prehfreq)] * 30


e1$prehospcaredur[grepl("Weeks", e1$prehospcarefr)] <- e1$prehospcaredur[grepl("Weeks", e1$prehospcarefr)] * 7
e1$prehospcaredur[grepl("Months", e1$prehospcarefr)] <- e1$prehospcaredur[grepl("Months", e1$prehospcarefr)] * 30


e1$ab_startdays[e1$recieved_prehosp_ab == "Yes"] <- e1$phxstartdate_n[e1$recieved_prehosp_ab == "Yes"]
e1$prehosp_ab[e1$recieved_prehosp_ab == "Yes"] <- e1$prehosrxname [e1$recieved_prehosp_ab == "Yes"]
e1$prehospcaretransp[grepl("Min", e1$prehospcaretranspother)] <- "Minibus"


e1.sum.2 <- select(e1, prehospcareyn,soughtcare.other.hospital,soughtcare.other.clinic,soughtcare.pharmacy,soughtcare.private.doctor, soughtcare.other.health.worker ,soughtcare.traditional.practicioner,soughtcare.friend.or.family,soughtcare.other,prehospcaredur, recieved_prehosp_ab,  prehosp_ab,ab_startdays, prehospcaretransp, prehospcaretranspcost)

pretty_tbl_df(e1.sum.2) -> e1.sum.2
subset(e1.sum.2, levels != "No") -> e1.sum.2

e1.sum.2$levels[e1.sum.2$variable == "prehospcareyn"] <- "Sought care prior to attendance at hospital"
e1.sum.2$levels[e1.sum.2$variable == "prehospcaredur"] <- "Days prior to today that participant sought care"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other.hospital"] <- "At hospital"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other.clinic"] <- "At health centre"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.private.doctor"] <- "At private doctor"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other"] <- "Somewhere else "

e1.sum.2$variable[e1.sum.2$variable == "prehospcareyn" |
                    e1.sum.2$variable == "prehospcaredur" |
                    grepl("soughtcare" ,e1.sum.2$variable) ] <-  "Pre-hospital healthcare seeking"
e1.sum.2$levels[e1.sum.2$variable == "recieved_prehosp_ab"] <- "Recieved any antimicrobial prior to attendance at hospital"
#e1.sum.2$levels[e1.sum.2$variable == "prehosp_ab"] <- paste0("Recieved ", e1.sum.2$levels[e1.sum.2$variable == "prehosp_ab"])


e1.sum.2$levels[e1.sum.2$variable == "ab_startdays"] <- "Days prior to today that antimicrobials started" 
e1.sum.2$variable[ grepl("prehosp_ab" ,e1.sum.2$variable) | grepl("ab_startdays" ,e1.sum.2$variable) ] <- "Prehospital antimicrobial exposure"

e1.sum.2$levels[e1.sum.2$variable == "prehospcaretranspcost"] <- "Cost (MWK) of transport to hospital"
e1.sum.2$variable[ grepl("prehospcaretransp" ,e1.sum.2$variable) ] <- "Method of transport to hospital"

e1.sum.2 <- e1.sum.2[c(1,3,2,4:nrow(e1.sum.2)),]

kstring2 <- make_kable_rowgroup_string(e1.sum.2)

e1.sum.2$value[c(2,3,4,5,6, 8:21)] <- paste0("\\hspace{1em}", e1.sum.2$value[c(2,3,4,5,6, 8:21)] )

sub("%", "\\\\%", e1.sum.2$value) -> e1.sum.2$value

kable(select(e1.sum.2,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = F, escape = F, col.names = c("Variable","Value"), caption = "Prehospital heathcare seeking and antimicrobial exposure" ) %>%
  kable_styling( full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring2) %>%
  add_indent(c(2,3,4,5,6, 8:21)) %>%
  footnote(general = "LA = Lumefantrine-artemether, SP = Sulfamethoxazole-pyrimethamine, MWK = Malawian Kwacha. Numeric values are median (IQR)) unless otherwise stated." ,threeparttable = T, fixed_small_size = T)

```

```{r sep-present-setup, include = F}


sympt <- e1[names(e1) %in% names(enroll.names)[grepl("symp",enroll.names)]]

sympt[sympt == "No"] <- 0
sympt[sympt == "Yes"] <- 1
(sapply(sympt, as.numeric)) -> sympt

sympt.melt <- melt(sympt) %>% filter(value > 0)
gsub("\\.", " ", sympt.melt$Var2) -> sympt.melt$Var2
str_to_title(sympt.melt$Var2) -> sympt.melt$Var2
ggplot(sympt.melt, aes(fct_rev(fct_infreq(Var2)))) +
  geom_bar() + coord_flip() + theme_bw() +
  labs(x= "", y = "Count") -> p1

gsub("\\.", " ", dimnames(sympt)[[2]]) -> dimnames(sympt)[[2]]
str_to_title(dimnames(sympt)[[2]]) -> dimnames(sympt)[[2]]
grid.grabExpr(pheatmap(sympt[1:225,1:25], legend = F, fontsize = 7)) -> p2
as_ggplot(p2) ->p2

```

```{r sep-present, echo = F, warning = F, message = F, fig.scap="Symptoms of recruited participants", out.extra='', fig.cap="Symptoms of recruited participants. A: Row and column clustered heatmap of participant symptoms. Each row represents a patient. Red = presence, blue = absence. B: Frequency of occurence of symptoms", fig.width = 8, fig.height = 5, out.height= '40%'}

ggarrange(p2,p1, labels = c("A", "B"), widths = c(1, 1)) 
```


### Admission physiology and laboratory investigations

Admission vital signs and laboratory investigations are shown in Table \@ref(tab:sep-physiol). Despite high ART coverage (117/143 [82%]) amongst HIV-infected participantsfor a median of 29 months, the median (IQR) CD4 count was low at 98 (31-236) cells $\mu$L\textsuperscript{-1}. 108/141 (70%) of participants had a CD4 count below 200 cells $\mu$L\textsuperscript{-1}. CD4 count was similar in participants who had started ART more than 6 months ago as compared to less than three months ago (median [IQR] 99 [27-260] vs 93 [39-137] cells $\mu$L\textsuperscript{-1} respectively) and 42/83 (51%) of participants who had been taking ART for more than 6 months had a CD4 count of less than 100 cells $\mu$L\textsuperscript{-1}, and would fulfil a WHO definition of immunological failure.

```{r sep-physiol, echo = F, warning = F, message = F}

# merge in bloods
e1[e1 == 999] <- NA
e1 <- merge(e1,bloods, all.x = T)
e1 <- merge(e1, h1.ustand, all.x= T)
e1$gcs <- e1$t0gcse + e1$t0gcsv + e1$t0gcsm
e1$gcs.cat <- NA
e1$gcs.cat[e1$gcs == 15] <- "15"
e1$gcs.cat[e1$gcs > 10 & e1$gcs < 15] <- "11-14"
e1$gcs.cat[e1$gcs < 11] <- "10 or below"



e1$CD4_hiv_pos <- NA
e1$CD4_hiv_pos[e1$hivstatus == "Reactive"] <- e1$CD4_Absolute[e1$hivstatus == "Reactive"] 
e1$Neutrophils_count <- as.numeric(e1$Neutrophils_count )

rbind(
  pretty_tbl_df(
    select(e1, t0hr, t0sbp, t0dbp, t0rr, t0spo2, gcs.cat, CD4_hiv_pos)
    ),
  
  pretty_tbl_df(
    select(e1, screentemp, Haemoglobin, WCC, Neutrophils_count,  Potassium, Urea, lactate_value)
    ,r = 1),
  pretty_tbl_df( 
    select(e1, Platelets, Chloride, CO2, Creatinine, NA. )
    )
  ) -> e1.sum.3

e1.sum.3$levels[e1.sum.3$variable == "screentemp"] <- "Temperature (\\textdegree C)"
e1.sum.3$levels[e1.sum.3$variable == "t0hr"] <- "Heart rate (min\\textsuperscript{-1}))"
e1.sum.3$levels[e1.sum.3$variable == "t0sbp"] <- "Systolic blood pressure (mmHg)"
e1.sum.3$levels[e1.sum.3$variable == "t0dbp"] <- "Diatsolic blood pressure (mmHg)"
e1.sum.3$levels[e1.sum.3$variable == "t0rr"] <- "Respiratory rate (min\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "t0spo2"] <- "Oxygen saturation (%)"
e1.sum.3$levels[e1.sum.3$levels == "15"] <- "15"
e1.sum.3$levels[e1.sum.3$levels == "11-14"] <- "11-14"
e1.sum.3$levels[e1.sum.3$levels == "10 or below"] <- "< 11"
e1.sum.3$levels[e1.sum.3$variable == "CD4_hiv_pos"] <- "CD4 count* ($\\mu$L\\textsuperscript{-1})"

e1.sum.3$levels[e1.sum.3$variable == "Haemoglobin"] <- "Haemoglobin (x10\\textsuperscript{9} g dL\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "WCC"] <- "White cell count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Neutrophils_count"] <- "Neutrophil count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Platelets"] <- "Platelet count count (x10\\textsuperscript{9} L\\textsuperscript{-1})"

e1.sum.3$levels[e1.sum.3$variable == "NA."] <- "Sodium (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Potassium"] <- "Potassium (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Urea"] <- "Urea (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "CO2"] <- "Bicarbonate (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Creatinine"] <- "Creatinine (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "lactate_value"] <- "Lactate (mmol L\\textsuperscript{-1})"

sub("%", "\\\\%", e1.sum.3$value) -> e1.sum.3$value
sub("%", "\\\\%", e1.sum.3$levels) -> e1.sum.3$levels
rbind(e1.sum.3, data.frame(variable = "Admission physiology", `levels` = "GCS", value = " ")) -> e1.sum.3

e1.sum.3 <- e1.sum.3[c(10,1:5,22,6:8, 9,11,12,13,17,21,14,19,18,15,20,16),]
e1.sum.3$variable[1:10] <- "Admission physiology"
e1.sum.3$variable[11] <- "Admission CD4 count"
e1.sum.3$variable[12:15] <- "Admission haematology"
e1.sum.3$variable[16:nrow(e1.sum.3)] <- "Admission biochemistry"
kstring3 <- make_kable_rowgroup_string(e1.sum.3)

kable(select(e1.sum.3,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = F, col.names = c("Variable","Value") ,escape = F,caption = "Admission physiology, haematology and biochemistry" ) %>%
  kable_styling("striped", full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring3) %>%
  add_indent(c(8:10)) %>%
  footnote(general = "GCS = Glasgow coma scale. Numeric values are median (IQR)) unless otherwise stated." , symbol = "CD4 count includes only HIV-infected participants; 2 values were missing.", threeparttable = T, fixed_small_size = T)

```

\clearpage

### Aetiology

In total, 51% (114/225) of the 225 participants had at least one infectious agent identified (Table \@ref(tab:sep-diag)), most commonly tuberculosis (76/225 [34%]) followed by bloodstream infection (24/225 [11%]) and malaria (21/225 [9%]). Table \@ref(tab:sep-tests) shows the availability of test and proportion of positive tests across the cohort, stratified by HIV status. 2/225 patients (1%) had a missing aerobic blood culture; the remaining 223 patients had a total of 259 blood cultures performed. 15/259 (6%) blood cultures grew at least one contaminant, but 26 blood cultures from 24 patients were positive for a total of 28 pathogenic bacteria (Figure \@ref(fig:sep-bc-plot)): _Salmonella_ Typhi was the most commonly isolated pathogenic bacterium, and seemed to show an association with HIV-negative participants: all (8/8) of the participants from whom _S._ Typhi was isolated and whose HIV status was known were HIV noninfected. Of the 18 Gram negative bacteria isolated, 3/18 (17%) were cefpodoxime resistant on AST via disc diffusion testing, and likely ESBL producers: one _K. pneumoniae_ and one _E. coli_ (both from the same blood culture and same patient) and one _Acinetobacter baumannii_. Both _Staphyloccus aureus_ isolates were oxacillin sensitive. The one _Streptococcus pneumoniae_ cultured was penicillin intermediate on AST.

Lumbar puncture and CSF culture was carried out in 44 participants: 5/44 (11%) of samples grew a contaminent and no pathogenic bacteria were recovered from any sample. 4/44 (9%) had a detectable cryptococcal antigen (CRAG) in CSF. Malaria testing was missing for 6/225 (3%) of participants, but of the remainder, a positive malaria test was more likely in the HIV-uninfected (12/69 [17%] vs 6/138 [4%], p = 0.01 on pairwise Fisher's exact test). Positive aerobic blood culture showed no statistically significant association with HIV, nor did positive CSF testing, though in the latter case numbers were small and all positive tests (all positive CRAG) were in fact in the HIV-infected (Table \@ref(tab:sep-tests)).

Testing for TB, with the exception of sputum Xpert testing, was restricted to HIV-infected participants. Sputum Xpert was carried out in 44/225 (20%) of participants, and was more commonly carried out in the HIV-infected: 35/143 [24%] of HIV-infected participants had sputum testing performed vs 8/70 (11%) of HIV uninifected (p = 0.07 by Fisher's exact test). 53 sputum samples were sent in total from the 44 patients, and 8/44 (18%) diagnoses of TB made, all except one in HIV-infected participants. One sample identified a rifampicin resistance gene; the remainder of infections were rifampcin-sensitive. 

155 participants were eligible for urinary lipoarabinomannan (uLAM) and mycobacterial blood culture testing, being either HIV-infected (n=143) or of unknown HIV status (n=12). Urine was available for 145/155 (94%) of those eligible, and 74/145 (51%) of samples were positive for uLAM. 150/155 (97%) of eligible participants had blood samples collected and cultured for mycobacteria. 12/150 (8%) grew contaminents and are excluded from the denominators in Table \@ref(tab:sep-tests); of the remainder 8/138 (6%) grew mycobacteria, all _M. tuberculosis_.

Figures \@ref(fig:sep-upset-plot) and \@ref(fig:sep-euler-plot) show the overlap of positive tests form the different diagnostic modalities. Of the 114 patients with at least one positive diagnosic test, 90/114 (79%) had only one positive diagnostic test. The exceptions to this were mycobacterial blood culture and sputum Xpert: patients who had TB diagnosed by these tests tended to also have a positive uLAM. 2/4 (50%) of patients with positive CSF testing (all of whom had detectible CRAG) had also grew _Cryptococcus neoformans_ in aerobic blood culture. 111/225 (49%) of patients remained with no diagnosis.

```{r sep-diag, echo = F, warning = F, message = F}

aetiol.m <- dcast(aetiol, pid + hivstatus ~ type, value.var = "pathogen")
aetiol.m$tb <- aetiol.m$`mtb bsi`== 1 | aetiol.m$uLAM == 1 | aetiol.m$Xpert == 1
aetiol.m -> a
a[is.na(a)] <- 0
a$no_diagnosis <- as.numeric(apply(a[3:8], 1,sum) == 0)

melt(select(a, pid, hivstatus, tb, bc, malaria, csf, no_diagnosis), id.vars = c("pid", "hivstatus")) %>% dplyr::group_by(variable) %>% dplyr::summarise(n = dplyr::n(), positive = sum(value == 1)) -> t

t$prop <-  paste0(t$positive, "/",  t$n, " (",
                         format(round((t$positive*100/t$n), 0), nsmall = 0),
                         "%)"
)

t$variable <- c("Tuberculosis", "Bloodstream infection", "Malaria", "Meningitis", "No diagnosis")

kable(select(t, variable, prop), "latex", booktabs =T, 
      row.names = F, longtable = F, col.names = c("Diagnosis","Proportion of participants") ,escape = T,caption = "Final diagnosis of all participants" ) %>%
  kable_styling( full_width = F)# %>%
#  footnote(general = "Tuberculsosis includes and positive tuberculosis diagnostic test; bloodstream infection includes any patient with at least one positive blood culture, excluding contaminants; meningitis includes any positive CSF culture, excluding contaminents, or positive cryptococcal antigen test in CSF ", threeparttable = T)



```

```{r sep-tests, echo = F, warning = F, message = F}


aetiol$type <- as.factor(aetiol$type)

aetiol %>% dplyr::group_by(hivstatus, type, .drop = FALSE) %>% dplyr::summarise(positive = sum(pathogen == 1), n = dplyr::n()) -> t2

aetiol %>% dplyr::group_by(type, .drop = FALSE) %>% dplyr::summarise(positive = sum(pathogen == 1), n = dplyr::n()) -> t2.tot

t2$prop <-  paste0(t2$positive, "/",  t2$n, " (",
                         round((t2$positive*100/t2$n), 0),
                         "%)"
)

t2.tot$prop <-  paste0(t2.tot$positive, "/",  t2.tot$n, " (",
                         round((t2.tot$positive*100/t2.tot$n), 0),
                         "%)"
)

t2.tot$hivstatus <- "Total"
bind_cols(subset(t2, hivstatus == "Reactive"), 
          subset(t2, hivstatus == "Non reactive"),
          subset(t2, hivstatus == "Unknown"),
          t2.tot) -> t2

round(apply(t2[c(3,8,13,4,9,14)], 1, function(x) chisq.test( matrix(x, ncol = 2))$p.value),3) -> t2$p

t2$prop1[grepl("NaN", t2$prop1)] <- "-"
t2$p[grepl("NaN", t2$p)] <- "-"

t2$type <- as.character(t2$type)

t2 <- t2[c(5,6,4,1,2,3),]
t2$type <- c("Urinary LAM", "Sputum Xpert", "TB blood culture", "Aerobic blood culture", "CSF culture or CRAG", "Malaria RDT")

t2[c(2,5,10,15,19,21)] -> t2
names(t2) <- c("Test", "Positive", "Negative", "Unknown","All", "p")

t2.n <- e1 %>% dplyr::group_by(hivstatus, .drop = FALSE) %>% dplyr::summarise (n = dplyr::n())

rbind(
  data.frame(Test = "Number of participants", Positive = t2.n$n[t2.n$hivstatus == "Reactive"], 
             Negative = t2.n$n[t2.n$hivstatus == "Non reactive"],
             Unknown = t2.n$n[t2.n$hivstatus == "Unknown"],
             All = sum(t2.n$n),
             p = "-"),
  t2
) -> t2

kable(t2, "latex", booktabs =T, 
      row.names = F, longtable = F,escape = T,caption = "Positive diagnostic tests for all participants, stratified by HIV status."  ) %>%
  kable_styling( full_width = F) %>%
group_rows(index=c(" " = 1, "TB diagnostics" = 3, "Other diagnostics" = 3)) %>%
  add_header_above(c(" ", "HIV status" = 3, " ", " ")) %>%
  column_spec(5, bold = TRUE) %>%
  footnote(general = "LAM = Lipoarabinomannan, CSF = Cerebrospinal fluid, CRAG = Cryptococcal antigen, RDT = Rapid diagnostic test. p-values are chi-squared test across the three HIV status strata, and hence may be different from the pairwise exact Fisher's tests presented in the text. Urinary LAM and TB blood culture were not carried out in HIV negative participants.", threeparttable = T,  fixed_small_size = T)

```

```{r sep-bc-plot, echo = F, warning = F, message = F, fig.scap="Pathogenic isolates recovered from aerobic blood culture.", out.extra='', fig.cap="Pathogenic isolates recovered from aerobic blood culture. 26 blood cultures in 24 participants  were positive for 28 pathogens in total", fig.width = 7, fig.height = 2.3, out.height= "70%"}

melt(bc.full[c("pid", "typhi", "saen", "saty", "esco","klpn", "hib", "stpn", "crne", "acba", "enfam", "enfas", "stau", "prot")]) %>% filter (value > 0) -> bc.full.melt



merge(bc.full.melt, select(enroll, pid, hivstatus)) -> bc.full.melt

bc.full.melt$hivstatus <- factor(bc.full.melt$hivstatus, levels = c("Reactive", "Non reactive", "Unknown"))


ggplot(bc.full.melt, aes(fct_rev(fct_infreq(variable)), fill = hivstatus)) + geom_bar() + coord_flip() + scale_fill_manual(values = c(brewer.pal( 4, "Set2")[c(2,1)], "darkgrey"), labels = c("HIV+", "HIV-", "Unknown"), name = "HIV status") + theme_bw() +
  scale_x_discrete("", labels = expression(italic("Proteus mirabilis"),italic("Enterococcus faecium"),italic("Acinetobacter baumannii"), italic("Streptococcus pneumoniae"),italic("Haemophilus influenzae"),italic("Klebsiella pneumoniae"),italic("Stapylococcus aureus"),italic("Cryptococcus neoformans"),paste(italic("Salmonella"), "Typhimurium"),italic("Escherichia coli"),paste(italic("Salmonella"), "Typhi"))) + scale_y_continuous(name = "n", breaks = c(0,2,4,6,8,10)) 


```

```{r sep-euler-plot, echo = F, warning = F, message = F, fig.scap="Symptoms of recruited participants", out.extra='', fig.cap="Venn diagram showing overlap of diagnostic tests; culture of blood and CSF shown in red, malaria in green and TB diagnostics in blue. The CSF variable in includes either a positive culture for a pathogenic bacteria or positive cryptococcal antigen, BSI a positive aerobic culture of pathogenic bacteria from blood and MTB BSI a positive mycobacterial culture of tuberculosis from blood. BSI: Bloodstream infection, CSF: Cerebrospinal fluid, CRAG: Cryptococcal antigen, mRDT: Malaria rapid diagnostic test, MTB BSI: Mycobacterium tuberculosis bloodstream infection, uLAM: urinary lipoarabinomannan.", fig.width = 5, fig.height = 6, out.height = "70%"}

 set.seed (99)
euler(as.data.frame(sapply(a[c(3:8, 10)], as.logical)), shape = "circle") -> eul

plot(eul, edges = "grey30", labels = list(labels = c("BSI","CSF","Malaria","MTB BSI","uLAM","Xpert","No diagnosis"), fontsize = 12), fills = list(fill =c(hue_pal()(3)[1],hue_pal()(3)[1], hue_pal()(3)[2], hue_pal()(3)[3],hue_pal()(3)[3], hue_pal()(3)[3] , "grey" ), alpha = 0.8)) 




```


```{r sep-upset-plot, echo = F, warning = F, message = F, fig.scap="UpSet plot of diagnostic testing", out.extra='', fig.cap="UpSet plot of overlap of positive diagnostic tests, showing that for the majority of participants, one test alone is positive. Red colour indicates HIV-infected; black is a composite of HIV-negative and unknown. The CSF variable in includes either a positive culture for a pathogenic bacteria or positive cryptococcal antigen, BSI a positive aerobic culture of pathogenic bacteria from blood and MTB BSI a positive mycobacterial culture of tuberculosis from blood. BSI: Bloodstream infection, CSF: Cerebrospinal fluid, CRAG: Cryptococcal antigen, mRDT: Malaria rapid diagnostic test, MTB BSI: Mycobacterium tuberculosis bloodstream infection, uLAM: urinary lipoarabinomannan.", fig.width = 6, fig.height = 5, out.height = "50%"}



names(a) <- c("pid", "hivstatus", "BSI", "CSF culture/CRAG +", "mRDT", "MTB BSI", "uLAM+", "Sputum Xpert+",
              "tb", "No Diagnosis")

#upset(a[-9], nsets = 7,order = "freq", queries = list(list(query = elements, params = list("hivstatus", "Reactive", color = "#FC8D62" , active = T)))) 

#pdf(file = paste0(wd, "figures/upset.pdf"), width = 6, height = 5)
upset(a[-9], nsets = 7,order = "freq", query.legend = "bottom",
      queries = list(
        list(query = elements, params = list("hivstatus", "Reactive"), color = "#FC8D62" , active = T, 
             query.name = "HIV+")
      )
)
#dev.off()      
 


```


### Treatment

95% (214/225) of the cohort recieved at least on antimicrobial during their admission (Table \@ref:(time-to-ab-table)), most commonly an antibacterial (207/225 [92%]), but also a significant minority recieved antitubercular therapy (63/225 [28%]). Of those receiving antitubercular therapy, 16% (10/63) were taking the medication prior to admission, and the remainder were initiated on therapy during admission. The first antibacterial agent administered was most often ceftriaxone, in 87% (181/207) of cases but ciprofloxacin (18/207 [9%] of participants), amoxicillin (6/207 [3%]) and metronidazole (2/207 [1%]) were also used. Median (IQR) door to antimicrobial time was 5.3 (3.7-10.8) hours for antibacterials and 4.5 (3.1-21.7) hours for antimalarials but longer for antifungals at 47.7 (27.9-73.9) hours and longer still for antitubercular therapy at 120.9 (63.7-171.0). Cumulative incidence curves for administration of the different antimicrobial classess are shown in figure

85% (192/225) of participants received any intravenous fluid in the first 6 hours of enrollment to the study; of these, most received 0.9% saline (160/190 [83%] of those recieving fluid) but 5% dextrose (91/160 [57%]) were also used; Ringer's lactate (6/192 [6%]) and blood (2/192 [1%]) were rarely administered. 

```{r treatment-setup, include = F}


source("final_cleaning_scripts/load_and_clean_time_to_ab.R")

df.abs$event <- as.numeric(!df.abs$first_ab == "none")
df.abs$t <- df.abs$time_to_abx
df.abs$t[df.abs$event == 0] <- 1000

df.tb$event <- as.numeric(df.tb$any_tb_rx == "yes" | df.tb$any_tb_rx == "on admission")
df.tb$t <- df.tb$time_to_tb_rx
df.tb$t[df.tb$any_tb_rx == "on admission"] <- 0
df.tb$t[df.tb$any_tb_rx == "none"] <- 1000


df.mal$event <- as.numeric((!is.na(df.mal$time_to_mal_rx)))
df.mal$t <- df.mal$time_to_mal_rx
df.mal$t[df.mal$event == 0] <- 1000

df.fung$event <- as.numeric((!is.na(df.fung$time_to_fung_rx)))
df.fung$t <- df.fung$time_to_fung_rx
df.fung$t[df.fung$event == 0] <- 1000

survfit(Surv(t, event) ~ 1, data = df.fung) -> fit.fung
survfit(Surv(t, event) ~ 1, data = df.mal) -> fit.mal
survfit(Surv(t, event) ~ 1, data = df.tb) -> fit.tb
survfit(Surv(t, event) ~ 1, data = df.abs) -> fit

fit$am.type <- "abs"
fit.tb$am.type <-"tb"
fit.mal$am.type <-"malaria"
fit.fung$am.type <-"antifucngals"

fit.all <- bind_rows(
  data.frame(time = fit$time, surv = fit$surv, 
             lower= fit$lower, upper = fit$upper,
             type = "abs", stringsAsFactors = F),
  data.frame(time = fit.tb$time, surv = fit.tb$surv, 
             lower= fit.tb$lower, upper = fit.tb$upper,
             type = "tb", stringsAsFactors = F),
  data.frame(time = fit.mal$time, surv = fit.mal$surv, 
             lower= fit.mal$lower, upper = fit.mal$upper,
             type = "malaria", stringsAsFactors = F),
  data.frame(time = fit.fung$time, surv = fit.fung$surv, 
             lower= fit.fung$lower, upper = fit.fung$upper,
             type = "antifungal", stringsAsFactors = F),
  
)

ab_sum_tbl <- data.frame(
  antimicrobial = c(rep("Antibacterial",1), rep("Antimalarial",1), 
                    rep("Antifungal",1),  rep("Antitubercular",1)),
  t = c(median_iqr_str(as.numeric(df.abs$time_to_abx),1),median_iqr_str(as.numeric(df.mal$time_to_mal_rx),1),
        median_iqr_str(as.numeric(df.fung$time_to_fung_rx),1),median_iqr_str(as.numeric(subset(df.tb, any_tb_rx == "yes")$time_to_tb_rx),1)),
  n = c(prop_str(as.numeric(df.abs$event))[[1]], prop_str(as.numeric(df.mal$event))[[2]],
        prop_str(as.numeric(df.fung$event))[[2]], paste0(prop_str(as.numeric(df.tb$event))[[2]], "*"))
)

ab_sum_tbl[c(1,3,2)] -> ab_sum_tbl
ab_sum_tbl[c(1,4,3,2),] -> ab_sum_tbl

```

```{r time-to-ab-table, echo =F, warning=F, message=F}

kable(ab_sum_tbl, "latex", booktabs =T, 
      row.names = F, longtable = F,escape = T,
      caption = "Door-to-antimicrobial times and number of patients receiving each class of antimicrobial",
      col.names = c("Antimicrobial class", "No. participants", "Median [IQR] time (hours)")) %>%
  kable_styling( full_width = F) %>%
  footnote(symbol = "10/63 participants who received antitubercular agents during admission were taking them prior to admission; they are excluded from the calculation of median door-to-antimicrobial time for this class. ", threeparttable = T, fixed_small_size = T)

#ggplot(fit.all, aes(time, (1-surv), group = type)) + geom_line() + xlim(c(0,240))

#subset(e1, !(pid %in% subset(df.abs, first_ab != "none")$pid | pid %in% subset(df.mal, !is.na(first_ab))$pid  | 
 # pid %in% subset(df.fung, !is.na(first_ab))$pid   | pid %in%  subset(df.tb,any_tb_rx != "none")$pid ))

subset(e1, !(pid %in% subset(df.abs, first_ab != "none")$pid | pid %in% subset(df.mal, !is.na(first_ab))$pid  | 
               pid %in% subset(df.fung, !is.na(first_ab))$pid   | pid %in%  subset(df.tb,any_tb_rx != "none")$pid ))$pid -> a

```

```{r treatment-plot-setup, include = F}

source("final_cleaning_scripts/load_and_clean_fluid_hr1_to_6.R")

brk <-  seq(0,192, 24)

p.abs <- ggplot(filter(fit.all, type == "abs"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,1), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw()+ scale_x_continuous(breaks =brk)

p.tb <- ggplot(filter(fit.all, type == "tb"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.3), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw()  + scale_x_continuous(breaks =brk)

p.mal <- ggplot(filter(fit.all, type == "malaria"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.15), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw() + scale_x_continuous(breaks =brk)

p.fung <- ggplot(filter(fit.all, type == "antifungal"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.15), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw() + scale_x_continuous(breaks =brk)

ggplot(fluid %>% pivot_longer(-pid), aes(name, value)) + geom_jitter(size = 0.5, color = "darkgrey") + geom_boxplot(alpha = 0.6, width = 0.5, outlier.shape = NA) + theme_bw() + labs(x= "Time (hours)", y = "Volumme (ml)") -> p.fluid


            
  
##pp <- ggdraw() +
##  draw_plot(p.abs) +
##  draw_plot(plt.inset, x = 0.3, y = 0.1, width = 0.5, height = 0.5)

```
```{r sep-abtime-fluid-plot, echo = F, warning = F, message = F, fig.scap="Antimicrobial and fluid administration as a function of time.", out.extra='', fig.cap="Timing of antimicrobial and fluid administration. A-D: Cumulative incidence of administration of antibacterial (A), antitubercular (B), antifungal (C) and antimalarial (D) agents as a function of time since arrival at hospital in hours. E: Total volumne of administered intavenous fluid as a function of time since enrollment to study in hours. Boxplots show median, quartiles box and 1.5 times interquartile range as whiskers. Points are jittered around the hour at which they were measured. ", fig.width = 6, fig.height = 8, out.width= "80%", fig.align= "center"}

ggarrange(
  ggarrange(p.abs, p.tb, ncol = 2, nrow = 1, labels = c("A", "B")), 
  ggarrange(p.fung, p.mal, ncol = 2, nrow = 1, labels = c("C", "D")),
  ggarrange(NULL, p.fluid, NULL, ncol = 3, nrow = 1, widths = c(0.5,1,0.5), labels = c(NA, "E", NA)),
            ncol = 1,nrow = 3)

```
Table:
Time to antimicrobials
Time to fluid
Amount of fluid

### Outcome

Table - 28 and 90 day mortality

Figure - KM survival curve

Logistic regression - determinants of 28 day mortality

Morbidity - 
