# Sepsis in Blantyre, Malawi
 
```{r ch4-setup, include = F}

library(plyr)
library(reshape2)
library(tidyverse)
library(knitr)
library(kableExtra)
library(grid)
library(ggpubr)
library(pheatmap)
library(UpSetR)
library(eulerr)
library(RColorBrewer)
library(scales)
library(lubridate)
library(survival)
library(eq5d)
library(ggsci)
library(survminer)

wd <- "chapter_4/"
output = "latex"
T <- TRUE

# generate figures
#source("chapter_4/generate_consort_diagram.R")
source("final_cleaning_scripts/generate_visits_df.R")
source("final_cleaning_scripts/load_and_clean_followup_and_enroll_labelled.R")
source("other_scripts/summary_table_functions.R")
source("final_cleaning_scripts/make_composite_hivstatus_variable.R")
#source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_bloods.R")
source("final_cleaning_scripts/load_and_clean_aetiol.R")
source("final_cleaning_scripts/load_and_clean_hourly.R")
source("final_cleaning_scripts/load_and_clean_upto72.R")
source("final_cleaning_scripts/load_and_clean_post72.R")
source("final_cleaning_scripts/load_and_clean_hosp_oc.R")
source("final_cleaning_scripts/load_and_clean_time_to_ab.R")
source("final_cleaning_scripts/load_and_clean_fluid_hr1_to_6.R")



h1.ustand <- read.csv("/Users/joelewis/Documents/PhD/Data/Current/portal_downloads/other_datasets/h1_ustand.csv")

e1$datefirstunwell[e1$unwelfreq == "Weeks"] <- e1$datefirstunwell[e1$unwelfreq == "Weeks"] * 7
e1$datefirstunwell[e1$unwelfreq == "Months"] <- e1$datefirstunwell[e1$unwelfreq == "Months"] * 30

# calc time to recruitment

hourly %>% group_by(pid) %>% summarise(first_ax = min(date_time, na.rm= T)) -> fa

merge(select(df.abs, pid, earliest_arr_time), fa, all.x = T) -> fa
difftime(fa$first_ax, fa$earliest_arr_time, units = "hours") -> fa$dt
fa$dt2 <- fa$dt
fa$dt2[fa$dt2 > 1] <- fa$dt2[fa$dt2 > 1] -1

time_to_rec_str <- median_iqr_str(as.numeric(fa$dt2),1)

df <- subset(enroll, arm == 1)
df$gcs <- df$t0gcse + df$t0gcsv + df$t0gcsm
df <- merge(df, bloods, all.x = T)

aetiol.m <- dcast(aetiol, pid + hivstatus ~ type, value.var = "pathogen")
aetiol.m$tb <- aetiol.m$`mtb bsi`== 1 | aetiol.m$uLAM == 1 | aetiol.m$Xpert == 1

df <- merge(df, select(aetiol.m, - hivstatus), all.x = T)

df <- merge(df, select(df.abs, pid, first_ab, time_to_abx))

df <- merge(df, select(df.tb, pid, any_tb_rx, time_to_tb_rx))

df <- merge(df, select(fluid, pid, `6`))
names(df)[names(df) == "6"] <- "fluid_6hr"

df.mal.b <-select(df.mal, pid, first_ab, time_to_mal_rx)
names(df.mal.b)[2:3] <- c("first_mal_rx", "time_to_mal_rx")

df <- merge(df, df.mal.b)
rm(df.mal.b)

df.fung.b <-select(df.fung, pid, first_ab, time_to_fung_rx)
names(df.fung.b)[2:3] <- c("first_fung_rx", "time_to_fung_rx")

df <- merge(df, df.fung.b)
rm(df.fung.b)

df[df == 999] <- NA

#aetiol.m -> a
#a[is.na(a)] <- 0
#a$no_diagnosis <- as.numeric(apply(a[3:8], 1,sum) == 0)



v1 <- visits %>% filter(arm == 1) 

v1$t <- apply(v1[7:10], 1,max, na.rm= T )

v1$t[!is.na(v1$died_date)] <- v1$died_date[!is.na(v1$died_date)]

#v1$t <- v1$t * 7
v1$died <- v1$status
v1$died[v1$died == 2] <- 0

v1 <- select(v1, pid, enrolled, arm, t, died)

#v1$d28_death

v1$d28_death <- NA

v1$d28_death[(v1$t <= 28) & (v1$died == 1)] <- 1
v1$d28_death[(v1$t >= 28)] <- 0

v1$d90_death[(v1$t <= 90) & (v1$died == 1)] <- 1
v1$d90_death[(v1$t >= 90)] <- 0

v1$d180_death[(v1$t <= 180) & (v1$died == 1)] <- 1
v1$d180_death[(v1$t >= 180)] <- 0

df <- merge(df, v1, all.x = T)

df$sbp.dic <- (df$t0sbp <= 90)
df$t.dic <- NA
df$t.dic[df$screentemp < 36] <- "<36"
df$t.dic[df$screentemp >= 36 & df$screentemp < 38] <- "36-38"
df$t.dic[df$screentemp >= 38] <- ">38"

df$hr.dic <-  (df$t0hr > 100)
df$rr.dic <-  (df$t0rr > 30)
df$cd4.dic <- (df$CD4_Absolute <= 200)
df$spo2.dic <- (df$t0spo2 < 90)
df$gcs.dic <- (df$gcs < 15)
df$lact.dic <- (df$lactate_value > 3)
as.numeric(df$WCC) > 11 -> df$WCC.dict
df$CO2.dic <- as.numeric(df$CO2 < 23)

# assess bivariate distributions
df$t0map <- (df$t0sbp + (df$t0dbp * 2))/3 

df$tb[df$tb] <- 1
df$tb[df$tb == FALSE | is.na(df$tb) ] <- 0

df$malaria[is.na(df$malaria)] <- 0
df$bc[is.na(df$bc)] <- 0
df$csf[is.na(df$csf)] <- 0





```

## Chapter overview

## Methods

blah blah



## Results

### Study population

Figure \@ref(fig:consort-diag) shows flow through the study. 225 participants were recruited in 20 months between 19th February 2017 and 2nd October 2018. Participants were recuited, in general, soon after arrival in hospital, a median (IQR) of `r time_to_rec_str ` hours after fist attendance. In total, 4 participants (2%) were lost to follow up over the 180-day study period; 5 participants (2%) withdrew; and 7 participants (3%) transferred out of the study area before 180 days. Four of the five participants who withdrew gave a reason for their wish to withdraw, all that they no longer wished the inconvenience of being involved in the study. 15/225 (7%) participants had their final study visit before 180 days, and so were not included in the 180-day outcome analysis.

### Symptoms and health-seeking behaviour

Table \@ref(tab:sep-t1-demog-dassim) shows the baseline characteristics of the recruited participants. They were young (median [IQR] age 36 [28-44]) and predominantly HIV-infected. Of those who were HIV-infected, the majority (117/143 [82%]) were on ART, almost exclusively the Malawian first-line regimen of efavirenz, lamivudine and tenofovir, and 88/117 (75%) had been taking ART for more than three months. Figure \@ref(fig:sep-present) shows the presenting symptoms of the participants. Almost all (221/225 [98%] of participants) experienced subjective fever. Participants had been unwell for some time, a median (IQR) of `r median_iqr_str(e1$datefirstunwell)` days; 32/225 (14%) of participants had been unwell for more than 4 weeks. 18/225 (8%) of participants had been admitted to hospital within the last 4 weeks. Over half (123/225 [55%]) of participants had sought care for their current ilness (Table \@ref(tab:sep-healthseek)), most commonly (101/123 [82%] of participants) at a government health centre, a median (IQR) of 2 (1-6) days previously. 60/225 (27%) of all participants had recieved an antimicrobial for their current illness: 7/60 (12%) of all prehospital antimicrobials were antimalarials, the remainder anitbacterial, most commonly co-trimoxazole or ciprofloxacin. Prehopsital intravenous or intramuscular antimirobials were administered in 16/60 (27%) participants recieving antimicrobials: ceftriaxone (n=6), benzylpenicillin (n=4), gentamicin (n=3) and artesunate (n=3).

```{r consort-diag, echo = F, fig.cap = "Study recruitment and follow up.",  out.height = '12cm', fig.align = 'center'}

knitr::include_graphics(paste0(wd, "/figures/consort_diagram.pdf"))

```

\renewcommand{\arraystretch}{0.8}
```{r sep-t1-demog-dassim, echo = F, warning = F, message = F}

e1 <- subset(enroll, arm == 1)
e1$art.time <- as.numeric((e1$data_date - e1$hivartstart) /(365.25/12))
e1$hivart[e1$hivart != "5A" & !is.na(e1$hivart)] <- "ART regimen: other"
e1$animalskept[e1$animalskept == "Other"] <- "Elsewhere"
e1$keep.other[e1$keep.cattle == "Yes" | e1$keep.sheep == "Yes" | e1$keep.mules == "Yes"] <- "Yes"
e1.sum <- select(e1, calc_age, ptsex, hivstatus,tbstatus, tbongoing, hivonart, hivart, art.time, hivcpt, 
                  tobaccoyn, alcoholyn,  highestedu,
                 job,  toilet , watersource,
                 electricityyn, fuel, 
                 keepanim, keep.poultry,  keep.goats,
                 keep.dogs, keep.other)

pretty_tbl_df(e1.sum) -> e1.sum
## tweeaky tweaky
e1.sum <- subset(e1.sum, `levels` != "No")
e1.sum <- subset(e1.sum, `levels` != "Female")

e1.sum$levels[e1.sum$variable == "calc_age"] <- "Age (years)"
e1.sum$levels[e1.sum$variable == "ptsex"] <- "Male sex"
e1.sum$variable[e1.sum$variable %in% c("calc_age", "ptsex")] <- "Demographics"

# art variables
e1.sum$levels[e1.sum$levels %in% c("Reactive", "Non reactive", "Unknown")] <- 
  paste0("HIV ", str_to_title(e1.sum$levels[e1.sum$levels %in% c("Reactive", "Non reactive", "Unknown")]))
e1.sum$levels[e1.sum$variable == "hivonart"] <- "Current ART"
e1.sum$levels[e1.sum$variable == "hivcpt"] <- "Current CPT\\textsuperscript{\\dag}"
e1.sum$levels[e1.sum$levels == "5A"] <- "ART regimen: EFV/3TC/TDF"
e1.sum$levels[e1.sum$variable == "art.time"] <- "Months on ART"
e1.sum$variable[e1.sum$variable == "hivstatus"] <- "HIV/TB status"
e1.sum$variable[grepl("art", e1.sum$variable)] <- "ART status*"
e1.sum$variable[grepl("cpt", e1.sum$variable)] <- "ART status*"
# tb variables
e1.sum$levels[e1.sum$variable == "tbstatus"] <- "Ever treated for TB"
e1.sum$levels[e1.sum$variable == "tbongoing"] <- "Of those, current TB treatment"
e1.sum$variable[grepl("tb", e1.sum$variable)] <- "HIV/TB status"


e1.sum <- e1.sum[c(1:8,11,9,10,12:nrow(e1.sum)),]



# tobacco use
e1.sum$levels[grepl("tobacco", e1.sum$variable)] <- paste0(e1.sum$levels[grepl("tobacco", e1.sum$variable)], " tobacco" )
e1.sum$variable[grepl("tobacco", e1.sum$variable)] <- "Tobacco/alcohol use"

# alcohol use
e1.sum$levels[e1.sum$variable == "alcoholyn"] <- "Current alcohol"
e1.sum$variable[grepl("alcohol", e1.sum$variable)] <- "Tobacco/alcohol use"

# education
e1.sum$variable[grepl("highestedu", e1.sum$variable)] <- "Education"

# employment 
e1.sum$variable[grepl("job", e1.sum$variable)] <- "Employment"

# toilet

e1.sum$variable[grepl("toilet", e1.sum$variable)] <- "Toilet facilities"

# toilet

e1.sum$variable[grepl("water", e1.sum$variable)] <- "Main water source"

# electricity
e1.sum$levels[e1.sum$variable == "electricityyn"] <- "Electricity available in house"
e1.sum$variable[grepl("electric", e1.sum$variable)] <- "Electricty"

e1.sum$variable[grepl("fuel", e1.sum$variable)] <- "Main cooking fuel"

# animals

e1.sum$levels[grepl("keep", e1.sum$variable)] <- e1.sum$variable[grepl("keep", e1.sum$variable)]

sub("keep.", "",e1.sum$levels) -> e1.sum$levels
str_to_title(e1.sum$levels[grepl("keep", e1.sum$variable)] ) -> e1.sum$levels[grepl("keep", e1.sum$variable)]
e1.sum$levels[e1.sum$levels == "Nim"] <- "Any animal"

e1.sum$variable[grepl("keep", e1.sum$variable)] <- "Animals at home?"

e1.sum <- e1.sum[c(1:45, 47,46,47:nrow(e1.sum)),]

kstring <- make_kable_rowgroup_string(e1.sum)
e1.sum$levels[e1.sum$levels== "Yes" | e1.sum$levels== "Median (IQR)" ] <- 
  e1.sum$variable[e1.sum$levels== "Yes" | e1.sum$levels== "Median (IQR)" ]
#rownames(e1.sum) <- e1.sum$`levels`
#rownames(e1.sum)[!(rownames(e1.sum) %in% kstring)]

sub("%", "\\\\%", e1.sum$value) -> e1.sum$value

kable(select(e1.sum,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = T, escape = F, col.names = c("Variable","Value"), caption = "Participant Characteristics" ) %>%
  kable_styling(full_width = F,latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring) %>%
  footnote(general = "ART = Antiretroviral therapy, CPT = Co-trimoxazole preventative therapy, EFV: Efavirenz, 3TC: Lamivudine, TDF: Tenofovir. Numeric values are median (IQR)) unless otherwise stated.", symbol = c("ART status includes HIV reactive only as denominator", "Missing CPT data for two participants. ") ,threeparttable = T, fixed_small_size = T)



```

```{r sep-healthseek, echo = F, warning = F, message = F}

e1$phxstartdate_n[grepl("Weeks", e1$prehfreq)] <- e1$phxstartdate_n[grepl("Weeks", e1$prehfreq)] * 7
e1$phxstartdate_n[grepl("Months", e1$prehfreq)] <- e1$phxstartdate_n[grepl("Months", e1$prehfreq)] * 30


e1$prehospcaredur[grepl("Weeks", e1$prehospcarefr)] <- e1$prehospcaredur[grepl("Weeks", e1$prehospcarefr)] * 7
e1$prehospcaredur[grepl("Months", e1$prehospcarefr)] <- e1$prehospcaredur[grepl("Months", e1$prehospcarefr)] * 30


e1$ab_startdays[e1$recieved_prehosp_ab == "Yes"] <- e1$phxstartdate_n[e1$recieved_prehosp_ab == "Yes"]
e1$prehosp_ab[e1$recieved_prehosp_ab == "Yes"] <- e1$prehosrxname [e1$recieved_prehosp_ab == "Yes"]
e1$prehospcaretransp[grepl("Min", e1$prehospcaretranspother)] <- "Minibus"


e1.sum.2 <- select(e1, prehospcareyn,soughtcare.other.hospital,soughtcare.other.clinic,soughtcare.pharmacy,soughtcare.private.doctor, soughtcare.other.health.worker ,soughtcare.traditional.practicioner,soughtcare.friend.or.family,soughtcare.other,prehospcaredur, recieved_prehosp_ab,  prehosp_ab,ab_startdays, prehospcaretransp, prehospcaretranspcost)

pretty_tbl_df(e1.sum.2) -> e1.sum.2
subset(e1.sum.2, levels != "No") -> e1.sum.2

e1.sum.2$levels[e1.sum.2$variable == "prehospcareyn"] <- "Sought care prior to attendance at hospital"
e1.sum.2$levels[e1.sum.2$variable == "prehospcaredur"] <- "Days prior to today that participant sought care"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other.hospital"] <- "At hospital"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other.clinic"] <- "At health centre"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.private.doctor"] <- "At private doctor"
e1.sum.2$levels[e1.sum.2$variable == "soughtcare.other"] <- "Somewhere else "

e1.sum.2$variable[e1.sum.2$variable == "prehospcareyn" |
                    e1.sum.2$variable == "prehospcaredur" |
                    grepl("soughtcare" ,e1.sum.2$variable) ] <-  "Pre-hospital healthcare seeking"
e1.sum.2$levels[e1.sum.2$variable == "recieved_prehosp_ab"] <- "Recieved any antimicrobial prior to attendance at hospital"
#e1.sum.2$levels[e1.sum.2$variable == "prehosp_ab"] <- paste0("Recieved ", e1.sum.2$levels[e1.sum.2$variable == "prehosp_ab"])


e1.sum.2$levels[e1.sum.2$variable == "ab_startdays"] <- "Days prior to today that antimicrobials started" 
e1.sum.2$variable[ grepl("prehosp_ab" ,e1.sum.2$variable) | grepl("ab_startdays" ,e1.sum.2$variable) ] <- "Prehospital antimicrobial exposure"

e1.sum.2$levels[e1.sum.2$variable == "prehospcaretranspcost"] <- "Cost (MWK) of transport to hospital"
e1.sum.2$variable[ grepl("prehospcaretransp" ,e1.sum.2$variable) ] <- "Method of transport to hospital"

e1.sum.2 <- e1.sum.2[c(1,3,2,4:nrow(e1.sum.2)),]

kstring2 <- make_kable_rowgroup_string(e1.sum.2)

e1.sum.2$value[c(2,3,4,5,6, 8:21)] <- paste0("\\hspace{1em}", e1.sum.2$value[c(2,3,4,5,6, 8:21)] )

sub("%", "\\\\%", e1.sum.2$value) -> e1.sum.2$value

kable(select(e1.sum.2,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = F, escape = F, col.names = c("Variable","Value"), caption = "Prehospital heathcare seeking and antimicrobial exposure" ) %>%
  kable_styling( full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring2) %>%
  add_indent(c(2,3,4,5,6, 8:21)) %>%
  footnote(general = "LA = Lumefantrine-artemether, SP = Sulfamethoxazole-pyrimethamine, MWK = Malawian Kwacha. Numeric values are median (IQR)) unless otherwise stated." ,threeparttable = T, fixed_small_size = T)

```

```{r sep-present-setup, include = F}


sympt <- e1[names(e1) %in% names(enroll.names)[grepl("symp",enroll.names)]]

sympt[sympt == "No"] <- 0
sympt[sympt == "Yes"] <- 1
(sapply(sympt, as.numeric)) -> sympt

sympt.melt <- melt(sympt) %>% filter(value > 0)
gsub("\\.", " ", sympt.melt$Var2) -> sympt.melt$Var2
str_to_title(sympt.melt$Var2) -> sympt.melt$Var2
ggplot(sympt.melt, aes(fct_rev(fct_infreq(Var2)))) +
  geom_bar() + coord_flip() + theme_bw() +
  labs(x= "", y = "Count") -> p1

gsub("\\.", " ", dimnames(sympt)[[2]]) -> dimnames(sympt)[[2]]
str_to_title(dimnames(sympt)[[2]]) -> dimnames(sympt)[[2]]
grid.grabExpr(pheatmap(sympt[1:225,1:25], legend = F, fontsize = 7)) -> p2
as_ggplot(p2) ->p2

```

```{r sep-present, echo = F, warning = F, message = F, fig.scap="Symptoms of recruited participants", out.extra='', fig.cap="Symptoms of recruited participants. A: Row and column clustered heatmap of participant symptoms. Each row represents a patient. Red = presence, blue = absence. B: Frequency of occurence of symptoms", fig.width = 8, fig.height = 5, out.height= '40%'}

ggarrange(p2,p1, labels = c("A", "B"), widths = c(1, 1)) 
```


### Admission physiology and laboratory investigations

Admission vital signs and laboratory investigations are shown in Table \@ref(tab:sep-physiol). Despite high ART coverage (117/143 [82%]) amongst HIV-infected participantsfor a median of 29 months, the median (IQR) CD4 count was low at 98 (31-236) cells $\mu$L\textsuperscript{-1}. 108/141 (70%) of participants had a CD4 count below 200 cells $\mu$L\textsuperscript{-1}. CD4 count was similar in participants who had started ART more than 6 months ago as compared to less than three months ago (median [IQR] 99 [27-260] vs 93 [39-137] cells $\mu$L\textsuperscript{-1} respectively) and 42/83 (51%) of participants who had been taking ART for more than 6 months had a CD4 count of less than 100 cells $\mu$L\textsuperscript{-1}, and would fulfil a WHO definition of immunological failure.

```{r sep-physiol, echo = F, warning = F, message = F}

# merge in bloods
e1[e1 == 999] <- NA
e1 <- merge(e1,bloods, all.x = T)
e1 <- merge(e1, h1.ustand, all.x= T)
e1$gcs <- e1$t0gcse + e1$t0gcsv + e1$t0gcsm
e1$gcs.cat <- NA
e1$gcs.cat[e1$gcs == 15] <- "15"
e1$gcs.cat[e1$gcs > 10 & e1$gcs < 15] <- "11-14"
e1$gcs.cat[e1$gcs < 11] <- "10 or below"



e1$CD4_hiv_pos <- NA
e1$CD4_hiv_pos[e1$hivstatus == "Reactive"] <- e1$CD4_Absolute[e1$hivstatus == "Reactive"] 
e1$Neutrophils_count <- as.numeric(e1$Neutrophils_count )

rbind(
  pretty_tbl_df(
    select(e1, t0hr, t0sbp, t0dbp, t0rr, t0spo2, gcs.cat, CD4_hiv_pos)
    ),
  
  pretty_tbl_df(
    select(e1, screentemp, Haemoglobin, WCC, Neutrophils_count,  Potassium, Urea, lactate_value)
    ,r = 1),
  pretty_tbl_df( 
    select(e1, Platelets, Chloride, CO2, Creatinine, NA. )
    )
  ) -> e1.sum.3

e1.sum.3$levels[e1.sum.3$variable == "screentemp"] <- "Temperature (\\textdegree C)"
e1.sum.3$levels[e1.sum.3$variable == "t0hr"] <- "Heart rate (min\\textsuperscript{-1}))"
e1.sum.3$levels[e1.sum.3$variable == "t0sbp"] <- "Systolic blood pressure (mmHg)"
e1.sum.3$levels[e1.sum.3$variable == "t0dbp"] <- "Diatsolic blood pressure (mmHg)"
e1.sum.3$levels[e1.sum.3$variable == "t0rr"] <- "Respiratory rate (min\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "t0spo2"] <- "Oxygen saturation (%)"
e1.sum.3$levels[e1.sum.3$levels == "15"] <- "15"
e1.sum.3$levels[e1.sum.3$levels == "11-14"] <- "11-14"
e1.sum.3$levels[e1.sum.3$levels == "10 or below"] <- "< 11"
e1.sum.3$levels[e1.sum.3$variable == "CD4_hiv_pos"] <- "CD4 count* ($\\mu$L\\textsuperscript{-1})"

e1.sum.3$levels[e1.sum.3$variable == "Haemoglobin"] <- "Haemoglobin (x10\\textsuperscript{9} g dL\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "WCC"] <- "White cell count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Neutrophils_count"] <- "Neutrophil count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Platelets"] <- "Platelet count count (x10\\textsuperscript{9} L\\textsuperscript{-1})"

e1.sum.3$levels[e1.sum.3$variable == "NA."] <- "Sodium (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Potassium"] <- "Potassium (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Urea"] <- "Urea (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "CO2"] <- "Bicarbonate (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "Creatinine"] <- "Creatinine (mmol L\\textsuperscript{-1})"
e1.sum.3$levels[e1.sum.3$variable == "lactate_value"] <- "Lactate (mmol L\\textsuperscript{-1})"

sub("%", "\\\\%", e1.sum.3$value) -> e1.sum.3$value
sub("%", "\\\\%", e1.sum.3$levels) -> e1.sum.3$levels
rbind(e1.sum.3, data.frame(variable = "Admission physiology", `levels` = "GCS", value = " ")) -> e1.sum.3

e1.sum.3 <- e1.sum.3[c(10,1:5,22,6:8, 9,11,12,13,17,21,14,19,18,15,20,16),]
e1.sum.3$variable[1:10] <- "Admission physiology"
e1.sum.3$variable[11] <- "Admission CD4 count"
e1.sum.3$variable[12:15] <- "Admission haematology"
e1.sum.3$variable[16:nrow(e1.sum.3)] <- "Admission biochemistry"
kstring3 <- make_kable_rowgroup_string(e1.sum.3)

kable(select(e1.sum.3,`levels`,value), "latex", booktabs =T, 
      row.names = F, longtable = F, col.names = c("Variable","Value") ,escape = F,caption = "Admission physiology, haematology and biochemistry" ) %>%
  kable_styling("striped", full_width = F, latex_options = c("repeat_header", "hold_position")) %>%
  group_rows(index = kstring3) %>%
  add_indent(c(8:10)) %>%
  footnote(general = "GCS = Glasgow coma scale. Numeric values are median (IQR)) unless otherwise stated." , symbol = "CD4 count includes only HIV-infected participants; 2 values were missing.", threeparttable = T, fixed_small_size = T)

```

\clearpage

### Aetiology

In total, 51% (114/225) of the 225 participants had at least one infectious agent identified (Table \@ref(tab:sep-diag)), most commonly tuberculosis (76/225 [34%]) followed by bloodstream infection (24/225 [11%]) and malaria (21/225 [9%]). Table \@ref(tab:sep-tests) shows the availability of test and proportion of positive tests across the cohort, stratified by HIV status. 2/225 patients (1%) had a missing aerobic blood culture; the remaining 223 patients had a total of 259 blood cultures performed. 15/259 (6%) blood cultures grew at least one contaminant, but 26 blood cultures from 24 patients were positive for a total of 28 pathogenic bacteria (Figure \@ref(fig:sep-bc-plot)): _Salmonella_ Typhi was the most commonly isolated pathogenic bacterium, and seemed to show an association with HIV-negative participants: all (8/8) of the participants from whom _S._ Typhi was isolated and whose HIV status was known were HIV noninfected. Of the 18 Gram negative bacteria isolated, 3/18 (17%) were cefpodoxime resistant on AST via disc diffusion testing, and likely ESBL producers: one _K. pneumoniae_ and one _E. coli_ (both from the same blood culture and same patient) and one _Acinetobacter baumannii_. Both _Staphyloccus aureus_ isolates were oxacillin sensitive. The one _Streptococcus pneumoniae_ cultured was penicillin intermediate on AST.

Lumbar puncture and CSF culture was carried out in 44 participants: 5/44 (11%) of samples grew a contaminent and no pathogenic bacteria were recovered from any sample. 4/44 (9%) had a detectable cryptococcal antigen (CRAG) in CSF. Malaria testing was missing for 6/225 (3%) of participants, but of the remainder, a positive malaria test was more likely in the HIV-uninfected (12/69 [17%] vs 6/138 [4%], p = 0.01 on pairwise Fisher's exact test). Positive aerobic blood culture showed no statistically significant association with HIV, nor did positive CSF testing, though in the latter case numbers were small and all positive tests (all positive CRAG) were in fact in the HIV-infected (Table \@ref(tab:sep-tests)).

Testing for TB, with the exception of sputum Xpert testing, was restricted to HIV-infected participants. Sputum Xpert was carried out in 44/225 (20%) of participants, and was more commonly carried out in the HIV-infected: 35/143 [24%] of HIV-infected participants had sputum testing performed vs 8/70 (11%) of HIV uninifected (p = 0.07 by Fisher's exact test). 53 sputum samples were sent in total from the 44 patients, and 8/44 (18%) diagnoses of TB made, all except one in HIV-infected participants. One sample identified a rifampicin resistance gene; the remainder of infections were rifampcin-sensitive. 

155 participants were eligible for urinary lipoarabinomannan (uLAM) and mycobacterial blood culture testing, being either HIV-infected (n=143) or of unknown HIV status (n=12). Urine was available for 145/155 (94%) of those eligible, and 74/145 (51%) of samples were positive for uLAM. 150/155 (97%) of eligible participants had blood samples collected and cultured for mycobacteria. 12/150 (8%) grew contaminents and are excluded from the denominators in Table \@ref(tab:sep-tests); of the remainder 8/138 (6%) grew mycobacteria, all _M. tuberculosis_.

Figures \@ref(fig:sep-upset-plot) and \@ref(fig:sep-euler-plot) show the overlap of positive tests form the different diagnostic modalities. Of the 114 patients with at least one positive diagnosic test, 90/114 (79%) had only one positive diagnostic test. The exceptions to this were mycobacterial blood culture and sputum Xpert: patients who had TB diagnosed by these tests tended to also have a positive uLAM. 2/4 (50%) of patients with positive CSF testing (all of whom had detectible CRAG) had also grew _Cryptococcus neoformans_ in aerobic blood culture. 111/225 (49%) of patients remained with no diagnosis.

```{r sep-diag, echo = F, warning = F, message = F}

aetiol.m <- dcast(aetiol, pid + hivstatus ~ type, value.var = "pathogen")
aetiol.m$tb <- aetiol.m$`mtb bsi`== 1 | aetiol.m$uLAM == 1 | aetiol.m$Xpert == 1
aetiol.m -> a
a[is.na(a)] <- 0
a$no_diagnosis <- as.numeric(apply(a[3:8], 1,sum) == 0)

melt(select(a, pid, hivstatus, tb, bc, malaria, csf, no_diagnosis), id.vars = c("pid", "hivstatus")) %>% dplyr::group_by(variable) %>% dplyr::summarise(n = dplyr::n(), positive = sum(value == 1)) -> t

t$prop <-  paste0(t$positive, "/",  t$n, " (",
                         format(round((t$positive*100/t$n), 0), nsmall = 0),
                         "%)"
)

t$variable <- c("Tuberculosis", "Bloodstream infection", "Malaria", "Meningitis", "No diagnosis")

kable(select(t, variable, prop), "latex", booktabs =T, 
      row.names = F, longtable = F, col.names = c("Diagnosis","Proportion of participants") ,escape = T,caption = "Final diagnosis of all participants" ) %>%
  kable_styling( full_width = F)# %>%
#  footnote(general = "Tuberculsosis includes and positive tuberculosis diagnostic test; bloodstream infection includes any patient with at least one positive blood culture, excluding contaminants; meningitis includes any positive CSF culture, excluding contaminents, or positive cryptococcal antigen test in CSF ", threeparttable = T)



```

```{r sep-tests, echo = F, warning = F, message = F}


aetiol$type <- as.factor(aetiol$type)

aetiol %>% dplyr::group_by(hivstatus, type, .drop = FALSE) %>% dplyr::summarise(positive = sum(pathogen == 1), n = dplyr::n()) -> t2

aetiol %>% dplyr::group_by(type, .drop = FALSE) %>% dplyr::summarise(positive = sum(pathogen == 1), n = dplyr::n()) -> t2.tot

t2$prop <-  paste0(t2$positive, "/",  t2$n, " (",
                         round((t2$positive*100/t2$n), 0),
                         "%)"
)

t2.tot$prop <-  paste0(t2.tot$positive, "/",  t2.tot$n, " (",
                         round((t2.tot$positive*100/t2.tot$n), 0),
                         "%)"
)

t2.tot$hivstatus <- "Total"
bind_cols(subset(t2, hivstatus == "Reactive"), 
          subset(t2, hivstatus == "Non reactive"),
          subset(t2, hivstatus == "Unknown"),
          t2.tot) -> t2

round(apply(t2[c(3,8,13,4,9,14)], 1, function(x) chisq.test( matrix(x, ncol = 2))$p.value),3) -> t2$p

t2$prop1[grepl("NaN", t2$prop1)] <- "-"
t2$p[grepl("NaN", t2$p)] <- "-"

t2$type <- as.character(t2$type)

t2 <- t2[c(5,6,4,1,2,3),]
t2$type <- c("Urinary LAM", "Sputum Xpert", "TB blood culture", "Aerobic blood culture", "CSF culture or CRAG", "Malaria RDT")

t2[c(2,5,10,15,19,21)] -> t2
names(t2) <- c("Test", "Positive", "Negative", "Unknown","All", "p")

t2.n <- e1 %>% dplyr::group_by(hivstatus, .drop = FALSE) %>% dplyr::summarise (n = dplyr::n())

rbind(
  data.frame(Test = "Number of participants", Positive = t2.n$n[t2.n$hivstatus == "Reactive"], 
             Negative = t2.n$n[t2.n$hivstatus == "Non reactive"],
             Unknown = t2.n$n[t2.n$hivstatus == "Unknown"],
             All = sum(t2.n$n),
             p = "-"),
  t2
) -> t2

kable(t2, "latex", booktabs =T, 
      row.names = F, longtable = F,escape = T,caption = "Positive diagnostic tests for all participants, stratified by HIV status."  ) %>%
  kable_styling( full_width = F) %>%
group_rows(index=c(" " = 1, "TB diagnostics" = 3, "Other diagnostics" = 3)) %>%
  add_header_above(c(" ", "HIV status" = 3, " ", " ")) %>%
  column_spec(5, bold = TRUE) %>%
  footnote(general = "LAM = Lipoarabinomannan, CSF = Cerebrospinal fluid, CRAG = Cryptococcal antigen, RDT = Rapid diagnostic test. p-values are chi-squared test across the three HIV status strata, and hence may be different from the pairwise exact Fisher's tests presented in the text. Urinary LAM and TB blood culture were not carried out in HIV negative participants.", threeparttable = T,  fixed_small_size = T)

```

```{r sep-bc-plot, echo = F, warning = F, message = F, fig.scap="Pathogenic isolates recovered from aerobic blood culture.", out.extra='', fig.cap="Pathogenic isolates recovered from aerobic blood culture. 26 blood cultures in 24 participants  were positive for 28 pathogens in total", fig.width = 7, fig.height = 2.3, out.height= "70%"}

melt(bc.full[c("pid", "typhi", "saen", "saty", "esco","klpn", "hib", "stpn", "crne", "acba", "enfam", "enfas", "stau", "prot")]) %>% filter (value > 0) -> bc.full.melt



merge(bc.full.melt, select(enroll, pid, hivstatus)) -> bc.full.melt

bc.full.melt$hivstatus <- factor(bc.full.melt$hivstatus, levels = c("Reactive", "Non reactive", "Unknown"))


ggplot(bc.full.melt, aes(fct_rev(fct_infreq(variable)), fill = hivstatus)) + geom_bar(alpha = 0.8) + coord_flip() + scale_fill_manual(values = c(pal_lancet()(2)[c(2,1)], "darkgrey"), labels = c("HIV+", "HIV-", "Unknown"), name = "HIV status") + theme_bw() +
  scale_x_discrete("", labels = expression(italic("Proteus mirabilis"),italic("Enterococcus faecium"),italic("Acinetobacter baumannii"), italic("Streptococcus pneumoniae"),italic("Haemophilus influenzae"),italic("Klebsiella pneumoniae"),italic("Stapylococcus aureus"),italic("Cryptococcus neoformans"),paste(italic("Salmonella"), "Typhimurium"),italic("Escherichia coli"),paste(italic("Salmonella"), "Typhi"))) + scale_y_continuous(name = "n", breaks = c(0,2,4,6,8,10)) 


```

```{r sep-euler-plot, echo = F, warning = F, message = F, fig.scap="Venn diagram of positive diagnostic tests", out.extra='', fig.cap="Venn diagram showing overlap of positive diagnostic tests; culture of blood and CSF shown in red, malaria in green and TB diagnostics in blue. The CSF variable in includes either a positive culture for a pathogenic bacteria or positive cryptococcal antigen, BSI a positive aerobic culture of pathogenic bacteria from blood and MTB BSI a positive mycobacterial culture of tuberculosis from blood. BSI: Bloodstream infection, CSF: Cerebrospinal fluid, CRAG: Cryptococcal antigen, mRDT: Malaria rapid diagnostic test, MTB BSI: Mycobacterium tuberculosis bloodstream infection, uLAM: urinary lipoarabinomannan.", fig.width = 5, fig.height = 6, out.height = "70%"}

 set.seed (99)
euler(as.data.frame(sapply(a[c(3:8, 10)], as.logical)), shape = "circle") -> eul

plot(eul, edges = "grey30", labels = list(labels = c("BSI","CSF","Malaria","MTB BSI","uLAM","Xpert","No diagnosis"), fontsize = 12), fills = list(fill =c(hue_pal()(3)[1],hue_pal()(3)[1], hue_pal()(3)[2], hue_pal()(3)[3],hue_pal()(3)[3], hue_pal()(3)[3] , "grey" ), alpha = 0.8)) 




```


```{r sep-upset-plot, echo = F, warning = F, message = F, fig.scap="UpSet plot of positive diagnostic tests", out.extra='', fig.cap="UpSet plot of overlap of positive diagnostic tests, showing that for the majority of participants, one test alone is positive. Red colour indicates HIV-infected; black is a composite of HIV-negative and unknown. The CSF variable in includes either a positive culture for a pathogenic bacteria or positive cryptococcal antigen, BSI a positive aerobic culture of pathogenic bacteria from blood and MTB BSI a positive mycobacterial culture of tuberculosis from blood. BSI: Bloodstream infection, CSF: Cerebrospinal fluid, CRAG: Cryptococcal antigen, mRDT: Malaria rapid diagnostic test, MTB BSI: Mycobacterium tuberculosis bloodstream infection, uLAM: urinary lipoarabinomannan.", fig.width = 6, fig.height = 5, out.height = "50%"}



names(a) <- c("pid", "hivstatus", "BSI", "CSF culture/CRAG +", "mRDT", "MTB BSI", "uLAM+", "Sputum Xpert+",
              "tb", "No Diagnosis")

#upset(a[-9], nsets = 7,order = "freq", queries = list(list(query = elements, params = list("hivstatus", "Reactive", color = "#FC8D62" , active = T)))) 

#pdf(file = paste0(wd, "figures/upset.pdf"), width = 6, height = 5)
upset(a[-9], nsets = 7,order = "freq", query.legend = "bottom",
      queries = list(
        list(query = elements, params = list("hivstatus", "Reactive"), color = pal_lancet()(2)[2] , active = T, 
             query.name = "HIV+")
      )
)
#dev.off()      
 


```


### Treatment

At least one antimicrobial drug was recieved by 95% (214/225) of the cohort during their admission (Table \@ref:(time-to-ab-table)), most commonly an antibacterial (207/225 [92%]), but also a significant minority recieved antitubercular therapy (63/225 [28%]). Of those receiving antitubercular therapy, 16% (10/63) were taking the medication prior to admission, and the remainder were initiated on therapy during admission. The first antibacterial agent administered was most often ceftriaxone, in 87% (181/207) of cases but ciprofloxacin (18/207 [9%] of participants), amoxicillin (6/207 [3%]) and metronidazole (2/207 [1%]) were also used. Median door to antimicrobial time was 5.3 (IQR 3.7-10.8) hours for antibacterials and 4.5 (IQR 3.1-21.7) hours for antimalarials but longer for antifungals at 47.7 (IQR 27.9-73.9) hours and longer still for antitubercular therapy at 120.9 (IQR 63.7-171.0). Cumulative incidence curves for administration of the different antimicrobial classess are shown in Figure \@ref(fig:sep-abtime-fluid-plot)A-D.

Of all participants, 85% (192/225) received any intravenous fluid in the first 6 hours of enrollment to the study; of these, most received 0.9% saline (160/192 [83%] of those recieving fluid) but 5% dextrose (91/192 [57%]) were also used; Ringer's lactate (6/192 [6%]) and blood (2/192 [1%]) were rarely administered. Of the 192 patients who were administered any fluid, a median of 1.5L (IQR 1-2L) was administered over the 6hr study period; fluid administration as a function of time is shown in Figure \@ref(fig:sep-abtime-fluid-plot)E.

```{r treatment-setup, include = F}

df.abs$event <- as.numeric(!df.abs$first_ab == "none")
df.abs$t <- df.abs$time_to_abx
df.abs$t[df.abs$event == 0] <- 1000

df.tb$event <- as.numeric(df.tb$any_tb_rx == "yes" | df.tb$any_tb_rx == "on admission")
df.tb$t <- df.tb$time_to_tb_rx
df.tb$t[df.tb$any_tb_rx == "on admission"] <- 0
df.tb$t[df.tb$any_tb_rx == "none"] <- 1000


df.mal$event <- as.numeric((!is.na(df.mal$time_to_mal_rx)))
df.mal$t <- df.mal$time_to_mal_rx
df.mal$t[df.mal$event == 0] <- 1000

df.fung$event <- as.numeric((!is.na(df.fung$time_to_fung_rx)))
df.fung$t <- df.fung$time_to_fung_rx
df.fung$t[df.fung$event == 0] <- 1000

survfit(Surv(t, event) ~ 1, data = df.fung) -> fit.fung
survfit(Surv(t, event) ~ 1, data = df.mal) -> fit.mal
survfit(Surv(t, event) ~ 1, data = df.tb) -> fit.tb
survfit(Surv(t, event) ~ 1, data = df.abs) -> fit

fit$am.type <- "abs"
fit.tb$am.type <-"tb"
fit.mal$am.type <-"malaria"
fit.fung$am.type <-"antifucngals"

fit.all <- bind_rows(
  data.frame(time = fit$time, surv = fit$surv, 
             lower= fit$lower, upper = fit$upper,
             type = "abs", stringsAsFactors = F),
  data.frame(time = fit.tb$time, surv = fit.tb$surv, 
             lower= fit.tb$lower, upper = fit.tb$upper,
             type = "tb", stringsAsFactors = F),
  data.frame(time = fit.mal$time, surv = fit.mal$surv, 
             lower= fit.mal$lower, upper = fit.mal$upper,
             type = "malaria", stringsAsFactors = F),
  data.frame(time = fit.fung$time, surv = fit.fung$surv, 
             lower= fit.fung$lower, upper = fit.fung$upper,
             type = "antifungal", stringsAsFactors = F),
  
)

ab_sum_tbl <- data.frame(
  antimicrobial = c(rep("Antibacterial",1), rep("Antimalarial",1), 
                    rep("Antifungal",1),  rep("Antitubercular",1)),
  t = c(median_iqr_str(as.numeric(df.abs$time_to_abx),1),median_iqr_str(as.numeric(df.mal$time_to_mal_rx),1),
        median_iqr_str(as.numeric(df.fung$time_to_fung_rx),1),median_iqr_str(as.numeric(subset(df.tb, any_tb_rx == "yes")$time_to_tb_rx),1)),
  n = c(prop_str(as.numeric(df.abs$event))[[1]], prop_str(as.numeric(df.mal$event))[[2]],
        prop_str(as.numeric(df.fung$event))[[2]], paste0(prop_str(as.numeric(df.tb$event))[[2]], "*"))
)

ab_sum_tbl[c(1,3,2)] -> ab_sum_tbl
ab_sum_tbl[c(1,4,3,2),] -> ab_sum_tbl

```

```{r time-to-ab-table, echo =F, warning=F, message=F}

kable(ab_sum_tbl, "latex", booktabs =T, 
      row.names = F, longtable = F,escape = T,
      caption = "Door-to-antimicrobial times.",
      col.names = c("Antimicrobial class", "No. participants", "Median [IQR] time (hours)")) %>%
  kable_styling( full_width = F) %>%
  footnote(symbol = "10/63 participants who received antitubercular agents during admission were taking them prior to admission; they are excluded from the calculation of median door-to-antimicrobial time for this class. ", threeparttable = T, fixed_small_size = T)

subset(e1, !(pid %in% subset(df.abs, first_ab != "none")$pid | pid %in% subset(df.mal, !is.na(first_ab))$pid  | 
               pid %in% subset(df.fung, !is.na(first_ab))$pid   | pid %in%  subset(df.tb,any_tb_rx != "none")$pid ))$pid -> a


```

```{r treatment-plot-setup, include = F}


brk <-  seq(0,192, 24)

p.abs <- ggplot(filter(fit.all, type == "abs"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,1), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw()+ scale_x_continuous(breaks =brk)

p.tb <- ggplot(filter(fit.all, type == "tb"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.3), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw()  + scale_x_continuous(breaks =brk)

p.mal <- ggplot(filter(fit.all, type == "malaria"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.15), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw() + scale_x_continuous(breaks =brk)

p.fung <- ggplot(filter(fit.all, type == "antifungal"), aes(time, (1-surv))) + 
  geom_line() + 
  coord_cartesian(ylim = c(0,0.15), xlim = c(0,192)) + 
  geom_ribbon(aes(ymin = 1-upper, ymax= 1-lower), color = NA, alpha = 0.3 ) +
  labs(x = "Time (hours)", y = "Proportion") +
  theme_bw() + scale_x_continuous(breaks =brk)

ggplot(fluid %>% pivot_longer(-pid), aes(name, value)) + geom_jitter(size = 0.5, color = "darkgrey") + geom_boxplot(alpha = 0.6, width = 0.5, outlier.shape = NA) + theme_bw() + labs(x= "Time (hours)", y = "Volumme (ml)") -> p.fluid


            
  
##pp <- ggdraw() +
##  draw_plot(p.abs) +
##  draw_plot(plt.inset, x = 0.3, y = 0.1, width = 0.5, height = 0.5)

```
```{r sep-abtime-fluid-plot, echo = F, warning = F, message = F, fig.scap="Antimicrobial and fluid administration as a function of time.", out.extra='', fig.cap="Timing of antimicrobial and fluid administration. A-D: Cumulative incidence of administration of antibacterial (A), antitubercular (B), antifungal (C) and antimalarial (D) agents as a function of time since arrival at hospital in hours. E: Total volumne of administered intavenous fluid as a function of time since enrollment to study in hours. Boxplots show median, quartiles box and 1.5 times interquartile range as whiskers. Points are jittered around the hour at which they were measured to show distribution. ", fig.width = 6, fig.height = 8, out.width= "80%", fig.align= "center"}

ggarrange(
  ggarrange(p.abs, p.tb, ncol = 2, nrow = 1, labels = c("A", "B")), 
  ggarrange(p.fung, p.mal, ncol = 2, nrow = 1, labels = c("C", "D")),
  ggarrange(NULL, p.fluid, NULL, ncol = 3, nrow = 1, widths = c(0.5,1,0.5), labels = c(NA, "E", NA)),
            ncol = 1,nrow = 3)

```

### Outcome

```{r los-setup, include = F}

los <- merge(select(e1, pid, data_date), select(oc, pid, hospoutcome, hoc.datetime ), all.x = T)
los$hoc.datetime <- date(los$hoc.datetime)
los$los <- difftime(los$hoc.datetime, los$data_date, units = "days")

los_str <- median_iqr_str(as.numeric(subset(los, hospoutcome ==1)$los))


```

Median hospital stay was 4 (IQR 1-9) days. Mortality of the cohort was 18% (95% CI 13-23%) at 28 days, 24% (95% CI 18-30%) at 90 days and 31% (95% CI 25-38) at 180 days, and higher in HIV-infected participants at each time point (Table \@ref(tab:outcome-table)), though not statistically significant on pairwise Fisher's exact test (HIV-infected vs noninfected 19% vs 13%, [p = 0.14] at 28 days, 27% vs 17%, [p = 0.44] at 90 days and 36% vs 21% [p = 0.29] at 180 days). Kaplan-meier estimation of the survival function (Figure \@ref(fig:outcome-km-plots)) showed a precipitous decline in survivorship to around day 30 but also continuous mortality therafter, to the end of the study period. Stratifying the analysis by HIV status revealed that early deaths (within the first 1-2 weeks) occur at similar rates in the two groups before the curves diverge; log-rank test suggested a significant difference in survival function between the two groups (p = 0.03).

Health related quality of life measures, as assessed by EQ-5D-3L, are shown in Figure \@ref(fig:outcome-morbidity) for participants with sepsis and the community cohort as a comparator. Acutely, participants with sepsis reported were significantly disabled, reporting at least moderate impairment across all domains in the majority of cases, and over 90% of participants reporting at least moderate impairment in activities of daily living and experienceing at least moderate pain or discomfort. However, recovery following treatment in survivors was rapid. The mean EQ-5Q utility score (a measure of the weight compared to a health state compared to 1, perfect health) of healthy community controls was 0.910 (SD 0.102) at enrollment, significantly higher than participants with sepsis at enrollment (utility score 0.496 (SD 0.251), p = < 0.0001 versus community scores by t-test), but comparable to participants with sepsis at their 12 week assessment (0.913 (SD 0.147), p = 0.903 versus community enrollment scores).


```{r outcome-table, echo =F, warning=F, message=F}

v1 <- visits %>% filter(arm == 1) 

v1$t <- apply(v1[7:10], 1,max, na.rm= T )

v1$t[!is.na(v1$died_date)] <- v1$died_date[!is.na(v1$died_date)]

#v1$t <- v1$t * 7
v1$died <- v1$status
v1$died[v1$died == 2] <- 0

v1 <- select(v1, pid, enrolled, arm, t, died)

#v1$d28_death

v1$d28_death <- NA

v1$d28_death[(v1$t <= 28) & (v1$died == 1)] <- 1
v1$d28_death[(v1$t >= 28)] <- 0

v1$d90_death[(v1$t <= 90) & (v1$died == 1)] <- 1
v1$d90_death[(v1$t >= 90)] <- 0

v1$d180_death[(v1$t <= 180) & (v1$died == 1)] <- 1
v1$d180_death[(v1$t >= 180)] <- 0

merge(v1, select(enroll, pid, hivstatus)) -> v1

v1$died <- as.numeric(v1$died)


merge(
v1 %>% 
  dplyr::select(pid, hivstatus, d28_death, d90_death, d180_death) %>% 
  pivot_longer(-c(pid, hivstatus)) %>% group_by(name, hivstatus) %>%
  summarise(n = sum(!is.na(value)), mort =  prop_confint_str(value)) %>%
  pivot_wider(id_cols = c(name), names_from = hivstatus, values_from = c(n,mort)),

v1 %>% 
    dplyr::select(pid, hivstatus, d28_death, d90_death, d180_death) %>% 
    pivot_longer(-c(pid, hivstatus)) %>% group_by(name) %>%
    summarise(n = sum(!is.na(value)), mort =  prop_confint_str(value)),
by = "name") -> mort

mort[,c(1,3,6,2,5,4,7, 8, 9)] -> mort
mort[c(2,3,1),] -> mort
mort$name <- c("Day 28", "Day 90", "Day 180")

#(gsub("%", "\\\\%", mort[c(3,5,7,9)])) -> mort[c(3,5,7,9)]

kable(mort, "latex", booktabs =T,  row.names = F, longtable = F,escape = TRUE,
      caption = "Day 28, 90 and 180 mortality stratified by HIV status",
      col.names = c(" ", "n", "Mortality" , "n", "Mortality", "n", "Mortality","n", "Mortality" )) %>%
        add_header_above(c(" " = 1, "HIV+" = 2, "HIV-" = 2, "HIV Unknown" = 2, "Total" = 2)) %>%
  kable_styling( full_width = F) %>%
    column_spec(8, bold = T) %>% 
  column_spec(9, bold = T)

# calc p values

v1 %>% dplyr::select(pid, hivstatus, d28_death, d90_death, d180_death) %>% 
  pivot_longer(-c(pid, hivstatus)) %>% group_by(name, hivstatus) %>%
  summarise(n = (sum(!is.na(value))), dead = sum(sum(value == 1, na.rm = T))) ->ft

#fisher.test(ft[1:2,3:4])
```

```{r outcome-km-plots, echo =F, warning=F, message=F,fig.scap="Kaplan-Meier survival curves.", out.extra='', fig.cap="Kaplan-Meier survival curves of all included participants (A) and stratified by HIV status (B). Crosses indicate censoring. p value from log-rank test comparing survival of HIV-infected to HIV-noninfected participants shown (p = 0.03).", fig.width= 8, fig.height =4, }

psurv1 <- ggsurvplot(survfit(Surv(t,died) ~ 1, data = v1), conf.int = T, xlim = c(0, 190), ylim = (c(0.6,1)), ggtheme = theme_bw(), palette = "black", size = 0.5,legend = "none", break.time.by = 30)

psurv1 <- psurv1$plot

psurv2 <- ggsurvplot(survfit(Surv(t,died) ~ hivstatus, data = subset(v1, hivstatus != "Unknown")), conf.int = T, xlim = c(0, 190), ylim = (c(0.6,1)), ggtheme = theme_bw(), size = 0.5, break.time.by = 30, pval = TRUE, pval.coord = c(15,0.65), pval.size = 4)

psurv2 <- psurv2$plot

psurv2 + theme(legend.position = "right", legend.title = element_blank()) + scale_fill_manual(labels = c("HIV-", "HIV+"), values = pal_lancet()(2)[c(1,2)]) + scale_color_manual(labels = c("HIV-", "HIV+"), values = pal_lancet()(2)[c(1,2)]) -> psurv2

ggarrange(psurv1, psurv2, labels = c("A", "B"), widths = c(0.8,1))
```


```{r outcome-morbidity, echo =F, warning=F, message=F,fig.scap="Health-related QoL following admission with sepsis.", out.extra='', fig.cap="Health-related quality of life following sepsis admission, compared to community controls, showing a return to usual quality of life by 12 weeks following admission. A: proportion of participants across each of the five domains of the EQ-5D questionnaire who report at least moderate impariment. B: EQ-5D utility score derived using the Zimbabwean tariff set. The utility score is interpreted as the weight attached to a health state compared to perfect health, which is assigned a value of 1. By 12 weeks there is no statistically significant difference between sepsis and baseline community participant utility scores (p = 0.90 by t-test).", fig.width= 9, fig.height =5, }

eq <- read.csv("/Users/joelewis/Documents/PhD/Data/Current/portal_downloads/dassim_eq05_raw.csv", stringsAsFactors = F)



eq$assess_date2 <- parse_date(eq$assess_date, "%d-%b-%Y")

eq <- select(eq, -data_date)
names(eq)[names(eq) == "assess_date"] <- "data_date"


merge(eq, select(followup, pid, data_date, d2visit ), by = c("pid", "assess_date2"), by.y = c("pid", "data_date"), all.x = T) -> eq

eq$d2visit <- eq$d2visit + 1

eq$visit_type[is.na(eq$visit_type)] <- eq$d2visit[is.na(eq$visit_type)]

eq <- merge(eq, select(enroll,pid, arm, hivstatus), all.x = T)



eq %>% select(arm, visit_type, walk, self, usual, pain, anxiety) %>% 
  pivot_longer(-c(arm, visit_type)) %>% filter(!is.na(arm) & !is.na(value) & !is.na(visit_type)) %>% 
  group_by(arm, visit_type, name) %>% summarise(x = sum(value >= 2), 
                                                n = n(), 
                                                prop = x / n,
                                                lci = binom.test(x,n)$conf.int[[1]],
                                                uci = binom.test(x,n)$conf.int[[2]]) -> eq.1

eq.1$name[eq.1$name == "anxiety"] <- "Anxiety"
eq.1$name[eq.1$name == "pain"] <- "Pain"
eq.1$name[eq.1$name == "self"] <- "Self Care"
eq.1$name[eq.1$name == "usual"] <- "Usual Activities"
eq.1$name[eq.1$name == "walk"] <- "Walking"

eq.1$visit_type[eq.1$visit_type == 1] <- 0
eq.1$visit_type[eq.1$visit_type == 2] <- 1
eq.1$visit_type[eq.1$visit_type == 4] <- 12
eq.1$visit_type[eq.1$visit_type == 3] <- 4

eq.1$visit_type[eq.1$visit_type == 5] <- 24

eq.1 <- subset(eq.1, arm %in% c(1,3))
eq.1$arm[eq.1$arm == 1] <- "Sepsis"
eq.1$arm[eq.1$arm == 3] <- "Community"
eq.1$arm <- factor(eq.1$arm, levels = c("Sepsis", "Community"))

ggplot(eq.1, aes(visit_type,prop, color = arm, group = arm) ) + 
  geom_point( aes(shape = arm)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci, ymax = uci, fill = arm), color = NA, alpha = 0.3) +
  geom_point( aes(shape = arm), data = subset(eq.1, arm == "Sepsis")) + 
  geom_line(data = subset(eq.1, arm == "Sepsis")) +
  facet_wrap(~name, nrow = 1) + 
  theme_bw() + labs(x = "Week post enrollment", y = "Proportion") +
  theme(legend.title = element_blank())  -> p1 #+
 # scale_color_manual(values = c("black", "darkgrey")) 

eq$arm[eq$arm == 1] <- "Sepsis"
eq$arm[eq$arm == 3] <- "Community"

eq$visit_type[eq$visit_type == 1] <- 0
eq$visit_type[eq$visit_type == 2] <- 1
eq$visit_type[eq$visit_type == 4] <- 12
eq$visit_type[eq$visit_type == 3] <- 4

eq$visit_type[eq$visit_type == 5] <- 24

eq$arm <- factor(eq$arm, levels = c("Sepsis", "Community", 2, 4))

  names(eq)[names(eq) == "walk"] <- "MO"
  names(eq)[names(eq) == "self"] <- "SC"
  names(eq)[names(eq) == "usual"] <- "UA"
  names(eq)[names(eq) == "pain"] <- "PD"
  names(eq)[names(eq) == "anxiety"] <- "AD"
  
  eq$utility_score <- NA
  eq$utility_score[complete.cases(eq[8:12])] <-  eq5d(eq[8:12][complete.cases(eq[8:12]),],version = "3L", type = "TTO", country = "Zimbabwe") 
  
  ggplot(subset(eq, arm != 2 & arm != 4 & !is.na(visit_type) ), 
         aes(as.factor(visit_type), utility_score, fill = arm, color = arm)) +
geom_boxplot(outlier.size = 0.5, alpha = 0.3, width = 0.5, position = position_dodge2(preserve = "single"), outlier.alpha = 1) +
theme_bw() +
#geom_hline(linetype = "dashed", yintercept = median(subset(eq, arm == 3)$vas_score )) +
    theme(legend.title = element_blank()) +
    labs(y = "Utility score", x= "Week post enrollment") -> p2

  ggarrange(p1, ggarrange(NULL,p2,NULL, ncol = 3, nrow = 1,
                          widths = c(0.15,1,0.15), labels = c(NA, "B", NA)),
            ncol = 1, nrow = 2, labels = c("A", NA))


```

#### Associations of mortality

Univariate associations of host and severity variables

Univariate association of 

```{r causal-structure, echo = F, fig.scap="Hypothesised causal structre of mortality in sepsis", out.extra='', fig.cap="Hypothesised causal structre of death in sepsis. Host factors (e.g. age, sex, immune status) influence the type of infection; disseminated TB is more common in HIV, for example. Severity  (variables quantifying e.g. shock or respiratory failure) is influenced by infection type and host factors. Therapy encodes which antimicrobials were administered and rapidity of administration of antimicrobials, and is influenced by disease severity (sicker patients may be given different therapies), host factors (HIV status may influence treatment) and the infection type (for example, malaria rapid diagnostic tests influenceing rapidity of malaria treatment). Dotted edges from host and infection to outcome are because it is not clear \textit{a priori} whether the effect of infection and host factors are entirely mediated by disease severity: in fact, even if this were the case in a theoretical sense, the available severity variables are unlikley to completely account for the causative effect of infection type on mortality and so conditioning on all available severity variables is likely to leave some residual causative effect of infection type. See text for further discussion",  out.height = '50%', fig.align = 'center'}

knitr::include_graphics(paste0(wd, "figures/causal_dag_mortality.pdf"))

```

```{r bivariate-sev-mort-assoc, echo =F, warning=F, message=F}

df.temp <- dplyr::select(df, d28_death, hivstatus,calc_age,ptsex,screentemp, t0sbp, t0dbp, t0map, t0hr, t0rr, t0spo2, gcs, lactate_value,
                         WCC, CD4_Absolute, Haemoglobin, Platelets, NA.,Potassium, Urea, Creatinine, CO2, Chloride
) 

df.temp[df.temp == 999] <- NA

df.temp$CD4_Absolute[df.temp$hivstatus != "Reactive"] <- NA
df.temp$hivstatus[df.temp$hivstatus == "Reactive"] <- 1
df.temp$hivstatus[df.temp$hivstatus == "Non reactive"] <- 0
df.temp$hivstatus[df.temp$hivstatus == "Unknown"] <- NA

df.temp$ptsex[df.temp$ptsex == "Male"] <- 1
df.temp$ptsex[df.temp$ptsex == "Female"] <- 0


df.temp %>% select(-c(hivstatus, ptsex)) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name) %>% dplyr::summarise(pval = kruskal.test(value ~ d28_death)$p.value) -> pvals

df.temp %>% select(-c(hivstatus, ptsex)) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, d28_death) %>% dplyr::summarise( median = median(value, na.rm = T),
                                                             LQ = quantile(value, 0.25, na.rm = T),
                                                              UQ = quantile(value, 0.75, na.rm = T)) -> p



paste0(
  specify_decimal(p$median, 1), " (",
  specify_decimal(p$LQ, 1), "-",
  specify_decimal(p$UQ, 1) ,")"
) -> p$med_str

p %>% select(name, d28_death, med_str) %>% pivot_wider(names_from = d28_death, values_from = med_str) -> p

p <- merge(p, pvals)


df.temp %>% select(d28_death, hivstatus, ptsex) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, value) %>%
  dplyr::summarise(died = sum(d28_death == 1, na.rm = T), alive = sum(d28_death == 0, na.rm = T)) %>% filter(!is.na(value)) %>% group_by(name) %>%
   group_by(name) %>% dplyr::summarise(pval = fisher.test(matrix(c(died, alive), ncol =2))$p.value) -> p.catpvals

df.temp %>% select(d28_death, hivstatus, ptsex) %>% pivot_longer(-d28_death) %>% filter(!is.na(d28_death)) %>%
  dplyr::group_by(name, d28_death) %>% dplyr::summarise(`1` = sum(value == 1, na.rm = T), 
                                                        total = sum(!is.na(value)),
                                                        prop = `1`/total) -> p.cat

p.cat$str <- paste0(
  p.cat$`1`, "/", p.cat$total,
  " (", signif(p.cat$prop *100,2), "%)"
)


p.cat %>% select(name, d28_death, str) %>% pivot_wider(names_from = d28_death, values_from = str) -> p.cat
p.cat <- merge(p.cat, p.catpvals)



p <- bind_rows(p,p.cat)

p$boldcol <- FALSE 
p$boldcol[p$pval <= 0.05] <- TRUE

p$pval <- specify_decimal(p$pval, 3)
p$pval[p$pval == "0.000"] <- "<0.001"


p[match(c("calc_age", "ptsex", "hivstatus", "CD4_Absolute", "Haemoglobin","screentemp", "t0hr", "t0sbp", "t0dbp", "t0map",
        "t0rr", "t0spo2","gcs", "lactate_value" , "WCC", "Platelets", "NA.", "Potassium",
        "Chloride", "CO2", "Urea", "Creatinine"), p$name),] -> p

p <- p[c("name", "1", "0", "pval", "boldcol")]
names(p) <- c("Variable", "Died", "Survived", "p", "boldcol")

boldrows <- which(p$boldcol %in% TRUE)

p$Variable[p$Variable == "calc_age"] <- "Age (years)"
p$Variable[p$Variable == "ptsex"] <- "Male sex"
p$Variable[p$Variable == "hivstatus"] <- "HIV Infected\\textsuperscript{*}"
p$Variable[p$Variable == "Haemoglobin"] <- "Haemoglobin (x10\\textsuperscript{9} g dL\\textsuperscript{-1})"
p$Variable[p$Variable == "CD4_Absolute"] <- "CD4 count\\textsuperscript{\\dag} ($\\mu$L\\textsuperscript{-1})"
p$Variable[p$Variable == "screentemp"] <- "Temperature (\\textdegree C)"
p$Variable[p$Variable == "t0hr"] <- "Heart rate (min\\textsuperscript{-1}))"
p$Variable[p$Variable == "t0sbp"] <- "Systolic BP (mmHg)"
p$Variable[p$Variable == "t0dbp"] <- "Diastolic BP (mmHg)"
p$Variable[p$Variable == "t0map"] <- "Mean arterial BP (mmHg)"
p$Variable[p$Variable == "t0rr"] <- "Respiratory rate (min\\textsuperscript{-1}))"
p$Variable[p$Variable == "t0spo2"] <- "Oxygen saturation (%)"
p$Variable[p$Variable == "gcs"] <- "GCS"
p$Variable[p$Variable == "lactate_value"] <- "Lactate (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "WCC"] <- "White cell count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p$Variable[p$Variable == "Platelets"] <- "Platelet count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p$Variable[p$Variable == "NA."] <- "Sodium (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Potassium"] <- "Potassium (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "CO2"] <- "Bicarbonate (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Urea"] <- "Urea (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Creatinine"] <- "Creatinine (mmol L\\textsuperscript{-1})"

sub("%", "\\\\%", p$Died) -> p$Died
sub("%", "\\\\%", p$Survived) -> p$Survived
sub("%", "\\\\%", p$Variable) -> p$Variable

kable(select(p,-boldcol), "latex", booktabs =T, 
      row.names = F, longtable = F, ,escape = F,caption = "Bivariate associations with death by 28 days" ) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header")) %>%
  row_spec(boldrows, bold = T) %>%
  pack_rows("Host Variables", 1,5, bold = F) %>% 
   pack_rows("Severity Variables", 6, 22, bold = F)  %>%
  footnote(general = "BP = Blood pressure, GCS = Glasgow coma scale. Numeric variables are presented as median (IQR) and categoric variables as proportions. P-values are from Kruskal-Wallace test for continuous variables and Fisher's exact test for categorical variables. PAtients with meningitis not shown in this table due to small numbers (n = 4)." , symbol = c("Participants with HIV status unknown not included in this row","CD4 count only measured for HIV-infected participants"), threeparttable = T, fixed_small_size = T)




```

```{r bivariate-diag-sev, echo =F, warning=F, message=F}
# severity by diagnosis

df.temp2 <- dplyr::select(df, d28_death, hivstatus,calc_age,ptsex,screentemp, t0sbp, t0dbp, t0map, t0hr, t0rr, t0spo2, gcs, lactate_value,
                         WCC, CD4_Absolute, Haemoglobin, Platelets, NA.,Potassium, Urea, Creatinine, CO2, Chloride, tb, malaria, bc, csf
) 
apply(df.temp2[24:26], 1, sum) -> df.temp2$n_diagnoses

#df.temp2$CD4_Absolute[df.temp2$hivstatus != "Reactive"] <- NA

df.temp2 <- subset(df.temp2, n_diagnoses < 2)

df.temp2$no_diagnosis <- as.numeric(df.temp2$n_diagnoses == 0)

df.temp2$diagnosis <- factor(apply(df.temp2[c(24,25,26,29)], 1, function(x) which(x == 1)), 
       labels = colnames(df.temp2[c(24,25,26,29)])) 

df.temp2[df.temp2 == 999] <- NA
df.temp2$CD4_Absolute[df.temp2$hivstatus != "Reactive"] <- NA

df.temp2$CD4_Absolute[df.temp2$hivstatus != "Reactive"] <- NA
df.temp2$hivstatus[df.temp2$hivstatus == "Reactive"] <- 1
df.temp2$hivstatus[df.temp2$hivstatus == "Non reactive"] <- 0
df.temp2$hivstatus[df.temp2$hivstatus == "Unknown"] <- NA

df.temp2$ptsex[df.temp2$ptsex == "Male"] <- 1
df.temp2$ptsex[df.temp2$ptsex == "Female"] <- 0

df.temp2 %>% select(-c(hivstatus, ptsex, d28_death, tb, malaria, bc, csf, n_diagnoses, no_diagnosis)) %>% pivot_longer(-diagnosis) %>% filter(!is.na(diagnosis)) %>%
  dplyr::group_by(name) %>% dplyr::summarise(pval = kruskal.test(value ~ diagnosis)$p.value) -> pvals

df.temp2 %>% select(-c(hivstatus, ptsex, d28_death, tb, malaria, bc, csf, n_diagnoses, no_diagnosis)) %>% pivot_longer(-diagnosis) %>% filter(!is.na(diagnosis)) %>%
  dplyr::group_by(name, diagnosis) %>% dplyr::summarise( median = median(value, na.rm = T),
                                                         LQ = quantile(value, 0.25, na.rm = T),
                                                         UQ = quantile(value, 0.75, na.rm = T)) -> p

paste0(
  specify_decimal(p$median, 1), " (",
  specify_decimal(p$LQ, 1), "-",
  specify_decimal(p$UQ, 1) ,")"
) -> p$med_str

p %>% select(name, diagnosis, med_str) %>% pivot_wider(names_from = diagnosis, values_from = med_str) -> p

p <- merge(p, pvals)


df.temp2 %>% select(diagnosis, hivstatus, ptsex) %>% pivot_longer(-diagnosis) %>% 
  dplyr::group_by(name, diagnosis) %>% dplyr::summarise(`1` = sum(value == 1, na.rm = T), 
                                                        `0` = sum(value == 0, na.rm = T),
                                                        total = sum(!is.na(value)),
                                                        prop = `1`/total) %>% 
  group_by(name) %>% 
  dplyr::mutate(pval = fisher.test(matrix(c(`1`,`0`), ncol =2))$p.value) -> p.cat



p.cat$str <- paste0(
  p.cat$`1`, "/", p.cat$total,
  " (", signif(p.cat$prop *100,2), "%)"
)


p.cat %>% select(name, diagnosis, str, pval) %>% pivot_wider(names_from = diagnosis, values_from = str) -> p.cat
#p.cat <- merge(p.cat, p.catpvals)

bind_rows(p,p.cat) -> p


p$boldcol <- FALSE 
p$boldcol[p$pval <= 0.05] <- TRUE

p$pval <- specify_decimal(p$pval, 3)
p$pval[p$pval == "0.000"] <- "<0.001"

df.temp2 %>% select(diagnosis) %>% group_by(diagnosis) %>% tally() %>% 
  pivot_wider(names_from = diagnosis, values_from = n) -> n_d

n_d$name <- "n"
n_d$pval <- "-"

sapply(n_d, as.character) -> n_d
n_d$boldcol <- FALSE
bind_rows(p, n_d) -> p
p[match(c("n","calc_age", "ptsex", "hivstatus", "CD4_Absolute", "Haemoglobin","screentemp", "t0hr", "t0sbp", "t0dbp", "t0map",
        "t0rr", "t0spo2","gcs", "lactate_value" , "WCC", "Platelets", "NA.", "Potassium",
        "Chloride", "CO2", "Urea", "Creatinine"), p$name),] -> p

p <- p[c("name", "tb", "malaria","bc", "no_diagnosis", "pval", "boldcol")]
names(p) <- c("Variable", "TB", "Malaria","BSI","No Diagnosis", "p", "boldcol")

boldrows <- which(p$boldcol %in% TRUE)



p$Variable[p$Variable == "calc_age"] <- "Age (years)"
p$Variable[p$Variable == "ptsex"] <- "Male sex"
p$Variable[p$Variable == "hivstatus"] <- "HIV Infected\\textsuperscript{*}"
p$Variable[p$Variable == "Haemoglobin"] <- "Haemoglobin (x10\\textsuperscript{9} g dL\\textsuperscript{-1})"
p$Variable[p$Variable == "CD4_Absolute"] <- "CD4 count\\textsuperscript{\\dag} ($\\mu$L\\textsuperscript{-1})"
p$Variable[p$Variable == "screentemp"] <- "Temperature (\\textdegree C)"
p$Variable[p$Variable == "t0hr"] <- "Heart rate (min\\textsuperscript{-1}))"
p$Variable[p$Variable == "t0sbp"] <- "Systolic BP (mmHg)"
p$Variable[p$Variable == "t0dbp"] <- "Diastolic BP (mmHg)"
p$Variable[p$Variable == "t0map"] <- "Mean arterial BP (mmHg)"
p$Variable[p$Variable == "t0rr"] <- "Respiratory rate (min\\textsuperscript{-1}))"
p$Variable[p$Variable == "t0spo2"] <- "Oxygen saturation (%)"
p$Variable[p$Variable == "gcs"] <- "GCS"
p$Variable[p$Variable == "lactate_value"] <- "Lactate (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "WCC"] <- "White cell count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p$Variable[p$Variable == "Platelets"] <- "Platelet count (x10\\textsuperscript{9} L\\textsuperscript{-1})"
p$Variable[p$Variable == "NA."] <- "Sodium (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Potassium"] <- "Potassium (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Chloride"] <- "Chloride (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "CO2"] <- "Bicarbonate (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Urea"] <- "Urea (mmol L\\textsuperscript{-1})"
p$Variable[p$Variable == "Creatinine"] <- "Creatinine (mmol L\\textsuperscript{-1})"

sub("%", "\\\\%", p$TB) -> p$TB
sub("%", "\\\\%", p$Malaria) -> p$Malaria
sub("%", "\\\\%", p$BSI) -> p$BSI
sub("%", "\\\\%", p$`No Diagnosis`) -> p$`No Diagnosis`

sub("%", "\\\\%", p$Variable) -> p$Variable




kable(select(p,-boldcol), "latex", booktabs =T, 
      row.names = F, longtable = F, ,escape = F,caption = "Bivariate associations of diagnosis with host and severty variables" ) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header", "scale_down")) %>%
  row_spec(boldrows, bold = T) %>%
  pack_rows("Host Variables", 2,6, bold = F) %>% 
   pack_rows("Severity Variables", 7, 23, bold = F)  %>%
  footnote(general = "BP = Blood pressure, GCS = Glasgow coma scale. Numeric variables are presented as median (IQR) and categoric variables as proportions. P-values are from Kruskal-Wallace test for continuous variables and Fisher's exact test for categorical variables across four diganositic groups" , symbol = c("Participants with HIV status unknown not included in this row","CD4 count only measured for HIV-infected participants"), threeparttable = T, fixed_small_size = T) %>% add_indent(1) %>%
  landscape()

```


```{r bivariate-rx-mort, echo =F, warning=F, message=F}

df.temp <- select(df, d28_death, first_ab, time_to_abx, any_tb_rx, time_to_tb_rx, first_mal_rx, time_to_mal_rx, first_fung_rx, time_to_fung_rx)

df.temp$any_ab <- as.character(df.temp$first_ab != "none")
df.temp$any_mal_rx <- as.character(!is.na(df.temp$first_mal_rx))
df.temp$any_fung_rx <- as.character(!is.na(df.temp$first_fung_rx))

df.temp$any_tb_rx[df.temp$any_tb_rx == "on admission"] <- "none"
df.temp$any_tb_rx[df.temp$any_tb_rx == "none"] <- "FALSE"
df.temp$any_tb_rx[df.temp$any_tb_rx == "yes"] <- "TRUE"

df.temp %>% 
  select(d28_death, any_ab, any_mal_rx, any_tb_rx, any_fung_rx) %>%
  pivot_longer(-d28_death) %>%
  group_by(name, value) %>%
  summarise(n = sum(!is.na(d28_death)),
                    e = sum(d28_death == 1, na.rm = T),
                    prop = e/n,
                    lci = binom.test(e,n)$conf.int[[1]],
                    uci = binom.test(e,n)$conf.int[[2]],
  ) %>% group_by(name) %>%
  mutate(pval = fisher.test(matrix(c(n,e), ncol = 2))$p.value) -> rx

rx$rx_str <- paste0(
  rx$e, "/", rx$n, " (", 
  specify_decimal(rx$prop *100, 0), "%)") #"% [",
#  specify_decimal(rx$lci *100, 0), "-",
#  specify_decimal(rx$uci *100, 0), "%])"


rx %>% select(name, value, rx_str, pval) %>% pivot_wider(names_from = c(value), values_from = rx_str ) -> rx

rx[,c(1,4,3,2)] -> rx
rx$name <- c("Antibacterial", "Antifungal", "Antimalarial", "Anitmycobacterial")

rx$pval <- specify_decimal(rx$pval, 3)

names(rx) <- c("Class", "Yes", "No", "p")

kable(rx, "latex", booktabs =T, 
      row.names = F, longtable = F, ,escape = T,caption = "Bivariate associations of treatment recieved and death by 28 days") %>% 
  #    col.names = c("Class", "Yes", "No", "p")) %>%
 kable_styling("striped", full_width = F, latex_options = c("repeat_header")) %>%
  footnote(general = "Table includes participants recieved specified treatment post admission only; for example, participants recieveing TB therapy prior to admission are included in the no column. P-values are from Fisher's exact test.", threeparttable = T, fixed_small_size = T) 

```

```{r outcome-by-diag, echo =F, warning=F, message=F,fig.scap="Mortality stratified by diagnosis", out.extra='', fig.cap="Day 28 and 90 mortality stratified by diagnosis.", fig.width= 5, fig.height =3, out.width= '50%' , fig.align = 'center'}

# plot outcomes by diag


df.temp4 <- dplyr::select(df, d28_death, d90_death, d180_death,  t0rr, gcs, t0spo2, lactate_value,
                          Haemoglobin, any_tb_rx, time_to_abx, time_to_tb_rx, malaria, tb, bc
) 


# mortality of different diagnoses

df.temp4[c("malaria", "tb", "bc")][is.na(df.temp4[c("malaria", "tb", "bc")])] <- 0

df.temp4$no_diagnosis <- apply(df.temp4[c("malaria", "tb", "bc")], 1, sum, na.rm = T)

df.temp4$no_diagnosis[df.temp4$no_diagnosis > 1] <- 1

bind_rows(
  df.temp4 %>% dplyr::select(d28_death,malaria, tb, bc, no_diagnosis) %>% 
    pivot_longer(-d28_death) %>% group_by(name) %>% dplyr::summarise(e= sum(value == 1 & d28_death == 1, na.rm = T),
                                                                     n = sum(value == 1 & !is.na(d28_death), na.rm = T), type = "d28"),
  
  df.temp4 %>% dplyr::select(d90_death,malaria, tb, bc, no_diagnosis) %>% 
    pivot_longer(-d90_death) %>% group_by(name) %>% dplyr::summarise(e= sum(value == 1 & d90_death == 1, na.rm = T),
                                                                     n = sum(value == 1 & !is.na(d90_death), na.rm = T), type = "d90"),
  
#  df.temp4 %>% dplyr::select(d180_death,malaria, tb, bc, no_diagnosis) %>% 
#    pivot_longer(-d180_death) %>% group_by(name) %>% dplyr::summarise(e= sum(value == 1 & d180_death == 1, na.rm = T),
#                                                                      n = sum(value == 1 & !is.na(d180_death), na.rm = T), type = "d180")
  
  
  
)  -> d.mort






d.mort$prop <- apply(d.mort[2:3], 1, function(x) binom.test(x[1],x[2])$estimate )
d.mort$lci <- apply(d.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[1]] )
d.mort$uci <- apply(d.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[2]] )

d.mort$name[d.mort$name == "bc"] <- "BSI"
d.mort$name[d.mort$name == "malaria"] <- "Malaria"
d.mort$name[d.mort$name == "tb"] <- "TB"
d.mort$name[d.mort$name == "no_diagnosis"] <- "No Diagnosis"

d.mort$type[d.mort$type == "d28"] <- "Day 28"
d.mort$type[d.mort$type == "d90"] <- "Day 90"

ggplot(d.mort, aes(fct_reorder(name,prop), prop, color = fct_reorder(type, prop))) + coord_flip() + geom_point(position = position_dodge(width = 0.3)) + 
  geom_errorbar(aes(ymin = lci, ymax = uci), width = 0, position = position_dodge(width = 0.3)) + theme_bw()  +
  labs(y = "Mortality", x = "") + theme(legend.title = element_blank())




```

```{r outcome-by-time-to-rx, echo =F, warning=F, message=F,fig.scap="Day 28 mortality stratified by time-to-antimicrobial time afn fluid volume recieved.", out.extra='', fig.cap="Day 28 mortality stratified by time-to-antimicrobial time (A-C) and intravenous fluid volume received over fist 6 hours of hospiytal admission (D). A and B show mortality stratified by time-to-antibacterial with different bin sizes to focus on the first 6hr (A) and afterwards (B). C shows mortality stratified by time to antituberculous therapy. In view of the small number of patients receiving antimalarial or antifungal therapy, this analysis was not repeated for those agents. D shows mortality stratified by the volume of intravenous fluid recieved over the first 6 hours of hospital attendance.", fig.width= 6, fig.height =9, out.height= '70%', fig.align= 'center'}


cut(as.numeric(df$time_to_abx), breaks = c(0,6,24, 10000)) -> df$time_to_abx.cut

bind_rows (
  
df %>% group_by(time_to_abx.cut) %>% dplyr::summarise(e= sum( d90_death == 1, na.rm = T),
                                                            n = sum( !is.na(d90_death), na.rm = T), type = "d90"),

df %>% group_by(time_to_abx.cut) %>% dplyr::summarise(e= sum( d28_death == 1, na.rm = T),
                                                      n = sum( !is.na(d28_death), na.rm = T), type = "d28")
) -> ab.t.mort

ab.t.mort$prop <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$estimate )
ab.t.mort$lci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[1]] )
ab.t.mort$uci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[2]] )

ggplot(subset(ab.t.mort, type == "d28"), aes(time_to_abx.cut, prop)) + geom_point(position = position_dodge(width = 0.4)) + 
  geom_errorbar(aes(ymax = uci, ymin = lci), width = 0, position = position_dodge(width = 0.4)) +
  theme_bw() + scale_x_discrete(breaks = c(levels(df$time_to_abx.cut), NA), labels = c("0-6hr", "6-24hr", "> 24hr", "None")) +
  labs(x = "Time to antibacterials", y = "Mortality") + theme(axis.text.x = element_text(angle = 45, hjust =1))-> p2


cut(as.numeric(df$time_to_abx), breaks = c(0,1,2,3,4,5,6, 10000)) -> df$time_to_abx.cut

bind_rows (
  
df %>% group_by(time_to_abx.cut) %>% dplyr::summarise(e= sum( d90_death == 1, na.rm = T),
                                                            n = sum( !is.na(d90_death), na.rm = T), type = "d90"),

df %>% group_by(time_to_abx.cut) %>% dplyr::summarise(e= sum( d28_death == 1, na.rm = T),
                                                      n = sum( !is.na(d28_death), na.rm = T), type = "d28")
) -> ab.t.mort

ab.t.mort$prop <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$estimate )
ab.t.mort$lci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[1]] )
ab.t.mort$uci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[2]] )

ggplot(subset(ab.t.mort, type == "d28"), aes(time_to_abx.cut, prop)) + geom_point(position = position_dodge(width = 0.4)) + 
  geom_errorbar(aes(ymax = uci, ymin = lci), width = 0, position = position_dodge(width = 0.4)) +
  theme_bw() + scale_x_discrete(breaks = c(levels(df$time_to_abx.cut), NA), 
                                labels = c("0-1hr", "1-2hr","2-3hr","3-4hr", "4-5hr","5-6hr", "> 6hr", "None")) +
  labs(x = "Time to antibacterials", y = "Mortality")  + theme(axis.text.x = element_text(angle = 45, hjust =1))-> p1



## tb rx

cut(as.numeric(df$time_to_tb_rx), breaks = c(0,72,144, 216,10000)) -> df$time_to_tb_rx.cut

bind_rows (
  
  df  %>% group_by(time_to_tb_rx.cut) %>% dplyr::summarise(e= sum( d90_death == 1, na.rm = T),
                                                        n = sum( !is.na(d90_death), na.rm = T), type = "d90"),
  
  df  %>% group_by(time_to_tb_rx.cut) %>% dplyr::summarise(e= sum( d28_death == 1, na.rm = T),
                                                        n = sum( !is.na(d28_death), na.rm = T), type = "d28")
) -> ab.t.mort

#%>% filter(hivstatus == "Reactive")
#%>% filter(hivstatus == "Reactive")

ab.t.mort$prop <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$estimate )
ab.t.mort$lci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[1]] )
ab.t.mort$uci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[2]] )

ggplot(subset(ab.t.mort,type == "d28"), aes(time_to_tb_rx.cut, prop)) + geom_point(position = position_dodge(width = 0.4)) + 
  geom_errorbar(aes(ymax = uci, ymin = lci), width = 0, position = position_dodge(width = 0.4)) +
  theme_bw() + scale_x_discrete(breaks = c(levels(df$time_to_tb_rx.cut), NA), 
                                labels = c("0-72hr", "72-144hr","144-216hr",">216hr", "None")) +
  labs(x = "Time to antimycobacterials", y = "Mortality") + theme(axis.text.x = element_text(angle = 45, hjust =1)) -> p.tb

cut(as.numeric(df$fluid_6hr), breaks = c(-1,0,1000,2000,4000)) -> df$fluid_6hr.cut


bind_rows (
  
  df  %>% group_by(fluid_6hr.cut) %>% dplyr::summarise(e= sum( d90_death == 1, na.rm = T),
                                                        n = sum( !is.na(d90_death), na.rm = T), type = "d90"),
  
  df  %>% group_by(fluid_6hr.cut) %>% dplyr::summarise(e= sum( d28_death == 1, na.rm = T),
                                                        n = sum( !is.na(d28_death), na.rm = T), type = "d28")
) -> ab.t.mort

#%>% filter(hivstatus == "Reactive")
#%>% filter(hivstatus == "Reactive")

ab.t.mort$prop <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$estimate )
ab.t.mort$lci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[1]] )
ab.t.mort$uci <- apply(ab.t.mort[2:3], 1, function(x) binom.test(x[1],x[2])$conf.int[[2]] )

ggplot(subset(ab.t.mort,type == "d28"), aes(fluid_6hr.cut, prop)) + geom_point(position = position_dodge(width = 0.4)) + 
  geom_errorbar(aes(ymax = uci, ymin = lci), width = 0, position = position_dodge(width = 0.4)) +
  theme_bw() + scale_x_discrete(breaks = c(levels(df$fluid_6hr.cut)), 
                                labels = c("None", "0-1L", "1-2L",">2L" )) +
  labs(x = "IV fluid (first 6hr)", y = "Mortality") + theme(axis.text.x = element_text(angle = 45, hjust =1)) -> p.fluid


ggarrange(ggarrange(p1,p2, ncol = 2, labels = c("A", "B")), ggarrange(NULL, p.tb, NULL, ncol =3, widths = c(0.5,1,0.5), labels = c(NA,"C", NA)), 
          ggarrange(NULL, p.fluid, NULL, ncol =3, widths = c(0.5,1,0.5), labels = c(NA,"D", NA)),
          ncol = 1 , nrow = 3)



```

```{r outcome-by-time-to-rx, echo =F, warning=F, message=F,fig.scap="Day 28 mortality stratified by time-to-antimicrobial time afn fluid volume recieved.", out.extra='', fig.cap="Day 28 mortality stratified by time-to-antimicrobial time (A-C) and intravenous fluid volume received over fist 6 hours of hospiytal admission (D). A and B show mortality stratified by time-to-antibacterial with different bin sizes to focus on the first 6hr (A) and afterwards (B). C shows mortality stratified by time to antituberculous therapy. In view of the small number of patients receiving antimalarial or antifungal therapy, this analysis was not repeated for those agents. D shows mortality stratified by the volume of intravenous fluid recieved over the first 6 hours of hospital attendance.", fig.width= 6, fig.height =9, out.height= '70%', fig.align= 'center'}

df.back <- df

df$any_ab <- as.numeric(df$first_ab != "none")
df$any_mal_rx <- as.numeric(!is.na(df$first_mal_rx))
df$any_fung_rx <- as.numeric(!is.na(df$first_fung_rx))

df$any_tb_rx[df$any_tb_rx == "on admission"] <- "none"
df$any_tb_rx[df$any_tb_rx == "none"] <- 0
df$any_tb_rx[df$any_tb_rx == "yes"] <- 1

df$CD4_Absolute[df$hivstatus != "Reactive"] <- NA

df$hivstatus[df$hivstatus == "Unknown"] <- NA
df$hivstatus[df$hivstatus == "Reactive"] <- 1
df$hivstatus[df$hivstatus == "Non reactive"] <- 0

df$hivstatus <- as.numeric(df$hivstatus)

df$CD4.scale <- scale(df$CD4_Absolute)
df$CD4.scale <- log(df$CD4.scale)



glm(d28_death ~ calc_age + ptsex + hivstatus  +  Haemoglobin + screentemp + t0hr + t0map + 
      t0rr + t0spo2 + gcs + lactate_value + WCC + Platelets + NA. + Potassium + Chloride + CO2 + Urea +
      tb + malaria + bc + csf + any_tb_rx + any_fung_rx + any_mal_rx, family = 'binomial', data = df) -> m

df$calc_age <- scale(df$calc_age)

df$Haemoglobin <- scale(df$Haemoglobin)
df$screentemp <- scale(df$screentemp)
df$t0hr <- scale(df$t0hr)
df$t0map <- scale(df$t0map)
df$t0rr <- scale(df$t0rr)
df$t0spo2 <- scale(df$t0spo2)
df$gcs <- scale(df$gcs)
df$lactate_value <- scale(df$lactate_value)
df$WCC <- scale(df$WCC)
df$Platelets <- scale(df$Platelets)
df$NA. <- scale(df$NA.)
df$Potassium <- scale(df$Potassium)
df$CO2 <- scale(df$CO2)
df$Urea <- scale(df$Urea)
df$Creatinine <- scale(df$Creatinine)

df$d28_death <- as.factor(df$d28_death)
df$hivstatus <- as.factor(df$hivstatus)
df$tb <- as.factor(df$tb)
df$malaria <- as.factor(df$malaria)
df$bc <- as.factor(df$bc)
df$any_tb_rx <- as.factor(df$any_tb_rx)
df$any_fung_rx <- as.factor(df$any_fung_rx)
df$any_mal_rx <- as.factor(df$any_mal_rx)
df$any_ab <- as.factor(df$any_ab)

df$hivstatus <- as.character(df$hivstatus)

df$hivstatus[df$hivstatus == "UK"] <- NA

df2 <- dplyr::select(df, d28_death, calc_age ,ptsex , hivstatus ,Haemoglobin, screentemp ,t0map,
       t0spo2, gcs, lactate_value, CO2, Urea, Creatinine,
      tb, bc, malaria,any_tb_rx, any_fung_rx, any_mal_rx, no_diagnosis)

df2.complete <- df2[complete.cases(df2),]

glm(d28_death ~ calc_age + ptsex + hivstatus + Haemoglobin + 
       t0spo2 + gcs + lactate_value +  Urea +  
      tb + bc +  any_tb_rx + any_fung_rx, family = 'binomial', data = df) -> m 

df3 <- dplyr::select(df, d28_death, calc_age ,ptsex , hivstatus ,Haemoglobin, screentemp ,t0map,
       t0spo2, gcs, lactate_value, CO2, Urea, Creatinine,
      tb, bc,csf, malaria,any_tb_rx, any_fung_rx, any_mal_rx, time_to_abx)


df3.complete <- df3[complete.cases(df3),]





    brms::brm(d28_death ~ Haemoglobin +
       t0spo2 + gcs + lactate_value +  Urea + 
      tb + malaria + bc + csf + time_to_abx + any_tb_rx + any_fung_rx + any_mal_rx, data = df3.complete, family = "bernoulli", prior = m1priors) -> m.brms3
  
df2.complete %>% add_fitted_draws(m.brms, scale = "linear") %>% ungroup() %>% dplyr::select( -c(d28_death, ptsex, hivstatus, tb, bc, malaria, any_tb_rx, any_fung_rx, any_mal_rx)) %>% pivot_longer(-c(.row, .chain,.iteration, .draw, .value)) %>% ggplot(aes(x= value, y = .value)) + stat_pointinterval() + geom_smooth() + geom_smooth(method = 'lm', linetype = "dashed", color = "red") + facet_wrap(~name, scales = "free")

## make partial residual
extract_draws(m.brms) -> b
Y <- b$data
draws <- as.data.frame(b$dpars$mu$fe$b) 
 draws$.draw <- 1:nrow(draws)
df.data <- as.data.frame(b$dpars$mu$fe$X)
df.data <- bind_cols(df.data, Y)
df.data$.row <- 1:nrow(df.data)
  
dfout <- bind_cols(

  df.data %>% slice(rep(1:n(), each = nrow(draws))),
draws %>% slice(rep(row_number(), nrow(df.data)))
)

# apply(dfout, 1, function(x) x[22] + sum(x[2:19] * x[23:40])) -> dfout$linear_pred
#as.data.frame(t(apply(dfout[1:10,], 1, function(x) x[2:19] * x[23:40])))
 
betas <- dfout[,2:19] * dfout[,23:40]
names(betas) <- paste0("x_beta_", names(betas)) 
dfout <- bind_cols(dfout, betas)

dfout$linear_pred <- apply(dfout,1, function(x) x[22] + sum( x[42: ncol(dfout)]))

dfout$p <- plogis(dfout$linear_pred)
dfout$resid <- (dfout$Y - dfout$p) / (dfout$p*(1- dfout$p))

dfout[,42:59] <- dfout[,42:59] + dfout$resid

dfout %>% dplyr::select(.row,t0spo2,x_beta_t0spo2) %>%  group_by(.row) %>%
  summarise(spo2 = median(t0spo2), 
            med.par.resid = median(x_beta_t0spo2),
            lci = quantile(x_beta_t0spo2, 0.025),
            uci = quantile(x_beta_t0spo2, 0.975)) -> spo2plot

#dfout[1:10,42:ncol(dfout)] - dfout$linear_pred[1:10]

df2.complete %>% add_fitted_draws(m.brms, scale = "linear") %>% ggplot(aes(x= t0spo2, y = .value)) + stat_pointinterval() + geom_smooth() + geom_smooth(method = 'lm', linetype = "dashed")

df2.complete

```
